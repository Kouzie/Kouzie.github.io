---
title:  "JSP/Servlet - 게시판 - 게시판 기능!"

read_time: false
share: false
author_profile: false
classes: wide

categories:
  - JSP

tags:
  - JSP
  - servelt

toc: true

---

## 게시판 기능

전편에서 회원 관련 기능(로그인, 로그아웃, 비밀번호 변경)을 구현하였고  

이번엔 게시판 관련 기능(게시판 목록보기, 게시글 쓰기, 게시글 보기, 게시글 수정, 게시글 삭제) 를 구현해보자.  

지금까지 게시판 구현은 2번이나 하였다.  

> https://kouzie.github.io/jsp/JSP-게시판/#

> https://kouzie.github.io/jdbc/JDBC.-4일차/#

기존에 있던 소스를 사용해서 게시글 목록보기를 구현해보자.  


### 게시글 DB 생성

먼저 게시글 DB를 생성해야 한다.  

```sql
CREATE SEQUENCE seq_article21;
    
CREATE TABLE article21 (
    article_no NUMBER PRIMARY KEY, 
    writer_id VARCHAR(50) NOT NULL,
    writer_name VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    content CLOB,
    regdate DATE DEFAULT SYSDATE,
    moddate DATE DEFAULT SYSDATE,
    read_cnt NUMBER DEFAULT 0
);
```

## 게시글 목록 보기

게시글 목록 보기도 `.../article/list.do` url을 요청하면 아래 그림처럼 `handler`를 통해 `Article`객체가 들어간 `ArrayList`와 페이징 처리를 위해 사용했던 `PageBlock`객체가 포함된 `ArticlePage`를 반환한다.  

![image43]({{ "/assets/jsp/image43.png" | absolute_url }}){: .shadow}     

`commandHandler.properties`파일에 핸드러 추가

`/article/list.do=board21.article.command.ListArticleHandler`

게시글 관련 url패턴은 모두 앞에 `/article/`을 붙일 것이다.  

### ArticleDao - 게시글 SELECT 쿼리를 갖고있는 객체


먼저 sql문을 가지고 있는 `ArticleDao`를 정의하자.  

> https://kouzie.github.io/jsp/JSP-게시판/#게시글-검색하기  

위 주소에서 사용했던 **페이징 처리 기법**과 게시글 검색 `SELECT` 쿼리 그대로 사용해서 구현할 것이다.  

사용자가 입력한 검색조건, 검색문자열, 페이지 위치를 파라미터로 가져올 것이기 때문에 매개변수로 `Connection`객체와 `request`를 받는다.

```java
public class ArticleDao {

	public ArrayList<Article> getArticleList(Connection conn, HttpServletRequest request) throws SQLException
	{
		System.out.println("ListArticleService process");
		String curPage_param = request.getParameter("currentPage");
		String searchCondition = request.getParameter("searchCondition");
		String searchWord = request.getParameter("searchWord");

		if(searchCondition == null || searchCondition.isEmpty())
			searchCondition = "1";
		if(searchWord == null || searchWord.isEmpty())
			searchWord = "*";
		int curPage;
		if(curPage_param == null || curPage_param.isEmpty())
			curPage = 1;
		else
			curPage = Integer.parseInt(curPage_param);

		int pageSize = 15; //뿌릴 게시글 개수
		int start = (curPage - 1)* pageSize + 1 ;
		int end = curPage * pageSize;

		StringBuffer sql = new StringBuffer();
		sql.append(" WITH temp AS( ");
		sql.append(" SELECT ROWNUM AS no, temp.* ");
		sql.append(" FROM ");
		sql.append(" ( ");
		sql.append("    SELECT article_no, writer_name, title, content, regdate, read_cnt ");
		sql.append("    FROM article21 ");
		System.out.printf("searchCondition: %s\n", searchCondition);
		switch (Integer.parseInt(searchCondition)) {
		case 1: //제목
			sql.append("    WHERE REGEXP_LIKE(title, ?, 'i') ");
			break;
		case 2: //내용
			sql.append("    WHERE REGEXP_LIKE(content, ?, 'i') ");
			break;
		case 3: //글쓴이
			sql.append("    WHERE REGEXP_LIKE(writer_name, ?, 'i') ");
			break;
		case 4: //제목+내용
			sql.append("    WHERE REGEXP_LIKE(title, ?, 'i') OR REGEXP_LIKE(content, ?, 'i') ");
			break;

		default:
			break;
		}
		sql.append("    ORDER BY article_no desc ");
		sql.append("    )temp ");
		sql.append(" ) ");
		sql.append(" SELECT temp.* FROM temp ");
		sql.append(" WHERE temp.no BETWEEN ? AND ? ");

		PreparedStatement pstmt = null;
		ResultSet rs = null;
		ArrayList<Article> article_list = null;
		try {
			pstmt = conn.prepareStatement(sql.toString());
			pstmt.setString(1,  searchWord);
			if(Integer.parseInt(searchCondition) == 4)
			{
				pstmt.setString(2,  searchWord);
				pstmt.setInt(3,  start);
				pstmt.setInt(4,  end);
			}
			else
			{
				pstmt.setInt(2,  start);
				pstmt.setInt(3,  end);
			}
			rs = pstmt.executeQuery();
			if(rs.next())
			{
				Article adto = null;
				article_list = new ArrayList<>();
				do {
					adto = new Article(
							rs.getInt("article_no"),
							new Writer("#", rs.getString("writer_name")),
							"title",
							"content",
							rs.getDate("regdate"),
							null,
							rs.getInt("read_cnt")
							);
					String title = rs.getString("title");
					if(!searchWord.equals("*"))
						title = title.replaceAll("(?i)"+searchWord, "<span class='searchWord'>"+searchWord+"</span>");
					adto.setTitle(title);
					article_list.add(adto);
				} while (rs.next());
			}
		} 
		finally {
			JdbcUtil.close(rs);
			JdbcUtil.close(pstmt);
		}
		return article_list;
	}
  ...
```
<br><br>

`PageBlock`객체를 반환하는 `getPageBlock()`메서드 역시 페이징 처리를 하려면 검색조건, 검색명, 몇페이지인지 알아야 한다.  

따라서 `Connection`객체와 `request`객체를 매개변수로 받는다.  

```java
	...
	public PageBlock getPageBlock(Connection conn, HttpServletRequest request) throws SQLException, NamingException
	{
		
		int pageSize = 15; //뿌릴 게시글 개수
		int numberOfBlock = 10; //페이지 블록 10page 생성
		
		String curPage_param = request.getParameter("currentPage");
		String searchCondition = request.getParameter("searchCondition");
		String searchWord = request.getParameter("searchWord");

		if(searchCondition == null || searchCondition.isEmpty())
			searchCondition = "1";
		if(searchWord == null || searchWord.isEmpty())
			searchWord = "*";
		int curPage;
		if(curPage_param == null || curPage_param.isEmpty())
			curPage = 1;
		else
			curPage = Integer.parseInt(curPage_param);
		
		PageBlock pageBlock = new PageBlock();
		pageBlock.setCurPage(curPage);
		pageBlock.setNumberPerPage(pageSize);
		pageBlock.setNumberOfBlock(numberOfBlock); //페이지 블록 10개씩 출력
		pageBlock.getSearchNumberOfPages(conn, pageSize, Integer.parseInt(searchCondition), searchWord); 
		//바뀐 페이징 처리 함수
		int pageBlockStart = (curPage-1)/numberOfBlock * numberOfBlock + 1;
		int pageBlockEnd = (curPage-1)/numberOfBlock * numberOfBlock + numberOfBlock;
		if(pageBlockEnd > pageBlock.getNumberOfBlocks())
			pageBlockEnd = pageBlock.getNumberOfBlocks();
		pageBlock.setStart(pageBlockStart);
		pageBlock.setEnd(pageBlockEnd);
		pageBlock.prev = pageBlock.getStart() == 1 ? false : true; //start가 1이면 << 보일 필요 없음
		pageBlock.next = pageBlock.getEnd() == pageBlock.getNumberOfBlocks() ? false : true; //end가 pageBlock.numberOfBlock이면 >> 보일 필요 없음
		return pageBlock;
	}
}
```

### ListArticleHandler - `/article/list.do` 이벤트 처리 핸들러

`ListArticleHandler`와 `ListArticleService`를 같이 설명하겠다.  

게시글 리스트를 가져오는 과정인 `ListArticleDao`만 복잡하지 `Handler`와 `Service`객체는 얻어온 `ArrayList`객체와 `PageBlock`객체를 `listArticle.jsp` 페이지로 넘기기만 하면 된다.  

```java
public class ListArticleHandler implements CommandHandler {

	private ListArticleService listService = new ListArticleService();
	@Override
	public String process(HttpServletRequest request, HttpServletResponse response) 
	throws Exception {
		System.out.println("ListArticleHandler process");
		ArticlePage articlePage = listService.getArticlePage(request);
		request.setAttribute("articlePage", articlePage);
		return "/listArticle.jsp";
	}
}
```

```java
public class ListArticleService {
	private ArticleDao articleDao = new ArticleDao();
	
	public ArticlePage getArticlePage(HttpServletRequest request) {
		
		try (Connection conn = ConnectionProvider.getConncection())
		{
			ArrayList<Article> article_list = articleDao.getArticleList(conn, request);
			PageBlock pageBlock = articleDao.getPageBlock(conn, request);
			return new ArticlePage(article_list, pageBlock);
		} catch (Exception e) {
			throw new RuntimeException();
		}
	}
}
```
<br><br>

`request`객체에 `ArrayList`, `PageBlock`을 따로 담아도 되지만 `ArticlePage`란 하나의 객체로 감싸서 전송한다.  

`ArticlePage`도 필드로 `ArrayList`와 `PageBlock`을 가지고 있는 간단한 클래스이다.  
```java
public class ArticlePage {
	ArrayList<Article> article_list;
	PageBlock pageBlock;
	public ArticlePage(ArrayList<Article> article_list, PageBlock pageBlock) {
		this.article_list = article_list;
		this.pageBlock = pageBlock;
	}
	public ArrayList<Article> getArticle_list() {
		return article_list;
	}
	public PageBlock getPageBlock() {
		return pageBlock;
	}
}
```
<br><br>

View역할을 하는 `listArticle.jsp`파일은 아래와 같다.  

사실 `listArticle.jsp`도 전에 구현했던 것을 그대로 가져다 썼다.  

> https://kouzie.github.io/jsp/JSP-게시판/#게시판-리스트-페이징-처리

```html
<!-- listArticle.jsp -->
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시판 목록</title>
</head>
<body>
	<div align="center">
	<h2>목록보기</h2>
	<table style="border: solid 1px gray; width: 600px;">
		<thead>
			<tr>
				<th>번호</th>
				<th>제목</th>
				<th>작성자</th>
				<th>등록일</th>
				<th>조회</th>
			</tr>
		</thead>
		<tbody>
			<c:if test="${empty articlePage.article_list }">
				<tr align="center">
					<td colspan="5">등록된 게시가 없습니다</td>
				</tr>
			</c:if>
			
			<c:if test="${not empty articlePage.article_list }">
				<c:forEach items="${ articlePage.article_list }" var="dto">
					<tr align="center">
						<td>${dto.article_no }</td>
						<td>
							<a href="/jspPro/article/read.do?no=${dto.article_no }" class="subjectLink">${dto.title }</a>
						</td>
						<td>${dto.writer.name }</td>
						<td>${dto.regdate }</td>
						<td>${dto.read_cnt }</td>
					</tr>	
				</c:forEach>
			</c:if>
		</tbody>
		<tfoot>
			<tr>
				<td colspan="5" align="center">
					<div class="pagination">
						<c:if test="${ articlePage.pageBlock.prev }">
							<a href="/jspPro/article/list.do
							?currentPage=${articlePage.pageBlock.start - 1 }
							&searchCondition=${param.searchCondition}
							&searchWord=${param.searchWord}">&laquo;</a>
						</c:if>
						
						<c:forEach begin="${articlePage.pageBlock.start }" end="${articlePage.pageBlock.end }" step="1" var="i">
							<c:if test="${i eq articlePage.pageBlock.curPage }">
								<a class="active" href="#">${i }</a>
							</c:if>
							
							<c:if test="${i ne articlePage.pageBlock.curPage }">
								<a href="/jspPro/article/list.do
								?currentPage=${i }
								&searchCondition=${param.searchCondition}
								&searchWord=${param.searchWord}">${i }</a>
							</c:if>
						</c:forEach>
						<c:if test="${articlePage.pageBlock.next }">
							<a href="/jspPro/article/list.do
							?currentPage=${articlePage.pageBlock.end + 1 }
							&searchCondition=${param.searchCondition}
							&searchWord=${param.searchWord}">&raquo;</a>
						</c:if>
					</div>
				</td>
			</tr>
			<tr>
				<td colspan="5" align="center">
					<form action="" method="get">
						<select name="searchCondition" id="searchCondition">
							<option value="1">제목</option>
							<option value="2">내용</option>
							<option value="3">글쓴이</option>
							<option value="4">제목+내용</option>
						</select>
						<input type="text" name="searchWord" id="searchWord" value="${param.searchWord}"/>
						<input type="submit" value="검색"/>
						<%-- <input type="hidden" name="currentPage" value="${param.currentPage }"/> --%>
					</form>
				</td>
			</tr>
			<tr>
				<td colspan="5" align="center">
					<a href="/jspPro/index.do" style="float: left;">홈</a>
					<a href="/jspPro/article/write.do">글쓰기</a>
				</td>
			</tr>
		</tfoot>
	</table>
	</div>
	<script>
		$("#searchCondition").val("${ empty param.searchCondition ? 1 : param.searchCondition}");
		
		$(".subjectLink").attr( "href", function( i, val ) {
			return val + "&currentPage=${param.currentPage }&searchCondition=${param.searchCondition}&searchWord=${param.searchWord}";
		})
	</script>
</body>
</html>
```

## 게시글 쓰기 기능 구현

위의 `listArticle.jsp`파일의 글쓰기 링크는 아래와 같다.  

`<a href="/jspPro/article/write.do">글쓰기</a>`  

`/article/write.do` url을 요청한다.  

`commandHandler.properties`에 아래와 같이 핸들러 추가  

`/article/write.do=board21.article.command.WriteArticleHandler`

그리고 게시글 쓰기는 로그인 해야 사용 요청 가능하도록 `/article/write.do` url패턴이 `LoginCheckFilter`에 걸리도록 `web.xml`에서 설정하자.  

```xml
<filter>
  <filter-name>loginCheckFilter</filter-name>
  <filter-class>board21.filter.LoginCheckFilter</filter-class>
</filter>
<filter-mapping>
  <filter-name>loginCheckFilter</filter-name>
  <url-pattern>/changePwd.do</url-pattern>
  <url-pattern>/article/write.do</url-pattern>
</filter-mapping>
```
이제 `LoginCheckFilter`에 걸리는 url패턴은 총 2개이다.  

WrtieArticle 이벤트 처리과정을 살펴보자.  

![image44]({{ "/assets/jsp/image44.png" | absolute_url }}){: .shadow}     



### WriteArticleHandler - 게시글 쓰기 이벤트 헨들러

그럼 `WriteArticleHandler`부터 하나씩 정의해보자.

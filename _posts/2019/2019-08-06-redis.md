---
title:  "reids!"

read_time: false
share: false
author_profile: false
classes: wide

categories:
  - spring

tags:
  - redis

toc: true

---

## redis

> Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker.

메모리 공간에 저장되는 휘발성 데이터베이스, Persistence 속성을 통해 메모리의 내용을 파일로 덤프할 수도 있다.  

key, value 기반의 데이터베이스임으로 mongoDB와 같은 NoSQL처럼 사용할 수 있다.

redis 설치는 brew 등의 명령으로 간단히 설치 가능

서버 시작과 정료 명령어 (mac)  
> redis-server  
> redis-cli shutdown  

`application.properties` 에 아래와 같이 설정
```properties
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.timeout=0
```

설정한 데이터대로 스프링 빈 객체 생성이 필요하다.  

```java
@Configuration
@Log
public class RedisRepoConfig extends CachingConfigurerSupport {
    @Value("${spring.redis.host}")
    private String host;
    @Value("${spring.redis.port}")
    private int port;
    @Value("${spring.redis.timeout}")
    private int timeout;

    private RedisServer redisServer;
    private static final Logger logger = LoggerFactory.getLogger(RedisRepoConfig.class);

    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        log.info("RedisConnectionFactory create");
        return new LettuceConnectionFactory(host, port);
    }
    @Bean
    public RedisTemplate<?, ?> redisTemplate() {
        RedisTemplate<?, ?> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        return redisTemplate;
    }
}
```

redis서버와 연결을 위한 객체를 생성하는 `...Factory`, 연결된 객체를 통해 redis에 명령을 전달하는 `RedisTemplate`  

redis와 연결을 휘한 객체로 `Jedis`, `Lettuce` 2가지가 있다.  

`Lettuce`를 사용하는게 성능상 좋다고 한다.  
> https://jojoldu.tistory.com/418

redis를 위한 스프링 설정이 끝났고 어떤 데이터를 어떤 테이블에 저장할지 domain객체를 생성


```java
@AllArgsConstructor
@ToString
@RedisHash("point")
public class Point {
    @Id
    private String id;
    private Long amount;
    private LocalDateTime refreshTime;

    public void refresh(Long amount, LocalDateTime refreshTime) {
        if (refreshTime.isAfter(this.refreshTime)) {
            this.amount = amount;
            this.refreshTime = refreshTime;
        }
    }
}
```

redis의 좋은점은 정말 DB처럼 사용할 수 있기때문에 `CrudRepository` 구현체도 사용 가능하다.


```java
public interface PointRedisRepository extends CrudRepository<Point, String> {
}

```

```java
@RunWith(SpringRunner.class)
@SpringBootTest
@Log
public class RedisTest1 {
    @Autowired
    private PointRedisRepository repo;

    @After
    public void tearDown() throws Exception {
        repo.deleteAll();
    }

    @Test
    public void defaultInput() {
        String id = "kouzie";
        LocalDateTime refreshTime = LocalDateTime.now();
        Point point = new Point(id, 1000L, refreshTime);
        log.info("before Point : " + point);
        repo.save(point);

        Point savedPoint = repo.findById(id).get();
        log.info("after Point : " + savedPoint);
    }
}
```

## StringRedisTemplate

```java
@Configuration
@Log
public class RedisRepoConfig extends CachingConfigurerSupport {
    ...
    ...
    @Bean
    public StringRedisTemplate stringRedisTemplate() {
        StringRedisTemplate stringRedisTemplate = new StringRedisTemplate();
        stringRedisTemplate.setConnectionFactory(redisConnectionFactory());
        return stringRedisTemplate;
    }
}
```
키와함께 value값으로 `json`과 같은 긴 문자열 데이터를 같이 저장하는 경우가 많은데  
이 때 `StringRedisTemplate` 을 사용하면 좋다.  

먼저 컨트롤러 하나 생성,

```java
@Controller
@Log
@RequestMapping("/redis")
public class RedisController {
    @Autowired
    StringRedisTemplate stringRedisTemplate;

    @GetMapping("/sample")
    public void sample(Model model) {
        log.info("sample called()....");
        Set<String> keys = stringRedisTemplate.keys("*");

        model.addAttribute("keys", new ArrayList<>(keys));
    }

    @GetMapping("/insert")
    public String insert(
            @Param("key") String key,
            @Param("value") String value
    ) {
        log.info("insert called()....");
        log.info(key + ":" + value);
        stringRedisTemplate.opsForSet().add(key, value);
        return "redirect:/redis/sample";
    }


    @GetMapping("/deleteAll")
    public String deleteAll(Model model) {
        log.info("deleteAll called()....");
        stringRedisTemplate.delete(stringRedisTemplate.keys("*"));
        return "redirect:/redis/sample";
    }
}
```

`CrudRepository`를 사용해서 `redis`에 데이터를 삽입해도 되지만 `StringRedisTemplate` 혹은 그냥 `RedisTemplate`의 메서드로도 충분이 삽입 가능하다.   

```html
<!DOCTYPE html>
<html class="no-js" lang="en"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    sample_radis

    <form action="/redis/insert">
        key: <input type="text" name="key" >
        value: <input type="text" name="value">
        <button type="submit">submit</button>
    </form>
    <button onclick="location.href='/redis/deleteAll'">delete all</button>

    <p th:each="p:${keys}">[[${p}]]</p>
</body>
</html>
```

지금까지 저장된 키 목록이 출력된다.  
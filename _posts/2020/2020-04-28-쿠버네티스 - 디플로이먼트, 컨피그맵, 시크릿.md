---
title:  "ì¿ ë²„ë„¤í‹°ìŠ¤ - ë””í”Œë¡œì´ë¨¼íŠ¸, ì»¨í”¼ê·¸ë§µ, ì‹œí¬ë¦¿!"

read_time: false
share: false
author_profile: false
classes: wide

categories:
  - docker
  - kubernetes

tags: kubernetes

toc: true

---

# ë””í”Œë¡œì´ë¨¼íŠ¸

> Deployment: ì „ê°œ, ë°°ì¹˜  
> https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/


ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„  ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ìœ ì—°í•œ `CI/CD(ì§€ì†ì ì¸ í†µí•©/ë°°í¬)` ë¥¼ ìœ„í•´ `Deployment` ë¥¼ ì œê³µí•œë‹¤.  

`Deployment`ëŠ” ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ ìƒìœ„ê°œë…ì´ë‹¤.  
ë˜‘ê°™ì´ ì—¬ëŸ¬ê°œì˜ íŒŒë“œë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•œë‹¤.  
ì—¬ê¸°ì„œ ì—…ë°ì´íŠ¸ ê´€ë ¨ ê¸°ëŠ¥ì„ ì¶”ê°€ ì œê³µí•´ì¤€ë‹¤ ìƒê°í•˜ë©´ ëœë‹¤.  

## ìš©ì–´ì„¤ëª…  

**Recreate**  
ì˜¤ë˜ëœ íŒŒë“œë¥¼ ì •ì§€ì‹œí‚¤ê³  ìƒˆë¡œìš´ íŒŒë“œë¥¼ ë‹¤ì‹œ ì‘ì„±í•˜ëŠ” ë°©ì‹.
ê°€ì¥ ì‹¬í”Œí•˜ê³  ë¹ ë¥´ì§€ë§Œ ì„œë²„ê°€ ëª¨ë‘ ë‚´ë ¤ê°€ ë²„ë¦¬ê¸°ì— ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•œë‹¤.  

**Rolling update**  
ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ì „ì—…ì´ ëª¨ë‘ í•œêº¼ë²ˆì— ì—…ë°ì´íŠ¸ ë˜ëŠ”ê²ƒì´ ì•„ë‹Œ  
ìˆœì„œëŒ€ë¡œ ì¡°ê¸ˆì”© ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ë²•  

ë˜‘ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—¬ëŸ¬ ê°œ ë³‘ë ¬ë¡œ ì›€ì§ì´ëŠ” ê²½ìš° ê°€ëŠ¥í•˜ë‹¤.  

**blue/green Deployment**   
ë²„ì „ì´ ë‹¤ë¥¸ ë‘ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë™ì‹œì— ê°€ë™í•˜ê³  ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ì‚¬ìš©í•´ ë³„ë„ì˜ ê³µê°„ì—ì„œ ë™ì‘ì‹œí‚¨ë‹¤.  
ì—…ë°ì´íŠ¸ ë²„ì „ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì„œë¹„ìŠ¤ëŠ” ì „í™˜ì‹œì¼œ ì—…ë°ì´íŠ¸ ì™„ë£Œ.    

ë¸”ë£¨(êµ¬ë²„ì „), ê·¸ë¦°(ì‹ ë²„ì „) ì„ ì „í™˜í•˜ëŠ” ëœ»ì—ì„œ ìœ ë˜ë¨.  

ê·¸ë¦°ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¥ì•  ë°œìƒì‹œ ë¸”ë£¨ë¡œ ë°”ë¡œ ë³µêµ¬ ê°€ëŠ¥í•œ ì¥ì ì´ ìˆë‹¤.  

**Roll out, Roll back**   
ë¡¤ì•„ì›ƒ(`roll-out`) ê°„ë‹¨íˆ ë²ˆì—­í•˜ë©´ ì‹ ì œí’ˆ ë˜ëŠ” ì •ì±…ì¶œì‹œ ë˜ëŠ” ë¦´ë¦¬ì¦ˆë¼ í•  ìˆ˜ ìˆë‹¤.

`Deployment`ëŠ” ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë²„ì „ì—… ë“± ì—…ë°ì´íŠ¸ê°€ ìˆì„ ë•Œ ì‚¬ë¡œìš´ ì‚¬ì–‘ì˜ ë¦¬í”Œë¦¬ì¹´ì…‹(ë§¤ë‹ˆí˜ìŠ¤íŠ¸) ë¥¼ ì‘ì„±í•˜ê³   
ê·¸ì— í•´ë‹¹í•˜ëŠ” ìƒˆë¡œìš´ íŒŒë“œë¡œ ì´ë¥¼ ëŒ€ì²´í•´ ë¡¤ì•„ì›ƒì„ ìˆ˜í–‰í•œë‹¤.  

## ë§¤ë‹ˆí˜ìŠ¤íŠ¸ 

```yaml
# ê¸°ë³¸í•­ëª©
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
# ë””í”Œë¡œì´ë¨¼íŠ¸ ìŠ¤íŒ©
spec:
  replicas: 10
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 50%
      maxSurge: 50%
  selector:
    matchLabels:
      app: nginx-pod # í…œí”Œë¦¿ ê²€ìƒ‰ì¡°ê±´
  # íŒŒë“œ í…œí”Œë¦¿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
        - name: nginx
          image: nginx:1.14 # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€
          ports:
            - containerPort: 80
```


`Deployment`ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë˜í•œ `spec` ì†ì„±ì´ ì¢€ ë‹¤ë¥¼ë¿ ë‚˜ë¨¸ì§€ëŠ” ë¹„ìŠ·í•˜ë‹¤.  

|í•„ë“œ|ì„¤ëª…|
|---|---|
`replicas` | í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ê°€ë™ì‹œí‚¬ íŒŒë“œì˜ ìˆ˜  
`selector` | ì–´ë–¤ íŒŒë“œë¥¼ ê°€ë™ì‹œí‚¬ì§€ì— ëŒ€í•œ ì…€ë ‰í„°, íŒŒë“œì— ì ìš©ëœ ë¼ë²¨ì„ ì‚¬ìš©í•œë‹¤.  
`template` | í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ íŒŒë“œ ìˆ˜ê°€ ë¦¬í”Œë¦¬ì¹´ìˆ˜ë³´ë‹¤ ì‘ì„ë•Œ ìƒˆë¡œ ì‘ì„±í•  íŒŒë“œì˜ í…œí”Œë¦¿  
`strategy` | ì—…ë°ì´íŠ¸ ë°©ì‹ ê²°ì • ê°€ëŠ¥, `RollingUpdate`, `Recreate` ê°€ ìˆìœ¼ë©° ê¸°ë³¸ê°’ì€ `RollingUpdate`  
`maxUnavailable` | ë¡¤ë§ ì—…ë°ì´íŠ¸ì¤‘ í•­ìƒ ì‚¬ìš©ê°€ëŠ¥í•œ íŒŒë“œì˜ ì´ìˆ˜, ìœ„ì˜ ê²½ìš° ì‹ ë²„ì „, êµ¬ë²„ì „ í•©ì³ì„œ ë¦¬í”Œë¦¬ì¹´ìˆ˜ì˜ 50%ì˜ íŒŒë“œê°€ í•­ìƒ ë™ì‘ì¤‘ì´ì–´ì•¼ í•œë‹¤. ê¸°ë³¸ê°’ì€ 25%  
`maxSurge` | íŒŒë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ê°œìˆ˜, 100%ë¡œ ì„¤ì •ì‹œ ì‹ ë²„ì „ì˜ íŒŒë“œìˆ˜ê°€ ë¦¬í”Œë¦¬ì¹´ìˆ˜ë§Œí¼ ì‹¤í–‰ë˜ì–´ í•œë²ˆì— 20ê°œì˜ íŒŒë“œê°€ ë™ì‘í•˜ê²Œ ëœë‹¤. ê¸°ë³¸ê°’ì€ 25%. ë¦¬ì†ŒìŠ¤ ìƒí™©ì— ë”°ë¼ íŠ¹ì´ì‚¬í•­ì´ ë°œìƒí•  ìˆ˜ ìˆìŒìœ¼ë¡œ `maxSurge` ëŠ” ì‘ì„±í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.  
`readinessProbe` | ì‹¤í–‰í•œ íŒŒë“œê°€ ì •ìƒì¸ì§€ í™•ì¸í•˜ëŠ” ì†ì„± íŒŒë“œì˜ `livenessProbe` ì™€ ë¹„ìŠ·í•˜ë‹¤. 



- `livenessProbe`: ì»¨í…Œì´ë„ˆê°€ ë™ì‘ ì¤‘ì¸ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. ë§Œì•½ í™œì„± í”„ë¡œë¸Œ(liveness probe)ì— ì‹¤íŒ¨í•œë‹¤ë©´, kubeletì€ ì»¨í…Œì´ë„ˆë¥¼ ì£½ì´ê³ , í•´ë‹¹ ì»¨í…Œì´ë„ˆëŠ” ì¬ì‹œì‘ ì •ì±…ì˜ ëŒ€ìƒì´ ëœë‹¤. ë§Œì•½ ì»¨í…Œì´ë„ˆê°€ í™œì„± í”„ë¡œë¸Œë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ” ê²½ìš°, ê¸°ë³¸ ìƒíƒœëŠ” Successì´ë‹¤.  

- `readinessProbe`: ì»¨í…Œì´ë„ˆê°€ ìš”ì²­ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. ë§Œì•½ ì¤€ë¹„ì„± í”„ë¡œë¸Œ(readiness probe)ê°€ ì‹¤íŒ¨í•œë‹¤ë©´, ì—”ë“œí¬ì¸íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” íŒŒë“œì— ì—°ê´€ëœ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ íŒŒë“œì˜ IPì£¼ì†Œë¥¼ ì œê±°í•œë‹¤. ì¤€ë¹„ì„± í”„ë¡œë¸Œì˜ ì´ˆê¸° ì§€ì—° ì´ì „ì˜ ê¸°ë³¸ ìƒíƒœëŠ” Failureì´ë‹¤. ë§Œì•½ ì»¨í…Œì´ë„ˆê°€ ì¤€ë¹„ì„± í”„ë¡œë¸Œë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ê¸°ë³¸ ìƒíƒœëŠ” Successì´ë‹¤.  

> `Pod livenessProbe`: https://kouzie.github.io/docker/kubernetes/ì¿ ë²„ë„¤í‹°ìŠ¤-íŒŒë“œ/#íŒŒë“œ-ê°ì‹œ


## ë””í”Œë¡œì´ë¨¼íŠ¸ CRUD

### ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„±  

ìœ„ì˜ `Deployment` ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ìƒì„±í›„ ë¦¬í”Œë¦¬ì¹´ì…‹ê³¼ íŒŒë“œê°€ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸  

ë¦¬í”Œë¦¬ì¹´ìˆ˜ë¥¼ 3ìœ¼ë¡œ ì„¤ì •í›„ ìƒì„±í•œë‹¤.  

```
$ kubectl apply -f Deployment/nginx-deployment.yaml
deployment.apps/nginx-deployment created

$ kubectl get deploy
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           24s

$ kubectl get replicaset,pod
NAME                                          DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-deployment-5bff7844cb   3         3         3       5m11s

NAME                                    READY   STATUS    RESTARTS   AGE
pod/nginx-deployment-5bff7844cb-6n2xh   1/1     Running   0          5m11s
pod/nginx-deployment-5bff7844cb-9jmvt   1/1     Running   0          5m11s
pod/nginx-deployment-5bff7844cb-kc7ph   1/1     Running   0          5m11s
```

ë¦¬ì†ŒìŠ¤ì˜ ë„¤ì´ë° ê·œì¹™ì´ ìˆë‹¤.  

`Deployment` - `nginx-deployment`  
`ReplicaSet` - `nginx-deployment-5bff7844cb`  
`Pod` - `nginx-deployment-5bff7844cb-kc7ph`  

ë’¤ì— íŠ¹ì • í•´ì‹œê°’ì´ ë¼ë²¨ë¡œë„ ë¶™ì–´ìˆìœ¼ë©° ì´ë¥¼ ì‚¬ìš©í•´ `Deployment`ê°€ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•œë‹¤.  

### ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„¸ì •ë³´  

```
$ kubectl describe deploy nginx-deployment
Name:                   nginx-deployment
Namespace:              default
...
...
OldReplicaSets:  <none>
NewReplicaSet:   nginx-deployment-5bff7844cb (3/3 replicas created)
```


### ë””í”Œë¡œì´ë¨¼íŠ¸ ì—…ë°ì´íŠ¸(ë¡¤ ì•„ì›ƒ)

ê¸°ì¡´ì˜ `nginx:1.14` ë²„ì „ì˜ ì´ë¯¸ì§€ë¥¼ `nginx:1.15` ë¡œ ë³€ê²½í•´ë³´ì.  
```
$ kubectl apply -f Deployment/nginx-deployment.yaml
deployment.apps/nginx-deployment configured

$ kubectl describe deploy nginx-deployment
Name:                   nginx-deployment
Namespace:              default
...
...
OldReplicaSets:  <none>
NewReplicaSet:   nginx-deployment-f75fb748c (3/3 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled up replica set nginx-deployment-5bff7844cb to 3
  Normal  ScalingReplicaSet  18s   deployment-controller  Scaled up replica set nginx-deployment-f75fb748c to 1
  Normal  ScalingReplicaSet  4s    deployment-controller  Scaled down replica set nginx-deployment-5bff7844cb to 2
  Normal  ScalingReplicaSet  4s    deployment-controller  Scaled up replica set nginx-deployment-f75fb748c to 2
  Normal  ScalingReplicaSet  3s    deployment-controller  Scaled down replica set nginx-deployment-5bff7844cb to 1
  Normal  ScalingReplicaSet  3s    deployment-controller  Scaled up replica set nginx-deployment-f75fb748c to 3
  Normal  ScalingReplicaSet  2s    deployment-controller  Scaled down replica set nginx-deployment-5bff7844cb to 0
```

`nginx-deployment-5bff7844cb` ì´ë¦„ì˜ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ íŒŒë“œë¥¼ í•˜ë‚˜ì”© ì¤„ì´ë©°  
`nginx-deployment-f75fb748c` ì´ë¦„ì˜ ìƒˆë¡œìš´ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ íŒŒë“œë¥¼ í•˜ë‚˜ì”© ìƒì„±í•œë‹¤.  


ë””í”Œë¡œì´ë¨¼íŠ¸ëŠ” ë‚´ë¶€ì—ì„œ ë¦¬í”Œë¦¬ì¹´ì…‹ ì´ë ¥ì„ ê°–ê³  ìˆë‹¤.  

```
$ kubectl get replicaset --output=wide
NAME                          DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES       SELECTOR
nginx-deployment-5bff7844cb   0         0         0       44m   nginx        nginx:1.14   app=nginx-pod,pod-template-hash=5bff7844cb
nginx-deployment-f75fb748c    3         3         3       16m   nginx        nginx:1.15   app=nginx-pod,pod-template-hash=f75fb748c
```

ì‚­ì œëŠ” ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ì™€ ê°™ì´ `delete` ëª…ë ¹ì„ ì‚¬ìš©  

```
$ kubectl delete -f Deployment/nginx-deployment.yaml
```

## ë””í”Œë¡œì´ë¨¼íŠ¸ ë¡¤ë°±  

ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë¬¸ì œê°€ ìƒê¸°ë©´ ë‹¤ì‹œ ì´ì „ë²„ì „ìœ¼ë¡œ ëŒë¦´ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥(ë¡¤ë°±) ì„ ì‚¬ìš©í•´ë³´ì.  

ë¨¼ì € ì•„ë˜ì™€ ê°™ì€ ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ìƒì„± í›„ ì‹¤ì œ ì„œë¹„ìŠ¤ê¹Œì§€ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸  

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rollout-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v1.0
          name: photoview-container
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: rollout
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  selector:
    app: photo-view
```

```
$ kubectl apply -f Deployment/rollout-depoyment.yaml
deployment.apps/rollout-deployment created
service/rollout created

$ kubectl get pod
NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-d8bf6cb58-2p5wz   1/1     Running   0          48s
rollout-deployment-d8bf6cb58-56mrf   1/1     Running   0          48s
rollout-deployment-d8bf6cb58-bscp8   1/1     Running   0          48s
```

`minikube` ì˜ ê²½ìš° `service`ì˜ ì™¸ë¶€ë…¸ì¶œ IPë¥¼ ì‚¬ìš© ë¶ˆê°€ëŠ¥ í•¨ìœ¼ë¡œ `$ kubectl get services` ëª…ë ¹ì„ ì‚¬ìš©í•´ë„ `<pending>` ìœ¼ë¡œë°–ì— ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤.  

ì•„ë˜ `minikube service` ëª…ë ¹ì„ ì‚¬ìš©í•´ í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œì‹œí‚¨ë‹¤.  

```
$ minikube service rollout
ğŸƒ  Starting tunnel for service rollout.
|-----------|---------|-------------|------------------------|
| NAMESPACE |  NAME   | TARGET PORT |          URL           |
|-----------|---------|-------------|------------------------|
| default   | rollout |             | http://127.0.0.1:51768 |
|-----------|---------|-------------|------------------------|
ğŸ‰  Opening service default/rollout in default browser...
â—  Because you are using docker driver on Mac, the terminal needs to be open to run it.
```

í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ì´ë¯¸ì§€ `photo-view:v1.0` ë¥¼ `photo-view:v2.0` ìœ¼ë¡œ ì—…ë°ì´íŠ¸  

```
$ kubectl apply -f Deployment/rollout-depoyment.yaml
deployment.apps/rollout-deployment configured
service/rollout unchanged

$ kubectl describe deploy rollout-deployment
Name:                   rollout-deployment
Namespace:              default
...
Annotations:            deployment.kubernetes.io/revision: 2
...
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  41s   deployment-controller  Scaled up replica set rollout-deployment-d8bf6cb58 to 3
  Normal  ScalingReplicaSet  27s   deployment-controller  Scaled up replica set rollout-deployment-6b5ddcb6b7 to 1
```

`describe` ëª…ë ¹ìœ¼ë¡œ ì¶œë ¥ëœ `Annotations` ì†ì„±ìœ¼ë¡œ `revision` ê°’ í™•ì¸  
í•´ë‹¹ ë””í”Œë¡œì´ë¨¼íŠ¸ê°€ ëª‡ë²ˆ ì—…ë°ì´íŠ¸ ë˜ì—ˆëŠ”ì§€ í™•ì´ ê°€ëŠ¥í•˜ë‹¤.  

`d8bf6cb58 -> 6b5ddcb6b7` í•´ì‹œì˜ ë³€ê²½ê°’ì´ë‹¤.  

ì´ì œ `photo-view:v2.0` ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ë‹¤ì‹œ ì˜ˆì „ë²„ì „ìœ¼ë¡œ ë¡¤ ë°±í•´ë³´ì.  

ì²«ë²ˆì§¸ ë°©ë²•ìœ¼ë¡œ íƒ¬í”Œë¦¿ ì´ë¯¸ì§€ë¥¼ `photo-view:v1.0` ë¡œ ë‹¤ì‹œ ì ìš©í•´ë³´ì.  

```
kubectl apply -f Deployment/rollout-depoyment.yaml
deployment.apps/rollout-deployment configured
service/rollout unchanged

$ kubectl describe deploy rollout-deployment
...
Annotations:            deployment.kubernetes.io/revision: 3
...

$ kubectl get pod
NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-d8bf6cb58-9nwh5   1/1     Running   0          33s
rollout-deployment-d8bf6cb58-t2f4l   1/1     Running   0          34s
rollout-deployment-d8bf6cb58-tgg57   1/1     Running   0          31s
```

`revision`ê°’ì€ 3ì´ ë˜ì—ˆê³  í•´ì‹œê°’ì€ ë‹¤ì‹œ `d8bf6cb58` ë¡œ ëŒì•„ê°”ë‹¤.  

ë””í”Œë¡œì´ë¨¼íŠ¸, ë¦¬í”Œë¦¬ì¹´ì…‹, íŒŒë“œ ëª¨ë‘ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì´ë ¥ì„ ê°€ì§€ê³  ë¡¤ì•„ì›ƒ/ë¡¤ë°±ì„ ì§„í–‰í•˜ê³  ìˆê¸° ë•Œë¬¸  

ì´ ì™¸ì—ë„ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìˆ˜ì •í•˜ê±°ë‚˜ `kubectl rollout` ëª…ë ¹ì„ ì‚¬ìš©í•´ ë¡¤ë°±ì´ ê°€ëŠ¥í•˜ë‹¤.  

```
$ kubectl edit deploy rollout-deployment
$ kubectl rollout undo deployment rollout-deployment --to-revision=2 
```

êµ¬ì„±ê´€ë¦¬ê°€ ìœ ì§€ë˜ì§€ ì•ŠìŒìœ¼ë¡œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì˜ ê°±ì‹ (ì„ ì–¸ì  ê´€ë¦¬)ìœ¼ë¡œ ë¡¤ì•„ì›ƒ/ë¡¤ë°± í•˜ëŠ”ê²ƒì„ ê¶Œì¥í•œë‹¤.  

## ë””í”Œë¡œì´ë¨¼íŠ¸ ì´ë ¥ history

```
$ kubectl rollout history deploy rollout-deployment --revision=3
deployment.apps/rollout-deployment with revision #3
Pod Template:
  Labels:	app=photo-view
	pod-template-hash=d8bf6cb58
  Containers:
   photoview-container:
    Image:	ai1.beyless.com:5005/photo-view:v1.0
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
  Volumes:	<none>

$ kubectl rollout history deploy rollout-deployment --revision=4
deployment.apps/rollout-deployment with revision #4
Pod Template:
  Labels:	app=photo-view
	pod-template-hash=6b5ddcb6b7
  Containers:
   photoview-container:
    Image:	ai1.beyless.com:5005/photo-view:v2.0
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
  Volumes:	<none>
```

## ë¸”ë£¨/ê·¸ë¦° ë””í”Œë¡œì´ë¨¼íŠ¸  

ì„œë¡œ ë‹¤ë¥¸ 2ê°œì˜ `Deployment`ë¥¼ ê°ê° ìƒì„±í•œë‹¤.  

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blue-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
        ver: v1.0
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v1.0
          name: photoview-container
          ports:
            - containerPort: 80
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: green-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
        ver: v2.0
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v2.0
          name: photoview-container
          ports:
            - containerPort: 80
```



```
$ kubectl apply -f Deployment/blue-deployment.yaml
deployment.apps/blue-deployment created

$ kubectl apply -f Deployment/green-deployment.yaml
deployment.apps/green-deployment created

$ kubectl get pod
NAME                                 READY   STATUS        RESTARTS   AGE
blue-deployment-58d5d4869b-kmn88     1/1     Running       0          19s
blue-deployment-58d5d4869b-vlx2c     1/1     Running       0          19s
blue-deployment-58d5d4869b-w4729     1/1     Running       0          19s
green-deployment-5466fc4568-7hxqp    1/1     Running       0          15s
green-deployment-5466fc4568-mvs2w    1/1     Running       0          15s
green-deployment-5466fc4568-t8hp2    1/1     Running       0          15s
```

ê·¸ë¦¬ê³  ì´ `Deployment` ì˜ `ReplicaSet` ì˜ `Pod` ì— ì ‘ê·¼í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì‘ì„±í•˜ê³  ì‹¤í–‰í•œë‹¤.  

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webserver
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  selector:
    app: photo-view
    ver: v1.0
```

```
$ kubectl apply -f Deployment/service.yaml
service/webserver created

$ minikube service webserver
ğŸƒ  Starting tunnel for service webserver.
|-----------|-----------|-------------|------------------------|
| NAMESPACE |   NAME    | TARGET PORT |          URL           |
|-----------|-----------|-------------|------------------------|
| default   | webserver |             | http://127.0.0.1:53405 |
|-----------|-----------|-------------|------------------------|
ğŸ‰  Opening service default/webserver in default browser...
â—  Because you are using docker driver on Mac, the terminal needs to be open to run it.
```

ì´ì œ `service.yml` ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë§Œ ìˆ˜ì •í•´ì„œ `blue`, `green` `Deployment` ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ë©´ ëœë‹¤.  


# ConfigMap

ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ì •ë³´ ê´€ë¦¬ë¥¼ ìœ„í•œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤  

ì£¼ë¡œ ì™¸ë¶€ API í‚¤ê°’, í™˜ê²½ë³€ìˆ˜ ë“±ì„ ë³„ë„ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤ì´ë‹¤.  

## ConfigMap ìƒì„±ë°©ë²•

ì•„ë˜ 2ê°€ì§€ ë°©ë²•ì„ ì£¼ë¡œ ì‚¬ìš©í•´ ì»¨í”¼ê·¸ë§µì„ ìƒì„±í•œë‹¤.  


### 1. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë§Œë“¤ê¸° 

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
    name: project-config
data:
    project.id: "hello-kubernetes"
    project.name: "world-kubernetes"
```



```
$ kubectl apply -f ConfigMap/configmap.yaml
configmap/project-config created

$ kubectl get configmap
NAME             DATA   AGE
project-config   1      41s

$ kubectl describe configmap project-config
Name:         project-config
Namespace:    default
Labels:       <none>
Annotations:
Data
====
project.id:
----
hello-kubernetes
project.name:
----
world-kubernetes
Events:  <none>
```

### 2. ì–´í”Œë¦¬ì¼€ì´ì…˜ configíŒŒì¼ ë¡œ ë§Œë“¤ê¸°


```
$ cat ConfigMap/config/ui.ini
; appì—ì„œ ì‚¬ìš©í•˜ëŠ” config íŒŒì¼
[UI]
color.top = blue
text.size = 10
```

ë‹¤ìŒê³¼ ê°™ì€ `ini` íŒŒì¼ì´ ìˆì„ë•Œ ì´ë¥¼ ì‚¬ìš©í•´ ì¿ ë²„ë„¤í‹°ìŠ¤ â‚© ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ì.  

```
$ kubectl create configmap app-config --from-file=ConfigMap/config/
configmap/app-config created

$ kubectl describe configmap app-config
Name:         app-config
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
ui.ini:
----
; appì—ì„œ ì‚¬ìš©í•˜ëŠ” config íŒŒì¼
[UI]
color.top = blue
text.size = 10

Events:  <none>
```

`file name`ì„ í‚¤ê°’ìœ¼ë¡œ `file content`ê°€ `value` ë¡œ ë“¤ì–´ê°”ë‹¤.   

## ConfigMap ì „ë‹¬  

ì»¨í”¼ê·¸ë§µì„ ì „ë‹¬í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ê°€ì§€ë‹¤.  


1. `containers.env` ì†ì„±ìœ¼ë¡œ ì „ë‹¬  
3. `volumes` ìœ¼ë¡œ ì „ë‹¬  



```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: configmap-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: config-view
  template:
    metadata:
      labels:
        app: config-view
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v3.0
          name: photoview-container
          imagePullPolicy: Always
          ports:
            - containerPort: 80
          env:
            - name: PROJECT_ID
              valueFrom:
                configMapKeyRef:
                  name: project-config
                  key: project.id
          volumeMounts:
            - name: config-volume
              mountPath: /etc/config
      volumes:
        - name: config-volume
          configMap:
            name: app-config
```

`spec` ì†ì„±ì˜ `containers.env` ì†ì„±ì„ ë³´ë©´ `project-config` ì»¨í”¼ê·¸ë§µì˜ `project.id` í‚¤ì— í•´ë‹¹í•˜ëŠ” `value` ë¥¼ `PROJECT_ID` í™˜ê²½ë³€ìˆ˜ë¡œ í• ë‹¹í•œë‹¤.  

`spec` ì†ì„±ì˜ `volumes` ì†ì„±ì„ ë³´ë©´ ê²½ìš° `app-config` ì»¨í”¼ê·¸ë§µì˜ ì •ë³´ë¥¼ `config-volume` ë³¼ë¥¨ì— ë§ˆìš´íŠ¸í•œë‹¤.  

ìœ„ì—ì„œ ìƒì„±í•œ íŒŒë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” `Service` ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±  

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webserver
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  selector:
    app: config-view
```

# Secret

ë¹„ë°€ë²ˆí˜¸, í‚¤ì™€ ê°™ì€ ê¸°ë°€ë°ì´í„°ë¥¼ ë‹¤ë£°ë•Œ ì‚¬ìš©í•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤  
`Secret` ì˜ êµ¬ì¡°ëŠ” `ConfigMap` ê³¼ ë§¤ìš° ë¹„ìŠ·í•˜ë‹¤.  
ë‹¨ `etcd` ì•ˆì—ì„œ ì•”í˜¸í™”ëœ ìƒíƒœë¡œ ê´€ë¦¬ë˜ëŠ” ì°¨ì´ê°€ ìˆìŒ.  

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: api-key
type: Opaque
data:
  id: ZGJ1c2Vy
  key: YUJjRDEyMw==
```

`data` ì˜ í•„ë“œë“¤ì€ `base64` ë¡œ ì¸ì½”ë”©ëœ ë°ì´í„°ë¡œ `mac` ì˜ ê²½ìš° ì•„ë˜ `base64` ëª…ë ¹ì–´ë¡œ ì¸ì½”ë”©/ë””ì½”ë”© ê°€ëŠ¥í•˜ë‹¤.  


```
$ echo 'ZGJ1c2Vy' | base64 --decode
dbuser%

$ echo 'YUJjRDEyMw==' | base64 --decode
aBcD123%
```

|ì„¤ì •|ì„¤ëª…|
|---|---|
`Opaque` | ì¼ë°˜ì ì¸ ê¸°ë°€ì •ë³´
`kubernetes.io/tls` | `TLS` ì •ë³´
`kubernetes.io/dockerconfigjson` | `Docker Registry` ì •ë³´
`kubernetes.io/service-account-token` | `Service Account` ì •ë³´


> `TLS`: ì „ì†¡ ê³„ì¸µ ë³´ì•ˆ(Transport Layer Security)    
`TLS`ëŠ” ê°€ì¥ ìµœì‹  ê¸°ìˆ ë¡œ ë” ê°•ë ¥í•œ ë²„ì „ì˜ SSLì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ SSLì´ ë” ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ìš©ì–´ì´ê¸°ì—, ì—¬ì „íˆ ë³´ì•ˆ ì¸ì¦ì„œëŠ” SSLì´ë¼ ë¶ˆë¦½ë‹ˆë‹¤.

## Secret ìƒì„±, ë§ˆìš´íŠ¸

ì»¨í”¼ê·¸ë§µê³¼ ë§ˆì°¬ê°€ì§€ë¡œ `Secret` ë„ í™˜ê²½ë³€ìˆ˜, íŒŒì¼ í˜•íƒœë¡œ ë§ˆìš´íŠ¸ ê°€ëŠ¥í•˜ë‹¤.  

ë‘ê°œì˜ ì‹œí¬ë¦¿ ìƒì„±,  
í•˜ë‚˜ëŠ” ìœ„ì˜ `yaml` ì—ì„œ ì •ì˜í•œ `key-value` í˜•ì‹ì˜ ë°ì´í„°ê°€ ë“¤ì–´ê°€ ìˆëŠ” ì‹œí¬ë¦¿ì´ê³   
í•˜ë‚˜ëŠ” `--from-file` ì˜µì…˜ìœ¼ë¡œ í•´ë‹¹ `Secrets/key/` ìœ„ì¹˜ì— ìˆëŠ” `apl.crt` íŒŒì¼ì„ ëŒ€ìƒìœ¼ë¡œ ì‹œí¬ë¦¿ ìƒì„±í•œë‹¤.  

```
$ kubectl apply -f Secrets/secrets.yaml

$ kubectl create secret generic apl-auth --from-file=Secrets/key/
secret/apl-auth created
```

ìƒì„±í•œ ì‹œí¬ë¦¿ì€ ì»¨í”¼ê·¸ë§µê³¼ ë§ˆì°¬ê°€ì§€ë¡œ `containers.env`, `volumes` ì†ì„±ìœ¼ë¡œ ë§ˆìš´íŠ¸ ê°€ëŠ¥í•˜ë‹¤.  

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secret-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v1.0
          name: photoview-container
          imagePullPolicy: Always
          ports:
            - containerPort: 80
          env:
            - name: SECRET_ID
              valueFrom:
                secretKeyRef:
                  name: api-key
                  key: id
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: api-key
                  key: key
          volumeMounts:
            - name: secrets-volume
              mountPath: /etc/secrets
              readOnly: true
      volumes:
        - name: secrets-volume
          secret:
            secretName: apl-auth
```

ì‹¤ì œ ìƒì„±ëœ pod ì— ì ‘ì†í•´ ìƒì„±ëœ í™˜ê²½ë³€ìˆ˜ë¡œ íŒŒì¼ í™•ì¸  

```
$ kubectl apply -f Secrets/deployment.yaml
deployment.apps/secret-deployment created

$ kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
secret-deployment-65dd57cfb7-cq2jh   1/1     Running   0          5s
secret-deployment-65dd57cfb7-kcpmv   1/1     Running   0          5s
secret-deployment-65dd57cfb7-v9gql   1/1     Running   0          5s

$ kubectl exec -it secret-deployment-65dd57cfb7-cq2jh -- /bin/bash

root@~# env | grep SECRET*
SECRET_KEY=aBcD123
SECRET_ID=dbuser

root@~# ls /etc/secrets/
apl.crt

root@~# cat /etc/mtab | grep /etc/secrets
tmpfs /etc/secrets tmpfs ro,relatime 0 0
```

> `tmpfs`: ë©”ëª¨ë¦¬ ê¸°ë°˜ íŒŒì¼ ì‹œìŠ¤í…œ
















---
title:  "ì¿ ë²„ë„¤í‹°ìŠ¤ - íŒŒë“œ, ë¦¬í”Œë¦¬ì¹´ì…‹, ìŠ¤ì¼€ì¼ëŸ¬ë¹Œë¦¬í‹°!"

read_time: false
share: false
author_profile: false
classes: wide

categories:
  - docker
  - kubernetes

tags: kubernetes

toc: true

---

# íŒŒë“œ (Pod)

> Pod : ê³ ë˜ì˜ ë–¼(pod of whales)  

íŒŒë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ì‹¤í–‰ ë‹¨ìœ„, ì¿ ë²„ë„¤í‹°ìŠ¤ ê°ì²´ ëª¨ë¸ ì¤‘ ë§Œë“¤ê³  ë°°í¬í•  ìˆ˜ ìˆëŠ” ê°€ì¥ ì‘ê³  ê°„ë‹¨í•œ ë‹¨ìœ„.  

íŠ¹ì„±ì€ ì•„ë˜ì™€ ê°™ë‹¤.  

- íŒŒë“œì—ëŠ” í•˜ë‚˜ ì´ìƒì˜ ì»¨í…Œì´ë„ˆê°€ ë“¤ì–´ìˆë‹¤.  
- íŒŒë“œì•ˆì˜ ì»¨í…Œì´ë„ˆëŠ” ë°˜ë“œì‹œ ë™ì¼í•œ ë…¸ë“œì— ë°°ì¹˜ëœë‹¤.  
- ì–´í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤ì¼€ì¼ ì•„ì›ƒì€ íŒŒë“œë‹¨ìœ„ë¡œ ì´ë£¨ì–´ì§„ë‹¤.  
- íŒŒë“œì•ˆì˜ ì»¨í…Œì´ë„ˆëŠ” ë„¤íŠ¸ì›Œí¬ì™€ ìŠ¤í† ë¦¬ì§€ë¥¼ ê³µìœ í•œë‹¤.  

ë¦¬í”Œë¦¬ì¹´(`Replica`) - ë™ì¼í•œ êµ¬ì„±ìœ¼ë¡œ íŒŒë“œë¥¼ ì—¬ëŸ¬ê°œ ì‘ì„±í•˜ì—¬ ë°°ì¹˜í•˜ëŠ” ê²½ìš°  

## íŒŒë“œ - ë„¤íŠ¸ì›Œí¬  

ê° íŒŒë“œì—ëŠ” ê³ ìœ í•œ IP ì£¼ì†Œê°€ í• ë‹¹ë˜ë©° íŒŒë“œ ë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆëŠ” í•´ë‹¹ IP ë¥¼ ê³µìœ í•œë‹¤.  
ë•Œë¬¸ì— íŒŒë“œë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆëŠ” localhsot ë¥¼ í†µí•´ ì„œë¡œ í†µì‹ ê°€ëŠ¥í•˜ë‹¤.  

## íŒŒë“œ - ìŠ¤í† ë¦¬ì§€  

íŒŒë“œëŠ” ì»¨í…Œì´ë„ˆë¿ ì•„ë‹ˆë¼ ìŠ¤í† ë¦¬ì§€ë„ ê°€ì§€ê³  ìˆìœ¼ë©° ê³µìœ  ë³¼ë¥¨ì„ í†µí–‰ ì»¨í…Œì´ë„ˆë¼ë¦¬ ìŠ¤í† ë¦¬ì§€ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë‹¤.  

![kube2]({{ "/assets/2020/kube2.png" | absolute_url }})  


# íŒŒë“œ - ë§¤ë‹ˆí˜ìŠ¤íŠ¸ spec

íŒŒë“œì˜ ë‚´ìš©ì„ ì„¤ì •  

|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`containers` | `Container` ë°°ì—´ | íŒŒë“œì— ì†í•˜ëŠ” ì»¨í…Œì´ë„ˆ ëª©ë¡  
`imagepPullSecrets` | `LocalObjectReference` ë°°ì—´ | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ë“ì„ ìœ„í•œ ì¸ì¦ì •ë³´  
`initContainers` | `Container` ë°°ì—´ | ì´ˆê¸°í™” ì²˜ë¦¬ë¥¼ í•˜ëŠ” ì»¨í…Œì´ë„ˆ  
`nodeName` | ë¬¸ìì—´ | í•´ë‹¹ ë¼ë²¨ì˜ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜(ìŠ¤ì¼€ì¤„ë§)  
`nodeSelector` | `Object` | í•´ë‹¹ ë¼ë²¨ì˜ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜(ìŠ¤ì¼€ì¤„ë§)  
`priority` | ì •ìˆ˜ | íŒŒë“œì˜ ìš°ì„ ìˆœìœ„ ì§€ì •, í´ìˆ˜ë¡ ë†’ìŒ  
`restartPolicy` | ë¬¸ìì—´ | ì¬ì‹œì‘ ì •ì±…(`Always`, `OnFailure`, `Never`), ê¸°ë³¸ê°’ì€ `Always`  
`volumes` | `Volume` ë°°ì—´ |  íŒŒë“œì˜ ë§ˆìš´íŠ¸í•  ë³¼ë¥¨ ì§€ì •  

## Container

íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì†ì„±ì˜ `containers` ì— ë“¤ì–´ê°€ëŠ” ê°ì²´ ë°°ì—´ `Container` ì— ì–´ë–¤ ì†ì„±ì´ ìˆëŠ”ì§€ ì•Œì•„ë³´ì.  


|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`args` | ë¬¸ìë°°ì—´ | ì»¨í…Œì´ë„ˆì— ì†¡ì‹ í•  ì¸ìˆ˜  
`env` | `EnvVar` ë°°ì—´ | ì»¨í…Œì´ë„ˆì— ì„¤ì •í•œ í™˜ê²½ë³€ìˆ˜  
`image` | ë¬¸ìì—´ | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì™€ í•´ë‹¹ ê²½ë¡œ  
`imagePullPolicy` | ë¬¸ìì—´ | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ë“ì‹œ ê·œì¹™(`Always`, `ifNotPresent`, `Never`). ê¸°ë³¸ê°’ì€ `ifNotPresent` ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìƒˆë¡œ ì·¨ë“í•˜ì§€ ì•ŠëŠ”ë‹¤. `Always` ì„¤ì •ì‹œ í•­ìƒ ì´ë¯¸ì§€ ê°±ì‹   
`name` | ë¬¸ìì—´ | ì»¨í…Œì´ë„ˆ ì´ë¦„, ì»¨í…Œì´ë„ˆ ë‚´ë¶€ê°„ì— í†µì‹ í• ë•Œ ì‚¬ìš©(`DNS_LABEL`)  
`ports` | `ContainerPort` ë°°ì—´ | ì»¨í…Œì´ë„ˆ ê³µê°œíŒŒë“œ  
`resources` | `ResourceRequirements` | ì»¨í…Œì´ë„ˆì— CPU, Memory ê°™ì€ ë¦¬ì†ŒìŠ¤ í• ë‹¹  
`volumeMounts` | `VolumeMount` ë°°ì—´ | ì»¨í…Œì´ë„ˆ ë§ˆìš´íŠ¸ ë³¼ë¥¨ ì§€ì •  
`workingDir` | ë¬¸ìì—´ | ì‘ì—… ë””ë ‰í† ë¦¬  
`livenessProbe` | `Probe` | ì»¨í…Œì´ë„ˆ ê°ì‹œ  
`readlinessProbe` | `Probe` | ì»¨í…Œì´ë„ˆ ê°ì‹œ  

# kubectl íŒŒë“œ ì¡°ì‘  

## íŒŒë“œ ìƒì„± with private docker registry

`kubectl` ëª…ë ¹ìœ¼ë¡œ íŒŒë“œë¥¼ ì¡°ì‘í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.  

ë¨¼ì € ê°„ë‹¨í•œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  `private registry` ì— ë“±ë¡  

```
$ docker build -t photo-view:v2.0 .
$ docker image tag photo-view:v2.0 mydomain:5000/photo-view:v2.0

$ docker images
REPOSITORY                        TAG                 IMAGE ID            CREATED              SIZE
mydomain:5000/photo-view   v2.0                05e6c8ef4559        About a minute ago   924MB
photo-view                        v2.0                05e6c8ef4559        About a minute ago   924MB

$ docker image push mydomain:5000/photo-view:v2.0
```

> https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/

í•´ë‹¹ `private registry` ë¥¼ `kubectl` ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `secret` ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ ìƒì„±  

`docker login` ì„ í†µí•´ `$HOME/.docker/config.json` íŒŒì¼ì— ì¸ì¦ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ í›„ í•´ë‹¹ íŒŒì¼ë¡œ `secret` ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ì.  

```
$ kubectl create secret generic regcred \
--from-file=.dockerconfigjson=$HOME/.docker/config.json \
--type=kubernetes.io/dockerconfigjson
```

ë§¥ì˜ ê²½ìš° key ì •ë³´ê°€ config.json ì— ì €ì¥ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ ë³„ë„ì˜ í‚¤ì²´ì¸ì— ì €ì¥ë˜ì–´ ìˆì–´ ìœ„ì˜ ëª…ë ¹ì„ ì‚¬ìš©í•´ë´¤ì auth faild ì˜¤ë¥˜ê°€ ë°œìƒí• ê²ƒì´ë‹¤.  
ë§¥ì˜ ê²½ìš° ë°”ë¡œ `kubectl` ì— `secret` ìƒì„±í•˜ëŠ” ì•„ë˜ì˜ ëª…ë ¹ ì‚¬ìš©  

```
$ kubectl create secret docker-registry regcred \
--docker-server=mydomain:5000 \
--docker-username=admin \
--docker-password=admin
```

> `--namespace=''` ì˜µì…˜ì„ ìƒëµí–ˆê¸°ì— ê¸°ë³¸ì ìœ¼ë¡œ default ì— ì ìš©ëœë‹¤.  

í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ ê°„ë‹¨í•œ íŒŒë“œë¥¼ ìƒì„± 

```yaml
# pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: photoview-pod
  labels:
    app: photo-view
    env: stage
spec:
  containers:
  - image: mydomain:5000/photo-view:v2.0
    name: photoview-container
    ports:
    - containerPort: 80
  imagePullSecrets:
    - name: regcred # ìƒì„±í•œ secret name ì„¤ì • 
```

```
$ kubectl apply -f Pod/pod.yaml
pod/photoview-pod created

$ kubectl get pods --show-labels
NAME            READY   STATUS    RESTARTS   AGE     LABELS
photoview-pod   1/1     Running   0          2m13s   app=photo-view,env=stage

$ kubectl describe pods photoview-pod
// ìƒì„¸ì •ë³´ í™•ì¸ ê°€ëŠ¥
```

í•­ìƒ `imagePullSecrets`ë¥¼ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì— ì ìš©í•´ì•¼ë§Œ ë‹¤ìš´ì´ ê°€ëŠ¥í•œë° ì´ë¥¼ `service account` ì— í¬í•¨í•˜ì—¬ ìƒëµí•  ìˆ˜ ìˆë‹¤.  

```
$ kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "regcred"}]}'
```

## íŒŒë“œ ë³€ê²½  

ìƒˆë¡œìš´ ì´ë¯¸ì§€ `photo-view:v1.0` ì„ ë¹Œë“œ, íƒœê·¸, `private-registry` ì— `push`

```
$ docker build -t photo-view:v1.0 .
$ docker image tag photo-view:v1.0 mydomain:5000/photo-view:v1.0
$ docker image push mydomain:5000/photo-view:v1.0
```

ìœ„ì— ìƒì„±í•œ `photoview-pod`ì˜ ì´ë¯¸ì§€ë¥¼ `photo-view:v1.0` ë¡œ ë³€ê²½í•´ë³´ì.  

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì˜ `image` ì†ì„±ì„ ë³€ê²½  

```yaml
# pod.yaml
apiVersion: v1
kind: Pod
...
spec:
  containers:
  - image: mydomain:5000/photo-view:v1.0
  ...
...
```

```
$ kubectl apply -f Pod/pod.yaml
pod/photoview-pod configured
```

`apply` ëª…ë ¹ìœ¼ë¡œ ìƒì„±/ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë‹¤.  

íŒŒë“œ ì‚­ì œ  
```
$ kubectl delete -f Pod/pod.yaml
```


# íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ êµ¬ì¡°  


ìŠ¤ì¼€ì¤„ë§ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ ë§ˆìŠ¤í„° ì„œë²„ `API Server` ì—ì„œ ê´€ë¦¬í•œë‹¤.  
íŒŒë“œê°€ ë§ˆìŠ¤í„° ì„œë²„ì— ì˜í•´ ì–´ë–¤ ë…¸ë“œì— ì „ê°œ(ìŠ¤ì¼€ì¤„ë§)ë ì§€ ì•Œì•„ë³´ì.  


`API Server`ëŠ” í´ëŸ¬ìŠ¤í„° ì•ˆì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬(`CRUD`), etcd ì— ì ‘ê·¼ì§€ì› í•˜ê¸° ìœ„í•´ `Restfule` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§€ì›í•œë‹¤.  

íŒŒë“œê°€ ìƒì„±ë˜ëŠ” ë£¨í‹´ì€ ëŒ€ëµì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ë‹¤.  

1. `kubectl` ëª…ë ¹ ì‹¤í–‰ - `API Server` ì˜ `RestAPI` ìš”ì²­.  
2. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ì •ë³´ ê°±ì‹  - `kubectl` ë¡œ ì¸í•´ ë³€ê²½ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‚´ìš©ì„ `etcd` ì— ì €ì¥.  
3. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë³€ê²½ - ì ¼ë‹¬ë°›ì€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì™€ `etcd`ì˜ ë°ì´í„°ê°„ ë³€í™”ê°€ ìˆë‹¤ë©´ `API Server`ì—ê²Œ í†µì§€.  
4. íŒŒë“œì˜ ì‘ì„±  - `API Server`ê°€ í†µì§€ë°›ì€ ë‚´ìš©ì´ ìˆë‹¤ë©´ ì›Œì»¤ë…¸ë“œì— íŒŒë“œ ì—…ë°ì´íŠ¸ í•˜ë„ë¡ ëª…ë ¹ ì†¡ì‹ , ë…¸ë“œë‚´ì˜ `kubelet` ì€ ì „ë‹¬ë°›ì€ ëª…ë ¹ì„ ìˆ˜í–‰í•œë‹¤(ìƒˆë¡œìš´ íŒŒë“œ ìƒì„±).  


3ë²ˆê³¼ 4ë²ˆ ê³¼ì • ì‚¬ì´ì—ì„œ íŒŒë“œë¥¼ ì–´ë–¤ ë…¸ë“œì— ìŠ¤ì¼€ì¤„ë§í• ì§€ ê²°ì •í•œë‹¤.  

ìŠ¤ì¼€ì¤„ë§ì€ ì•„ë˜ 2ê°€ì§€ ê·œì¹™ì— ì˜í•´ ê²°ì •ëœë‹¤. 

1. ë…¸ë“œì˜ í•„í„°ë§   
   - íŒŒë“œì— NodeSelector ë¥¼ ì„¤ì •í•˜ê³  ìˆëŠ”ì§€ ê²€ì‚¬  
   - íŒŒë“œì— ì„¤ì •ëœ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì— ë§¤ì¹­ë˜ëŠ” ë…¸ë“œ í•„í„°ë§  
2. ë…¸ë“œì˜ ìš°ì„ ìˆœìœ„  
   - CPU, Memory ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë…¸ë“œì˜ ìš°ì„ ìˆœìœ„ ê²°ì •
   - ìš°ì„ ìˆœìœ„ë³„ë¡œ íŒŒë“œë¥¼ ë°°ì¹˜  


## Minikube ì—ì„œ ë…¸ë“œ ìƒì„±  

íŒŒë“œì™€ ë°˜ëŒ€ë¡œ ë…¸ë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ë‚´ì—ì„œ íƒ‘-ë ˆë²¨ ë¦¬ì†ŒìŠ¤ ì´ë‹¤.

í˜„ì¬ ìƒì„±ëœ ë…¸ë“œ í™•ì¸  

```
$ kubectl get nodes
NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   8d    v1.18.0

$ kubectl describe node  minikube
Name:               minikube
Roles:              master
...
...
```

`minikube` ë¥¼ í†µí•´ ìƒˆë¡œìš´ ê°€ìƒì˜ ë…¸ë“œ ì¶”ê°€  

```
$ minikube node help
ğŸ’¡  Usage: minikube node [add|start|stop|delete]

$ minikube node add
ğŸ˜„  ë…¸ë“œ m02 ë¥¼ í´ëŸ¬ìŠ¤í„° minikube ì— ì¶”ê°€í•©ë‹ˆë‹¤
ğŸ‘  Starting node m02 in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ¤·  docker "minikube" container is missing, will recreate.
ğŸ”¥  docker container (CPUs=2, Memory=1989MB, Disk=<no value>MB) ì— ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì„¤ì¹˜í•˜ëŠ” ì¤‘ ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.18.0 ì„ Docker 19.03.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ„  m02 ë¥¼ minikube ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤!

$ minikube node add
ğŸ˜„  ë…¸ë“œ m03 ë¥¼ í´ëŸ¬ìŠ¤í„° minikube ì— ì¶”ê°€í•©ë‹ˆë‹¤
ğŸ‘  Starting node m03 in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ”¥  docker container (CPUs=2, Memory=1989MB, Disk=<no value>MB) ì— ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì„¤ì¹˜í•˜ëŠ” ì¤‘ ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.18.0 ì„ Docker 19.03.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ„  m03 ë¥¼ minikube ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤!

$ docker ps
CONTAINER ID        IMAGE                                COMMAND                  CREATED             STATUS              PORTS                                                                           NAMES
c9e042c9462e        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   4 minutes ago       Up 4 minutes        127.0.0.1:32785->22/tcp, 127.0.0.1:32784->2376/tcp, 127.0.0.1:32783->8443/tcp   minikube
01a38df1ed4a        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   14 hours ago        Up 2 minutes        127.0.0.1:32791->22/tcp, 127.0.0.1:32790->2376/tcp, 127.0.0.1:32789->8443/tcp   minikube-m03
daaacf0b2652        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   14 hours ago        Up 3 minutes        127.0.0.1:32788->22/tcp, 127.0.0.1:32787->2376/tcp, 127.0.0.1:32786->8443/tcp   minikube-m02

$ kubectl get nodes --show-labels
NAME           STATUS   ROLES    AGE     VERSION   LABELS
minikube       Ready    master   5m47s   v1.18.0   beta....
minikube-m02   Ready    <none>   4m35s   v1.18.0   beta....
minikube-m03   Ready    <none>   2m56s   v1.18.0   beta....
```

> í˜¹ì‹œ ë…¸ë“œ ì„¤ì¹˜ê°„ ë¬¸ì œê°€ ìƒê²¼ë‹¤ë©´  
`$ minikube logs` ë¡œ í™•ì¸ í›„ ì—ëŸ¬ í™•ì¸    
https://stackoverflow.com/questions/56966721/minikube-failed-to-start-node-minikube-not-found  
`$ minikube stop && minikube delete`

ì´ë¯¸ ìˆ˜ë§ì€ `label` ì´ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ `minikube-m02` ë…¸ë“œì— `server=webap` ë¼ë²¨ì„ ì¶”ê°€í•œë‹¤.  

```
$ kubectl label node minikube-m02 server=webap
node/minikube-m02 labeled

$ kubectl get nodes --show-labels
NAME           STATUS   ROLES    AGE     VERSION   LABELS
minikube       Ready    master   5m47s   v1.18.0   beta....
minikube-m02   Ready    <none>   4m35s   v1.18.0   beta....,server=webap
minikube-m03   Ready    <none>   2m56s   v1.18.0   beta....
```

`minikube-m02`ë…¸ë“œì— ë¼ë²¨ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸ í›„  
`nodeSelector`ì†ì„±ì— ìœ„ì—ì„œ ì§€ì •í•œ `label` ì„ ì ìš©í•´ íŒŒë“œê°€ í•´ë‹¹ ë…¸ë“œì— ë§Œë“¤ì–´ì§€ë„ë¡ ì„¤ì •  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: stage
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    server: webap
```

ìƒì„±ëœ íŒŒë“œì˜ ë…¸ë“œê°€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì— ì„¤ì •í•œëŒ€ë¡œ `minikube-m02`ì— ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸.  

```
$ kubectl create -f Pod/labels-node.yaml
pod/nginx created

$ kubectl get pod --output=wide
NAME    READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
nginx   1/1     Running   0          23s   172.18.0.2   minikube-m02   <none>           <none>
```

> `kubectl creat/apply` ì°¨ì´: https://intellipaat.com/community/468/difference-between-kubectl-apply-and-kubectl-create  


## íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ ì œì–´  

ìœ„ì˜ `nodeSelector` ì†ì„±ì„ ì •ì˜í•´ ëª…ì‹œì ìœ¼ë¡œ ë…¸ë“œë¥¼ ì •í•´ì£¼ì§€ ì•Šê³ ë„ ìŠ¤ì¼€ì¤„ë§í•  ìˆ˜ìˆëŠ” ë°©ë²•ì´ ì—¬ëŸ¿ ìˆë‹¤.  

### Affinity

> https://kubernetes.io/ko/docs/concepts/configuration/assign-pod-node/#ì–´í”¼ë‹ˆí‹°-affinity-ì™€-ì•ˆí‹°-ì–´í”¼ë‹ˆí‹°-anti-affinity

`Affinity` ëŠ” ì¹œë°€ê°ì´ë€ ëœ»ìœ¼ë¡œ ì„œë¡œë‹¤ë¥¸ 2ê°œì˜ íŒŒë“œë¥¼ ì™ ë§Œí•˜ë©´ ê°™ì€ë…¸ë“œì— ë°°ì¹˜ì‹œí‚¤ê³  ì‹¶ì„ë•Œ(`podAffinity`)  
í˜¹ì€ ë‹¤ë¥¸ë…¸ë“œì— ë°°ì¹˜ì‹œí‚¤ê³  ì‹¶ì„ë•Œ(`podAntiAffinity`) ì‚¬ìš©í•œë‹¤.  

ë˜í•œ íŠ¹ì • ì¡°ê±´ì„ ê°–ì¶˜ ë…¸ë“œì—ì„œë§Œ ë™ì‘í•˜ë„ë¡ í•˜ëŠ” `nodeAffinity` ë„ ìˆë‹¤.  


### Taints, Tolerations

> https://kubernetes.io/ko/docs/concepts/configuration/taint-and-toleration/

> Taints: ì˜¤ì—¼ì‹œí‚¤ë‹¤
> Tolerations: ìš©ì¸,ê´€ìš©

ì„œë¡œ ìƒë°˜ë˜ëŠ” ì—­í• ì„ í•˜ëŠ” ëª…ë ¹  

`Taints`ëŠ” ë…¸ë“œì— ì„¤ì •í•˜ëŠ” ê²ƒìœ¼ë¡œ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¤„ë§ í•˜ê±°ë‚˜ ì¡°ê±´ì— ë§ëŠ” íŒŒë“œë§Œ ìŠ¤ì¼€ì¤„ë§ í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.  
`Taints`ê°€ ì„¤ì •ëœ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜í•˜ê³  ì‹¶ë‹¤ë©´ `Tolerations` ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.  


## ë…¸ë“œì˜ CPU, Memory ë¦¬ì†ŒìŠ¤ í™•ì¸  

`kubectl describe` ëª…ë ¹ìœ¼ë¡œ `node` ì˜ ë¦¬ì†ŒìŠ¤ ë° ìƒì„¸ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  


```
$ kubectl describe node  minikube
Name:               minikube
Roles:              master
Labels:             beta.kubernetes.io/arch=amd64
                    ...
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    ...
CreationTimestamp:  Fri, 24 Apr 2020 09:51:25 +0900
Taints:             <none>
Unschedulable:      false
Lease:
  HolderIdentity:  minikube
  AcquireTime:     <unset>
  RenewTime:       Fri, 24 Apr 2020 10:17:48 +0900
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Fri, 24 Apr 2020 10:16:44 +0900   Fri, 24 Apr 2020 09:51:21 +0900   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Fri, 24 Apr 2020 10:16:44 +0900   Fri, 24 Apr 2020 09:51:21 +0900   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Fri, 24 Apr 2020 10:16:44 +0900   Fri, 24 Apr 2020 09:51:21 +0900   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Fri, 24 Apr 2020 10:16:44 +0900   Fri, 24 Apr 2020 09:51:39 +0900   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  172.17.0.2
  Hostname:    minikube
Capacity:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             2037260Ki
  pods:               110
Allocatable:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             2037260Ki
  pods:               110
System Info:
  Machine ID:                 6b32bc7470d6492092cde0ca7a683eb8
  System UUID:                b1cea2e9-5445-49e4-a44c-46eaed5fafa9
  Boot ID:                    c1b830e3-1bda-41bc-8e9d-fc9cd9db4a76
  Kernel Version:             4.19.76-linuxkit
  OS Image:                   Ubuntu 19.10
  Operating System:           linux
  Architecture:               amd64
  Container Runtime Version:  docker://19.3.2
  Kubelet Version:            v1.18.0
  Kube-Proxy Version:         v1.18.0
PodCIDR:                      10.244.0.0/24
PodCIDRs:                     10.244.0.0/24
Non-terminated Pods:          (9 in total)
  Namespace                   Name                                CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                   ----                                ------------  ----------  ---------------  -------------  ---
  kube-system                 coredns-66bff467f8-5lkpn            100m (2%)     0 (0%)      70Mi (3%)        170Mi (8%)     26m
  kube-system                 coredns-66bff467f8-tmfwr            100m (2%)     0 (0%)      70Mi (3%)        170Mi (8%)     26m
  kube-system                 etcd-minikube                       0 (0%)        0 (0%)      0 (0%)           0 (0%)         26m
  kube-system                 kindnet-pc7k4                       100m (2%)     100m (2%)   50Mi (2%)        50Mi (2%)      26m
  kube-system                 kube-apiserver-minikube             250m (6%)     0 (0%)      0 (0%)           0 (0%)         26m
  kube-system                 kube-controller-manager-minikube    200m (5%)     0 (0%)      0 (0%)           0 (0%)         26m
  kube-system                 kube-proxy-k2mfd                    0 (0%)        0 (0%)      0 (0%)           0 (0%)         26m
  kube-system                 kube-scheduler-minikube             100m (2%)     0 (0%)      0 (0%)           0 (0%)         26m
  kube-system                 storage-provisioner                 0 (0%)        0 (0%)      0 (0%)           0 (0%)         26m
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests    Limits
  --------           --------    ------
  cpu                850m (21%)  100m (2%)
  memory             190Mi (9%)  390Mi (19%)
  ephemeral-storage  0 (0%)      0 (0%)
  hugepages-1Gi      0 (0%)      0 (0%)
  hugepages-2Mi      0 (0%)      0 (0%)
Events:
  ...
```

`CPU`, `Memory` ë¦¬ì†ŒìŠ¤ëŠ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ì„¤ì • ê°€ëŠ¥í•˜ë‹¤.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: requests-pod

spec:
  containers:
  - image: busybox
    command: ["dd", "if=/dev/zero", "of=/dev/null"]
    name: main
    resources:
      requests:
        cpu: 50m
        memory: 300Mi # (K M G T P), (Ki Mi Gi Ti Pi) ì‚¬ìš© ê°€ëŠ¥
```

`Minikube` ì—ì„œ ìƒì„±ëœ `node` ì˜ `CPU Limits` ëŠ” `100m`, `Memory Limits`ëŠ” `390Mi`ë‚¨ì•„ìˆë‹¤.
ìœ„ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì„¤ì •ëŒ€ë¡œ íŒŒë“œë¥¼ ìƒì„±í•˜ê³  ì¤„ì–´ë“œëŠ” `Limits` ë¥¼ í™•ì¸  

`requests` ì†ì„±ì„ íŒŒë“œì˜ ìµœì†Œ ë¦¬ì†ŒìŠ¤ ìš”ì²­ ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.  

```
$ kubectl create -f Pod/pod-request.yaml
pod/requests-pod created 

$ kubectl get pods --output wide
NAME           READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
requests-pod   1/1     Running   0          39s   172.18.0.2   minikube-m03   <none>           <none>
```

`$ kubectl describe node minikube-m03` ëª…ë ¹ìœ¼ë¡œ ë‚¨ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•´ë³´ë©´ ì •í™•ì¸ `CPU 50m`, `Memory 300Mi` ë§Œí¼ `Limits` ê°€ ì¤„ì–´ìˆë‹¤.   

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¤„ë§í• ë•Œ ì‹¤ì œ ë…¸ë“œì˜ ë¦¬ì†ŒìŠ¤ì‚¬ìš©ëŸ‰ì´ ì•„ë‹Œ ë©”ë‹ˆí˜ìŠ¤íŠ¸ì— ì„¤ì •ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì •ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ ë¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.  
íŒŒë“œì— ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í• ë‹¹í•˜ê²Œ ë˜ë©´ ê·¸ë§Œí¼ ë‹¤ë¥¸ íŒŒë“œë¥¼ ë…¸ë“œì— ì„¤ì •í•  ìˆ˜ ì—†ë‹¤.

ë§Œì•½ íŒŒë“œì— ì„¤ì •í•œ `resources` ì‚¬ìš©ëŸ‰ì„ ë„˜ê²Œë˜ë©´ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: limits-pod
spec:
  containers:
  - name: main
    image: polinux/stress
    resources:
      limits:
        cpu: 90m
        memory: 300Mi
    command: ["stress"]
    args: ["--vm", "1", "--vm-bytes", "500M", "--vm-hang", "1"]
```
`stress` í”„ë¡œê·¸ë¨ìœ¼ë¡œ `Memory`ì— `300M`ë¥¼ ë„˜ëŠ” `500M` ë¥¼ ì„¤ì •í•˜ì—¬ ì‹¤í–‰  

`limits` ì†ì„±ì€ íŒŒë“œ ìš”ì²­ ì œí•œ ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.  

```
$ kubectl get pods --output wide
NAME         READY   STATUS              RESTARTS   AGE   IP       NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     ContainerCreating   0          6s    <none>   minikube-m03   <none>           <none>

$ kubectl get pods --output wide
NAME         READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   1/1     Running   0          9s    172.18.0.2   minikube-m03   <none>           <none>

$ kubectl get pods --output wide
NAME         READY   STATUS      RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     OOMKilled   0          9s    172.18.0.2   minikube-m03   <none>           <none>

$ kubectl get pods --output wide
NAME         READY   STATUS             RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     CrashLoopBackOff   2          43s   172.18.0.2   minikube-m03   <none>           <none>
```

`$ kubectl describe pod limits-pod`ë¡œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸ê°€ëŠ¥í•˜ë‹¤.  

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„  ë³µêµ¬ê¸°ëŠ¥ì„ ê°–ê³  ìˆê¸°ì— ì˜¤ë¥˜ê°€ ê°ì§€ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì‹œì‘í•œë‹¤.  
`restartPolicy`ì†ì„± ì— ë”°ë¼ ì˜µì…˜ì´ ë‹¤ë¥´ë©° ê¸°ë³¸ê°’ì€ `Always` ì´ë‹¤.  

```
$ kubectl get pods --output wide
NAME         READY   STATUS             RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     CrashLoopBackOff   6          7m15s   172.18.0.2   minikube-m03   <none>           <none>
```

ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ `RESTARTS` íšŸìˆ˜ê°€ ê³„ì† ëŠ˜ì–´ë‚˜ê³  ìˆë‹¤.  

## íŒŒë“œ ê°ì‹œ  

íŒŒë“œê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€, íŒŒë“œ ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤ê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ ê°ì‹œ í•˜ê¸° ìœ„í•´  
ë©”ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ `livenessProbe` ì†ì„±ì„ ì¶”ê°€í•œë‹¤.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-http

spec:
  containers:
  - name: liveness
    image: k8s.gcr.io/liveness
    args:
    - /server
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
        httpHeaders:
        - name: X-Custom-Header
          value: Awesome
      initialDelaySeconds: 10
      periodSeconds: 5
```

`livenessProbe` ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì— `/healthz` URI ì— 5ì´ˆì£¼ê¸°(`periodSeconds`)ë¡œ ìš”ì²­ì„ ë‚ ë¦¬ê³  `200` ~ `400` ì‚¬ì´ì˜ ê°’ì´ ë°˜í™˜ë  ê²½ìš° ì •ìƒìœ¼ë¡œ ê°„ì£¼í•œë‹¤.  
ê·¸ ì´ì™¸ì˜ ê°’ì´ ë°˜í™˜ë  ê²½ìš° `kublet` ì— ì˜í•´ ì»¨í…Œì´ë„ˆê°€ ì¬ì‹œì‘ ëœë‹¤.  

ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œ ê¹Œì§€ì˜ í…€(`initialDelaySeconds`)ì„ 10ì´ˆë¡œ ì„¤ì •í•œë‹¤.

`k8s.gcr.io/liveness` ì´ë¯¸ì§€ì—ëŠ” 10ì´ˆë™ì•ˆë§Œ `status code 200` ì„ ë°˜í™˜í•˜ê³  ê·¸ ì´í›„ë¡œëŠ” `status code 500`ì„ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •ë˜ì–´ìˆë‹¤.  

10ì´ˆ í›„ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ 
```
$ kubectl get pods --output wide
$ kubectl describe pod liveness-http
```

`CrashLoopBackOff` ìƒíƒœê°’ê³¼ ë¡œê·¸ì— `Liveness probe failed: HTTP probe failed with statuscode: 500` ê°€ ì°í˜€ìˆëŠ”ê±¸ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.  

> http ë¥¼ í†µí•œ íŒŒë“œ ìƒíƒœí™•ì¸ ì™¸ì—ë„ tcpì†Œì¼“, ëª…ë ¹ ì‹¤í–‰ ë“±ì„ í†µí•´ì„œë„ ìƒíƒœí™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤. 
> https://kubernetes.io/ko/docs/concepts/workloads/pods/pod-lifecycle/#ì»¨í…Œì´ë„ˆ-í”„ë¡œë¸Œ-probe


# ë¦¬í”Œë¦¬ì¹´ì…‹

ë¦¬í”Œë¦¬ì¹´ì…‹ì€ íŒŒë“œì˜ ìˆ˜ë¥¼ ìœ ì§€í•˜ëŠ” ì¥ì¹˜ì´ë‹¤.  
íŒŒë“œê°€ ìë™ìœ¼ë¡œ RESTART í•˜ë©° ìƒíƒœë¥¼ ë³µêµ¬í•˜ëŠ” ê²ƒì´ë¼ë©´

íŒŒë“œê°€ ì •ì§€ëœ ê²½ìš° ë¦¬í”Œë¦¬ì¹´ì…‹ì´ ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ íŒŒë“œë¥¼ ì‹œì‘í•œë‹¤.  

## ë¦¬í”Œë¦¬ì¹´ì…‹ spec

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê¸°ë³¸ êµ¬ì„±ì€ íŒŒë“œì™€ ê°™ë‹¤.  
`spec` ë¶€ë¶„ë§Œ ë‹¤ë¥¸ë¶€ë¶„ì´ ìˆëŠ”ë° ì•Œì•„ë³´ì.  

|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`replicas`|ì •ìˆ˜|í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ê°€ë™ì‹œí‚¬ íŒŒë“œì˜ ìˆ˜(ê¸°ë³¸ê°’ 1)
`selector`|`LabelSelector`|ì–´ë–¤ íŒŒë“œë¥¼ ê°€ë™í• ì§€ ì •ì˜, íŒŒë“œì˜ `template.metadata.label` ì— ì„¤ì •ëœ ê°’ê³¼ ì¼ì¹˜í•´ì•¼í•¨
`template`|`PodTemplateSpec`|ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ íŒŒë“œ ìˆ˜ê°€ `replicas` ì— ì„¤ì •ëœ ìˆ˜ë³´ë‹¤ ì ì„ë•Œ ìƒˆë¡œì‘ì„±ë˜ëŠ” íŒŒë“œ**ì˜ í…œí”Œë¦¿**
`template.metadata`|`Object`|í…œí”Œë¦¿ì˜ ì´ë¦„, `Label`ê³¼ ê°™ì€ ë©”íƒ€ë°ì´í„° 
`template.spec`|`PodSpec`|íŒŒë“œì˜ ìƒì„¸ì •ë³´ë¥¼ ì„¤ì •  

ì¦‰ ë¦¬í”Œë¦¬ì¹´ì…‹ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ `spec` ê³¼ íŒŒë“œì˜ `spec` ì„ ëª¨ë‘ ì •ì˜í•´ì•¼í•œë‹¤.  

## kubectl ë¦¬í”Œë¦¬ì¹´ì…‹ ì¡°ì‘  

```yaml
# ReplicaSet/replicaset.yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: photoview-rs
spec:
  replicas: 5
  selector:
    matchLabels:
      app: photoview
  template:
    metadata:
      labels:
        app: photoview
        env: prod
    spec:
      containers:
      - image: mydomain:5000/photo-view:v1.0
        name: photoview-container
        ports:
          - containerPort: 80
```


```
$ kubectl create -f ReplicaSet/replicaset.yaml
$ kubectl get pods --show-labels
NAME                 READY   STATUS    RESTARTS   AGE     LABELS
photoview-rs-466w6   1/1     Running   0          3h35m   app=photoview,env=prod
photoview-rs-fwv2f   1/1     Running   0          3h35m   app=photoview,env=prod
photoview-rs-j46rr   1/1     Running   0          3h40m   app=photoview,env=prod
photoview-rs-n64z2   1/1     Running   0          3h35m   app=photoview,env=prod
photoview-rs-zk4bz   1/1     Running   0          3h35m   app=photoview,env=prod
```

ìˆ˜ì •ê³¼ ì‚­ì œëŠ” ì•„ë˜ ëª…ë ¹ ì°¸ê³   
`yaml` íŒŒì¼ì„ ìˆ˜ì • í›„ `apply` í•˜ë©´ ê¸°ì¡´ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ ì„¤ì •ì´ ìë™ ìˆ˜ì •/ì ìš© ëœë‹¤.  

```
$ kubectl apply -f ReplicaSet/replicaset.yaml
$ kubectl delete -f ReplicaSet/replicaset.yaml
``` 

ë¦¬í”Œë¦¬ì¹´ì…‹ì€ ì² ì €íˆ `metadata.labels.app` ì„ í†µí•´ì„œ ê´€ë¦¬ëœë‹¤.  

ë¨¼ì € ë¼ë²¨ëª…ì´ `photo-view` ì¸ **íŒŒë“œ** ë¥¼ í•˜ë‚˜ ìƒì„±  

```
$ kubectl apply -f ReplicaSet/pod-nginx.yaml
pod/nginx-pod created

$ kubectl get pod
NAME        READY   STATUS    RESTARTS   AGE
nginx-pod   1/1     Running   0          27s
```

ê·¸ë¦¬ê³  ë¦¬í”Œë¦¬ì¹´ì…‹ìœ¼ë¡œ `photo-view` ë¼ë²¨ì„ ê°€ì§„ íŒŒë“œ 5ê°œë¥¼ ìƒì„±í•˜ë„ë¡í•œë‹¤.  

```
$ kubectl apply -f ReplicaSet/replicaset-nginx.yaml
replicaset.apps/nginx-replicaset created

$ kubectl get pod
NAME                     READY   STATUS              RESTARTS   AGE
nginx-pod                1/1     Running             0          79s
nginx-replicaset-cg8l7   0/1     ContainerCreating   0          2s
nginx-replicaset-hgkkd   0/1     ContainerCreating   0          2s
nginx-replicaset-kg5ks   0/1     ContainerCreating   0          2s
nginx-replicaset-p2w5f   0/1     ContainerCreating   0          2s
```

ê¸°ì¡´ì— íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¡œ ìƒì„±í–ˆë˜ `nginx-pod` íŒŒë“œì™€ í•¨ê»˜ 4ê°œì˜ ì¶”ê°€ íŒŒë“œê°€ ìƒì„±ëœë‹¤.  


# ìŠ¤ì¼€ì¼ëŸ¬ë¹Œë¦¬í‹°

ìˆœê°„ì ìœ¼ë¡œ ë§ì€ì–‘ì˜ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš° ì‹œìŠ¤í…œ ì²˜ë¦¬ëŠ¥ë ¥ì„ ë†’ì´ëŠ” ë°©ë²•  

ì‹œìŠ¤í…œ ì²˜ë¦¬ëŠ¥ë ¥ì„ ë†’ì´ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆë‹¤.  

- ìŠ¤ì¼€ì¼ ì•„ì›ƒ(ìˆ˜í‰ ìŠ¤ì¼€ì¼): ì‹œìŠ¤í…œ êµ¬ì„± ì„œë²„ ëŒ€ìˆ˜ë¥¼ ëŠ˜ë¦¼ìœ¼ë¡œ ì²˜ë¦¬ëŠ¥ë ¥ í–¥ìƒ, ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì¶”ê°€í•´ì•¼ í•˜ë©° ì‹œìŠ¤í…œì˜ ê°€ìš©ì„±ì´ ë†’ì•„ì§„ë‹¤.  
- ìŠ¤ì¼€ì¼ ì—…(ìˆ˜ì§ ìŠ¤ì¼€ì¼): ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤(CPU, Memory) ë¥¼ ì¦ê° ì‹œì¼œ ì²˜ë¦¬ëŠ¥ë ¹ í–¥ìƒ  

ìˆ˜ì§ì´ë˜ ìˆ˜í‰ì´ë˜ íŒŒë“œì™€ ë…¸ë“œë‹¨ìœ„ë¡œ ìŠ¤ì¼€ì¼(ì²˜ë¦¬ëŠ¥ë ¹ í–¥ìƒ) ê°€ëŠ¥í•˜ë‹¤.  

ì²˜ë¦¬ëŸ‰ì˜ ì¦ê°€ì •ë„ì— ë”°ë¼ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¼í• ì§€ ë…¸ë“œë¥¼ ìŠ¤ì¼€ì¼í• ì§€ ê²°ì •í•œë‹¤.  

## íŒŒë“œ ìˆ˜ë™ ìˆ˜í‰ ìŠ¤ì¼€ì¼ (`kubectl scale`)  

`kubectl scale` ëª…ë ¹ìœ¼ë¡œ íŒŒë“œ ìŠ¤ì¼€ì¼ì„ ëŠ˜ë¦´ ìˆ˜ ìˆë‹¤.  

ë¦¬í”Œë¦¬ì¹´ì…‹ìœ¼ë¡œ `nginx` íŒŒë“œë¥¼ 3ê°œ ìƒì„±  

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-replicaset
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
    spec:
      containers:
      - image: nginx
        name: photoview-container
```


```
$ kubectl apply -f HPA/pod-scale.yaml
replicaset.apps/nginx-replicaset created

$ kubectl scale --replicas=8 rs/nginx-replicaset
replicaset.apps/nginx-replicaset scaled

$ kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
nginx-replicaset-4bv5g   1/1     Running   0          19s
nginx-replicaset-4cjjq   1/1     Running   0          19s
nginx-replicaset-5z9qk   1/1     Running   0          19s
nginx-replicaset-bt98h   1/1     Running   0          19s
nginx-replicaset-c5fkk   1/1     Running   0          2m29s
nginx-replicaset-hnv8w   1/1     Running   0          2m29s
nginx-replicaset-nxtcn   1/1     Running   0          19s
nginx-replicaset-zbsd6   1/1     Running   0          2m29s
```
<!-- 
## íŒŒë“œ ìë™ ìˆ˜í‰ ìŠ¤ì¼€ì¼ (`HorizontalPodAutoscaler`)

`kubectl scale` ëª…ë ¹ìœ¼ë¡œ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤ì¼€ì¼í•˜ì˜€ë‹¤ë©´ `HorizontalPodAutoscaler` ì¿ ë²„ë„¤í‹°ìœ¼ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ ìë™ìœ¼ë¡œ ìˆ˜í‰ ìŠ¤ì¼€ì¼ ê°€ëŠ¥í•˜ë‹¤.

ì¿ ë²„ëŠ” `CPU` ì‚¬ìš©ë¥ , ê¸°íƒ€ ë©”íŠ¸ë¦­ì„ ì²´í¬í•´ íŒŒë“œ ìŠ¤ì¼€ì¼ì´ ê°€ëŠ¥í•˜ë‹¤.  


> ë¦¬í”Œë¦¬ì¹´ì…‹ ì™¸ì—ë„ ê°ì¢… ë¦¬ì†ŒìŠ¤ì— ìŠ¤ì¼€ì¼ë§ ê°€ëŠ¥í•˜ë‹¤.  
- `RelicaSet`
- `Deployment`
- `Relication Controller`
- `StatefuleSet`

ë¨¼ì € ìŠ¤ì¼€ì¼ì „ì˜ ë¦¬í”Œë¦¬ì¹´ì…‹ì„ ìƒì„±í•œë‹¤.  

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: busy-replicaset
spec:
  replicas: 2
  selector:
    matchLabels:
      app: busy
  template:
    metadata:
      labels:
        app: busy
    spec:
      containers:
      - image: busybox
        name: hpa-container
        command: ["dd", "if=/dev/zero", "of=/dev/null"]
        resources:
          requests:
            cpu: 100m
          limits:
            cpu: 100m
```

ìë™ ìŠ¤ì¼€ì¼ì„ ìœ„í•´ì„  `requests`, `limits` ì†ì„±ì„ ë‘˜ë‹¤ ì„¤ì •í•  í•„ìš”ê°€ ìˆë‹¤.  
ë‚´ë¶€ì—ì„œ dd ëª…ë ¹ì„ í†µí•´ `limits` ì¸ `100m` ë§Œí¼ì˜ ì½”ì–´ê°€ ë˜ì–´ìˆë‹¤.  

```
$ kubectl apply -f HPA/replicaset-hpa.yaml
replicaset.apps/busy-replicaset created

$ kubectl get pod --show-labels
NAME                    READY   STATUS    RESTARTS   AGE   LABELS
busy-replicaset-w97wr   1/1     Running   0          35s   app=busy
busy-replicaset-z5sh8   1/1     Running   0          35s   app=busy

$ kubectl top pod
Error from server (NotFound): the server could not find the requested resource (get services http:heapster:)
```

`get services http:heapster` ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš© ëª»í•˜ëŠ”ë° `metrics-server` ì—ë“œì˜¨ì„ `enable` í•´ì£¼ë©´ ëœë‹¤.  

```
$ minikube addons list
|-----------------------------|----------|--------------|
|         ADDON NAME          | PROFILE  |    STATUS    |
|-----------------------------|----------|--------------|
| dashboard                   | minikube | disabled     |
| default-storageclass        | minikube | enabled âœ…   |
| efk                         | minikube | disabled     |
| freshpod                    | minikube | disabled     |
| gvisor                      | minikube | disabled     |
| helm-tiller                 | minikube | disabled     |
| ingress                     | minikube | disabled     |
| ingress-dns                 | minikube | disabled     |
| istio                       | minikube | disabled     |
| istio-provisioner           | minikube | disabled     |
| logviewer                   | minikube | disabled     |
| metrics-server              | minikube | disabled     |
| nvidia-driver-installer     | minikube | disabled     |
| nvidia-gpu-device-plugin    | minikube | disabled     |
| registry                    | minikube | disabled     |
| registry-aliases            | minikube | disabled     |
| registry-creds              | minikube | disabled     |
| storage-provisioner         | minikube | enabled âœ…   |
| storage-provisioner-gluster | minikube | disabled     |
|-----------------------------|----------|--------------|

$ minikube addons enable metrics-server
$ minikube addons open metrics-server
```
```
kubectl get pods
NAME                    READY   STATUS    RESTARTS   AGE
busy-replicaset-8tgtp   1/1     Running   0          16s
busy-replicaset-nllr8   1/1     Running   0          16s
```

ì´ ìƒíƒœì—ì„œ ìë™ ìŠ¤ì¼€ì¼ ê°€ëŠ¥í•˜ë„ë¡ `HorizontalPodAutoscaler` ë¦¬ì†ŒìŠ¤ë¥¼ ì‘ì„±  

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: budy-hpa
spec:
  minReplicas: 1   # ìµœì†Œ ë¦¬í”Œë¦¬ì¹´ ìˆ˜
  maxReplicas: 5   # ìµœëŒ€ ë¦¬í”Œë¦¬ì¹´ ìˆ˜
  metrics:
  - resource:
      name: cpu
      targetAverageUtilization: 30  # CPU ê°€ 30% ë˜ë„ë¡ ì¡°ì •
    type: Resource
  scaleTargetRef:
    apiVersion: apps/v1
    kind: ReplicaSet
    name: busy-replicaset
```

`HorizontalPodAutoscaler` ë¦¬ì†ŒìŠ¤ `spec`ì˜ ì£¼ì˜í• ì ì€  `minReplicas`, `maxReplicas`, `metrics`, `scaleTargetRef`

`metrics`: ìŠ¤ì¼€ì¼ í•˜ê¸°ìœ„í•œ ë©”í”„ë¦­ ì„¤ì •  
`scaleTargetRef`: ìë™ìŠ¤ì¼€ì¼ ëŒ€ìƒ ë¦¬ì†ŒìŠ¤(í˜„ì¬ ë¦¬í”Œë¦¬ì¹´ì…‹)ë¥¼ ê²°ì •í•œë‹¤.  
kub
 -->
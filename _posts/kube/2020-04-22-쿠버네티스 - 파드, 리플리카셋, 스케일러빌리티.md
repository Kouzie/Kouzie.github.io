---
title:  "ì¿ ë²„ë„¤í‹°ìŠ¤ - íŒŒë“œ, ë¦¬í”Œë¦¬ì¹´ì…‹, ë””í”Œë¡œì´ë¨¼íŠ¸, ìŠ¤ì¼€ì¼ëŸ¬ë¹Œë¦¬í‹°!"

read_time: false
share: false
author_profile: false
toc: true
toc_sticky: true
# classes: wide

categories:
  - kubernetes

---

# íŒŒë“œ (Pod)

> Pod : ê³ ë˜ì˜ ë–¼(pod of whales)  

íŒŒë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ì‹¤í–‰ ë‹¨ìœ„, ì¿ ë²„ë„¤í‹°ìŠ¤ ê°ì²´ ëª¨ë¸ ì¤‘ ë§Œë“¤ê³  ë°°í¬í•  ìˆ˜ ìˆëŠ” ê°€ì¥ ì‘ê³  ê°„ë‹¨í•œ ë‹¨ìœ„.  

**íŠ¹ì„±**  
- íŒŒë“œì—ëŠ” í•˜ë‚˜ ì´ìƒì˜ ì»¨í…Œì´ë„ˆê°€ ë“¤ì–´ìˆë‹¤.  
- íŒŒë“œì•ˆì˜ ì»¨í…Œì´ë„ˆëŠ” ë°˜ë“œì‹œ ë™ì¼í•œ ë…¸ë“œì— ë°°ì¹˜ëœë‹¤.  
- ì–´í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤ì¼€ì¼ ì•„ì›ƒì€ íŒŒë“œë‹¨ìœ„ë¡œ ì´ë£¨ì–´ì§„ë‹¤.  
- íŒŒë“œì•ˆì˜ ì»¨í…Œì´ë„ˆëŠ” ë„¤íŠ¸ì›Œí¬ì™€ ìŠ¤í† ë¦¬ì§€ë¥¼ ê³µìœ í•œë‹¤.  
- ê° íŒŒë“œì—ëŠ” ê³ ìœ í•œ IP ì£¼ì†Œê°€ í• ë‹¹ë˜ë©° íŒŒë“œ ë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆëŠ” í•´ë‹¹ IP ë¥¼ ê³µìœ í•œë‹¤.  
- íŒŒë“œëŠ” ì»¨í…Œì´ë„ˆë¿ ì•„ë‹ˆë¼ ìŠ¤í† ë¦¬ì§€ë„ ê°€ì§€ê³  ìˆìœ¼ë©° ê³µìœ  ë³¼ë¥¨ì„ í†µí–‰ ì»¨í…Œì´ë„ˆë¼ë¦¬ ìŠ¤í† ë¦¬ì§€ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë‹¤.  

![kube2](/assets/kube/kube2.png){: .shadow}  

**ìƒëª…ì£¼ê¸°**  
1. `Pending` - íŒŒë“œ ìƒì„±ì¤‘(ì´ë¯¸ì§€ ë‹¤ìš´, ì»¨í…Œì´ë„ˆ ìƒì„±ì¤‘)  
2. `Running` - íŒŒë“œì•ˆ ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ì¤‘, ì‹œì, ì¬ì‹œì‘ ì¤‘  
3. `Succeeded` - íŒŒë“œì•ˆ ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì¢…ë£Œ ì™„ë£Œ  
4. `Failed` - íŒŒë“œì•ˆ ì»¨í…Œì´ë„ˆì¤‘ ë¹„ì •ìƒ ì¢…ë£Œ  
5. `Unknown` - íŒŒë“œì˜ ìƒíƒœ í™•ì¸ ë¶ˆê°€, ë…¸ë“œ í†µì‹  ë¶ˆê°€ì‹œ ë°œìƒ  

ìƒëª…ì£¼ê¸°ëŠ” `kubelet` ì´ ì»¨í…Œì´ë„ˆë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì§„ë‹¨í•œë‹¤.  


## ë§¤ë‹ˆí˜ìŠ¤íŠ¸  

ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì†ì„± ì¢…ë¥˜ ë° ì„¤ëª… ê²€ìƒ ê°€ëŠ¥  
  
```
$ kubectl explain pods
$ kubectl explain pods.metadata
$ kubectl explain pods --recursive
```

### pods.spec   


|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`pods.spec.containers` | `Container[]` | íŒŒë“œì— ì†í•˜ëŠ” ì»¨í…Œì´ë„ˆ ëª©ë¡  
`pods.spec.imagePullSecrets` | `LocalObjectReference[]` | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ë“ì„ ìœ„í•œ ì¸ì¦ì •ë³´  
`pods.spec.initContainers` | `Container[]` | ì´ˆê¸°í™” ì²˜ë¦¬ë¥¼ í•˜ëŠ” ì»¨í…Œì´ë„ˆ  
`pods.spec.nodeName` | `String` | í•´ë‹¹ ë¼ë²¨ì˜ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜(ìŠ¤ì¼€ì¤„ë§)  
`pods.spec.nodeSelector` | `Object` | í•´ë‹¹ ë¼ë²¨ì˜ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜(ìŠ¤ì¼€ì¤„ë§)  
`pods.spec.priority` | `Integer` | íŒŒë“œì˜ ìš°ì„ ìˆœìœ„ ì§€ì •, í´ìˆ˜ë¡ ë†’ìŒ  
`pods.spec.restartPolicy` | `String` | ì¬ì‹œì‘ ì •ì±…(`Always`, `OnFailure`, `Never`), ê¸°ë³¸ê°’ì€ `Always`  
`pods.spec.volumes` | `Volume[]` |  íŒŒë“œì˜ ë§ˆìš´íŠ¸í•  ë³¼ë¥¨ ì§€ì •  

### pods.spec.containers

íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì†ì„±ì˜ `containers` ì— ë“¤ì–´ê°€ëŠ” ê°ì²´ ë°°ì—´ `Container` ì— ì–´ë–¤ ì†ì„±ì´ ìˆëŠ”ì§€ ì•Œì•„ë³´ì.  

|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`pods.spec.containers.args` | `String[]` | ì»¨í…Œì´ë„ˆì— ì†¡ì‹ í•  ì¸ìˆ˜  
`pods.spec.containers.env` | `EnvVar[]` | ì»¨í…Œì´ë„ˆì— ì„¤ì •í•œ í™˜ê²½ë³€ìˆ˜  
`pods.spec.containers.image` | `String` | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì™€ í•´ë‹¹ ê²½ë¡œ  
`pods.spec.containers.imagePullPolicy` | `String` | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ë“ì‹œ ê·œì¹™(`Always`, `ifNotPresent`, `Never`). ê¸°ë³¸ê°’ì€ `pods.spec.containers.ifNotPresent` ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìƒˆë¡œ ì·¨ë“í•˜ì§€ ì•ŠëŠ”ë‹¤. `Always` ì„¤ì •ì‹œ í•­ìƒ ì´ë¯¸ì§€ ê°±ì‹   
`pods.spec.containers.name` | `String` | ì»¨í…Œì´ë„ˆ ì´ë¦„, ì»¨í…Œì´ë„ˆ ë‚´ë¶€ê°„ì— í†µì‹ í• ë•Œ ì‚¬ìš©(`DNS_LABEL`)  
`pods.spec.containers.ports` | `ContainerPort` ë°°ì—´ | ì»¨í…Œì´ë„ˆ ê³µê°œíŒŒë“œ  
`pods.spec.containers.resources` | `ResourceRequirements` | ì»¨í…Œì´ë„ˆì— CPU, Memory ê°™ì€ ë¦¬ì†ŒìŠ¤ í• ë‹¹  
`pods.spec.containers.volumeMounts` | `VolumeMount` ë°°ì—´ | ì»¨í…Œì´ë„ˆ ë§ˆìš´íŠ¸ ë³¼ë¥¨ ì§€ì •  
`pods.spec.containers.workingDir` | `String` | ì‘ì—… ë””ë ‰í† ë¦¬  
`pods.spec.containers.livenessProbe` | `Probe` | ì»¨í…Œì´ë„ˆ ê°ì‹œ  
`pods.spec.containers.readlinessProbe` | `Probe` | ì»¨í…Œì´ë„ˆ ê°ì‹œ  

### pods.spec.initContainers

ì´ˆê¸°í™” ì»¨í…Œì´ë„ˆ

ì•± ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ê¸° ì „ íŒŒë“œë¥¼ ì´ˆê¸°í™”, 

```yml
apiVersion: v1
kind: Pod
metadata:
  name: kubernetes-simple-pod
  labels:
    app: kubernetes-simple-pod
spec:
  initContainers:
  - name: init-myservice
    image: arisu1000/simple-container-app:latest
    command: ['sh', '-c', 'sleep 2; echo helloworld01;']
  - name: init-mydb
    image: arisu1000/simple-container-app:latest
    command: ['sh', '-c', 'sleep 2; echo helloworld02;']
  containers:
  - name: kubernetes-simple-pod
    image: arisu1000/simple-container-app:latest
    command: ['sh', '-c', 'echo The app is running! && sleep 3600']
```


### pods.spec.containers.livenessProbe  

íŒŒë“œê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€, íŒŒë“œ ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤ê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ ê°ì‹œ í•˜ê¸° ìœ„í•´  
ë©”ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ `livenessProbe` ì†ì„±ì„ ì¶”ê°€í•œë‹¤.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-http

spec:
  containers:
  - name: liveness
    image: k8s.gcr.io/liveness
    args:
    - /server
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
        httpHeaders:
        - name: X-Custom-Header
          value: Awesome
      initialDelaySeconds: 10
      periodSeconds: 5
```

`livenessProbe` ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì— `/healthz` URI ì— 5ì´ˆì£¼ê¸°(`periodSeconds`)ë¡œ ìš”ì²­ì„ ë‚ ë¦¬ê³  `200` ~ `400` ì‚¬ì´ì˜ ê°’ì´ ë°˜í™˜ë  ê²½ìš° ì •ìƒìœ¼ë¡œ ê°„ì£¼í•œë‹¤.  
ê·¸ ì´ì™¸ì˜ ê°’ì´ ë°˜í™˜ë  ê²½ìš° `kublet` ì— ì˜í•´ ì»¨í…Œì´ë„ˆê°€ ì¬ì‹œì‘ ëœë‹¤.  

ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œ ê¹Œì§€ì˜ í…€(`initialDelaySeconds`)ì„ 10ì´ˆë¡œ ì„¤ì •í•œë‹¤.

`k8s.gcr.io/liveness` ì´ë¯¸ì§€ì—ëŠ” 10ì´ˆë™ì•ˆë§Œ `status code 200` ì„ ë°˜í™˜í•˜ê³  ê·¸ ì´í›„ë¡œëŠ” `status code 500`ì„ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •ë˜ì–´ìˆë‹¤.  

10ì´ˆ í›„ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ 

```
$ kubectl get pods --output wide
$ kubectl describe pod liveness-http
```

`CrashLoopBackOff` ìƒíƒœê°’ê³¼ ë¡œê·¸ì— `Liveness probe failed: HTTP probe failed with statuscode: 500` ê°€ ì°í˜€ìˆëŠ”ê±¸ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.  

> http ë¥¼ í†µí•œ íŒŒë“œ ìƒíƒœí™•ì¸ ì™¸ì—ë„ tcpì†Œì¼“, ëª…ë ¹ ì‹¤í–‰ ë“±ì„ í†µí•´ì„œë„ ìƒíƒœí™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤. 
> https://kubernetes.io/ko/docs/concepts/workloads/pods/pod-lifecycle/#ì»¨í…Œì´ë„ˆ-í”„ë¡œë¸Œ-probe

### pods.spec.containers.readinessProbe

ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ëœ í›„ ì‹¤ì œ ì„œë¹„ìŠ¤ ìš”ì²­ì— ì‘ë‹µí•  ìˆ˜ ìˆì„ì§€ ì„¤ì •.  

ìë°” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì²˜ëŸ¼ ì‹¤í–‰í•˜ëŠ”ë° ì‹œê°„ì´ ê±¸ë¦´ ê²½ìš° ìœ ìš©í•¨.  

## íŒŒë“œ CRUD

ë¨¼ì € ê°„ë‹¨í•œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  `private registry` ì— ë“±ë¡  

```
$ docker build -t photo-view:v2.0 .
$ docker image tag photo-view:v2.0 mydomain:5000/photo-view:v2.0

$ docker images
REPOSITORY                        TAG                 IMAGE ID            CREATED              SIZE
mydomain:5000/photo-view   v2.0                05e6c8ef4559        About a minute ago   924MB
photo-view                        v2.0                05e6c8ef4559        About a minute ago   924MB

$ docker image push mydomain:5000/photo-view:v2.0
```

> https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/

í•´ë‹¹ `private registry` ë¥¼ `kubectl` ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `secret` ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ ìƒì„±  

`docker login` ì„ í†µí•´ `$HOME/.docker/config.json` íŒŒì¼ì— ì¸ì¦ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ í›„ í•´ë‹¹ íŒŒì¼ë¡œ `secret` ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ì.  

```
$ kubectl create secret generic regcred \
--from-file=.dockerconfigjson=$HOME/.docker/config.json \
--type=kubernetes.io/dockerconfigjson
```

ë§¥ì˜ ê²½ìš° key ì •ë³´ê°€ `config.json` ì— ì €ì¥ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ ë³„ë„ì˜ í‚¤ì²´ì¸ì— ì €ì¥ë˜ì–´ ìˆì–´ ìœ„ì˜ ëª…ë ¹ì„ ì‚¬ìš©í•´ë´¤ì auth faild ì˜¤ë¥˜ê°€ ë°œìƒí• ê²ƒì´ë‹¤.  
ë§¥ì˜ ê²½ìš° ë°”ë¡œ `kubectl` ì— `secret` ìƒì„±í•˜ëŠ” ì•„ë˜ì˜ ëª…ë ¹ ì‚¬ìš©  

```
$ kubectl create secret docker-registry regcred \
--docker-server=mydomain:5000 \
--docker-username=admin \
--docker-password=admin
```

> `--namespace=''` ì˜µì…˜ì„ ìƒëµí–ˆê¸°ì— ê¸°ë³¸ì ìœ¼ë¡œ default ì— ì ìš©ëœë‹¤.  

í•´ë‹¹ ì´ë¯¸ì§€ë¡œ íŒŒë“œ create

```yaml
# pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: photoview-pod
  labels:
    app: photo-view
    env: stage
spec:
  containers:
  - image: mydomain:5000/photo-view:v2.0
    name: photoview-container
    ports:
    - containerPort: 80
  imagePullSecrets:
    - name: regcred # ìƒì„±í•œ secret name ì„¤ì • 
```

```
$ kubectl apply -f Pod/pod.yaml
pod/photoview-pod created

$ kubectl get pods --show-labels
NAME            READY   STATUS    RESTARTS   AGE     LABELS
photoview-pod   1/1     Running   0          2m13s   app=photo-view,env=stage

$ kubectl describe pods photoview-pod
// ìƒì„¸ì •ë³´ í™•ì¸ ê°€ëŠ¥
```

í•­ìƒ `imagePullSecrets`ë¥¼ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì— ì ìš©í•´ì•¼ë§Œ ë‹¤ìš´ì´ ê°€ëŠ¥í•œë° ì´ë¥¼ `service account` ì— í¬í•¨í•˜ì—¬ ìƒëµí•  ìˆ˜ ìˆë‹¤.  

```
$ kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "regcred"}]}'
```

ìƒˆë¡œìš´ ì´ë¯¸ì§€ `photo-view:v1.0` ì„ ë¹Œë“œ, íƒœê·¸, `private-registry` ì— `push`

```
$ docker build -t photo-view:v1.0 .
$ docker image tag photo-view:v1.0 mydomain:5000/photo-view:v1.0
$ docker image push mydomain:5000/photo-view:v1.0
```

ìœ„ì— ìƒì„±í•œ `photoview-pod`ì˜ ì´ë¯¸ì§€ë¥¼ `photo-view:v1.0` ë¡œ ë³€ê²½í•´ë³´ì.  

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì˜ `image` ì†ì„±ì„ ë³€ê²½  

```yaml
# pod.yaml
apiVersion: v1
kind: Pod
...
spec:
  containers:
  - image: mydomain:5000/photo-view:v1.0
  ...
...
```

```
$ kubectl apply -f Pod/pod.yaml
pod/photoview-pod configured
```

`apply` ëª…ë ¹ìœ¼ë¡œ ìƒì„±/ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë‹¤.  

íŒŒë“œ ì‚­ì œ  
```
$ kubectl delete -f Pod/pod.yaml
```


## íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ êµ¬ì¡°  


ìŠ¤ì¼€ì¤„ë§ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ ë§ˆìŠ¤í„° ì„œë²„ `API Server` ì—ì„œ ê´€ë¦¬í•œë‹¤.  
íŒŒë“œê°€ ë§ˆìŠ¤í„° ì„œë²„ì— ì˜í•´ ì–´ë–¤ ë…¸ë“œì— ì „ê°œ(ìŠ¤ì¼€ì¤„ë§)ë ì§€ ì•Œì•„ë³´ì.  

`API Server`ëŠ” í´ëŸ¬ìŠ¤í„° ì•ˆì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬(`CRUD`), etcd ì— ì ‘ê·¼ì§€ì› í•˜ê¸° ìœ„í•´ `Restfule` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§€ì›í•œë‹¤.  

íŒŒë“œê°€ ìƒì„±ë˜ëŠ” ë£¨í‹´ì€ ëŒ€ëµì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ë‹¤.  

1. `kubectl` ëª…ë ¹ ì‹¤í–‰ - `API Server` ì˜ `RestAPI` ìš”ì²­.  
2. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ì •ë³´ ê°±ì‹  - `kubectl` ë¡œ ì¸í•´ ë³€ê²½ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‚´ìš©ì„ `etcd` ì— ì €ì¥.  
3. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë³€ê²½ - ì ¼ë‹¬ë°›ì€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì™€ `etcd`ì˜ ë°ì´í„°ê°„ ë³€í™”ê°€ ìˆë‹¤ë©´ `API Server`ì—ê²Œ í†µì§€.  
4. íŒŒë“œì˜ ì‘ì„±  - `API Server`ê°€ í†µì§€ë°›ì€ ë‚´ìš©ì´ ìˆë‹¤ë©´ ì›Œì»¤ë…¸ë“œì— íŒŒë“œ ì—…ë°ì´íŠ¸ í•˜ë„ë¡ ëª…ë ¹ ì†¡ì‹ , ë…¸ë“œë‚´ì˜ `kubelet` ì€ ì „ë‹¬ë°›ì€ ëª…ë ¹ì„ ìˆ˜í–‰í•œë‹¤(ìƒˆë¡œìš´ íŒŒë“œ ìƒì„±).  


3ë²ˆê³¼ 4ë²ˆ ê³¼ì • ì‚¬ì´ì—ì„œ íŒŒë“œë¥¼ ì–´ë–¤ ë…¸ë“œì— ìŠ¤ì¼€ì¤„ë§í• ì§€ ê²°ì •í•œë‹¤.  

ìŠ¤ì¼€ì¤„ë§ì€ ì•„ë˜ 2ê°€ì§€ ê·œì¹™ì— ì˜í•´ ê²°ì •ëœë‹¤. 

1. ë…¸ë“œì˜ í•„í„°ë§   
   - íŒŒë“œì— `NodeSelector` ë¥¼ ì„¤ì •í•˜ê³  ìˆëŠ”ì§€ ê²€ì‚¬  
   - íŒŒë“œì— ì„¤ì •ëœ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì— ë§¤ì¹­ë˜ëŠ” ë…¸ë“œ í•„í„°ë§  
2. ë…¸ë“œì˜ ìš°ì„ ìˆœìœ„  
   - CPU, Memory ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë…¸ë“œì˜ ìš°ì„ ìˆœìœ„ ê²°ì •
   - ìš°ì„ ìˆœìœ„ë³„ë¡œ íŒŒë“œë¥¼ ë°°ì¹˜  

<!-- 
## Minikube ì—ì„œ ë…¸ë“œ ìƒì„±  

íŒŒë“œì™€ ë°˜ëŒ€ë¡œ ë…¸ë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ë‚´ì—ì„œ íƒ‘-ë ˆë²¨ ë¦¬ì†ŒìŠ¤ (ë¬¼ë¦¬/ê°€ìƒ ì»´í“¨í„° í•œëŒ€) ì´ë‹¤.

í˜„ì¬ ìƒì„±ëœ ë…¸ë“œ í™•ì¸  

```
$ kubectl get nodes
NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   8d    v1.18.0

$ kubectl describe node  minikube
Name:               minikube
Roles:              master
...
...
```

`minikube` ë¥¼ í†µí•´ ìƒˆë¡œìš´ ê°€ìƒì˜ ë…¸ë“œ ì¶”ê°€  

```
$ minikube node help
ğŸ’¡  Usage: minikube node [add|start|stop|delete]

$ minikube node add
ğŸ˜„  ë…¸ë“œ m02 ë¥¼ í´ëŸ¬ìŠ¤í„° minikube ì— ì¶”ê°€í•©ë‹ˆë‹¤
ğŸ‘  Starting node m02 in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ¤·  docker "minikube" container is missing, will recreate.
ğŸ”¥  docker container (CPUs=2, Memory=1989MB, Disk=<no value>MB) ì— ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì„¤ì¹˜í•˜ëŠ” ì¤‘ ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.18.0 ì„ Docker 19.03.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ„  m02 ë¥¼ minikube ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤!

$ minikube node add
ğŸ˜„  ë…¸ë“œ m03 ë¥¼ í´ëŸ¬ìŠ¤í„° minikube ì— ì¶”ê°€í•©ë‹ˆë‹¤
ğŸ‘  Starting node m03 in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ”¥  docker container (CPUs=2, Memory=1989MB, Disk=<no value>MB) ì— ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì„¤ì¹˜í•˜ëŠ” ì¤‘ ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.18.0 ì„ Docker 19.03.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ„  m03 ë¥¼ minikube ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤!

$ docker ps
CONTAINER ID        IMAGE                                COMMAND                  CREATED             STATUS              PORTS                                                                           NAMES
c9e042c9462e        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   4 minutes ago       Up 4 minutes        127.0.0.1:32785->22/tcp, 127.0.0.1:32784->2376/tcp, 127.0.0.1:32783->8443/tcp   minikube
01a38df1ed4a        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   14 hours ago        Up 2 minutes        127.0.0.1:32791->22/tcp, 127.0.0.1:32790->2376/tcp, 127.0.0.1:32789->8443/tcp   minikube-m03
daaacf0b2652        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   14 hours ago        Up 3 minutes        127.0.0.1:32788->22/tcp, 127.0.0.1:32787->2376/tcp, 127.0.0.1:32786->8443/tcp   minikube-m02

$ kubectl get nodes --show-labels
NAME           STATUS   ROLES    AGE     VERSION   LABELS
minikube       Ready    master   5m47s   v1.18.0   beta....
minikube-m02   Ready    <none>   4m35s   v1.18.0   beta....
minikube-m03   Ready    <none>   2m56s   v1.18.0   beta....
```

> í˜¹ì‹œ ë…¸ë“œ ì„¤ì¹˜ê°„ ë¬¸ì œê°€ ìƒê²¼ë‹¤ë©´  
`$ minikube logs` ë¡œ í™•ì¸ í›„ ì—ëŸ¬ í™•ì¸    
https://stackoverflow.com/questions/56966721/minikube-failed-to-start-node-minikube-not-found  
`$ minikube stop && minikube delete`

ì´ë¯¸ ìˆ˜ë§ì€ `label` ì´ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ `minikube-m02` ë…¸ë“œì— `server=webap` ë¼ë²¨ì„ ì¶”ê°€í•œë‹¤.  

```
$ kubectl label node minikube-m02 server=webap
node/minikube-m02 labeled

$ kubectl get nodes --show-labels
NAME           STATUS   ROLES    AGE     VERSION   LABELS
minikube       Ready    master   5m47s   v1.18.0   beta....
minikube-m02   Ready    <none>   4m35s   v1.18.0   beta....,server=webap
minikube-m03   Ready    <none>   2m56s   v1.18.0   beta....
```

`minikube-m02`ë…¸ë“œì— ë¼ë²¨ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸ í›„  
`nodeSelector`ì†ì„±ì— ìœ„ì—ì„œ ì§€ì •í•œ `label` ì„ ì ìš©í•´ íŒŒë“œê°€ í•´ë‹¹ ë…¸ë“œì— ë§Œë“¤ì–´ì§€ë„ë¡ ì„¤ì •  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: stage
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    server: webap
```

ìƒì„±ëœ íŒŒë“œì˜ ë…¸ë“œê°€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì— ì„¤ì •í•œëŒ€ë¡œ `minikube-m02`ì— ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸.  

```
$ kubectl create -f Pod/labels-node.yaml
pod/nginx created

$ kubectl get pod --output=wide
NAME    READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
nginx   1/1     Running   0          23s   172.18.0.2   minikube-m02   <none>           <none>
```

> `kubectl creat/apply` ì°¨ì´: https://intellipaat.com/community/468/difference-between-kubectl-apply-and-kubectl-create  
 -->

## íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ ì œì–´  

ìœ„ì˜ `nodeSelector` ì†ì„±ì„ ì •ì˜í•´ ëª…ì‹œì ìœ¼ë¡œ ë…¸ë“œë¥¼ ì •í•´ì£¼ì§€ ì•Šê³ ë„ ìŠ¤ì¼€ì¤„ë§í•  ìˆ˜ìˆëŠ” ë°©ë²•ì´ ì—¬ëŸ¿ ìˆë‹¤.  

### Affinity

> https://kubernetes.io/ko/docs/concepts/configuration/assign-pod-node/#ì–´í”¼ë‹ˆí‹°-affinity-ì™€-ì•ˆí‹°-ì–´í”¼ë‹ˆí‹°-anti-affinity

`Affinity` ëŠ” ì¹œë°€ê°ì´ë€ ëœ»ìœ¼ë¡œ ì„œë¡œë‹¤ë¥¸ 2ê°œì˜ íŒŒë“œë¥¼ ì™ ë§Œí•˜ë©´ ê°™ì€ë…¸ë“œì— ë°°ì¹˜ì‹œí‚¤ê³  ì‹¶ì„ë•Œ(`podAffinity`)  
í˜¹ì€ ë‹¤ë¥¸ë…¸ë“œì— ë°°ì¹˜ì‹œí‚¤ê³  ì‹¶ì„ë•Œ(`podAntiAffinity`) ì‚¬ìš©í•œë‹¤.  

ë˜í•œ íŠ¹ì • ì¡°ê±´ì„ ê°–ì¶˜ ë…¸ë“œì—ì„œë§Œ ë™ì‘í•˜ë„ë¡ í•˜ëŠ” `nodeAffinity` ë„ ìˆë‹¤.  


### Taints, Tolerations

> https://kubernetes.io/ko/docs/concepts/configuration/taint-and-toleration/

> Taints: ì˜¤ì—¼ì‹œí‚¤ë‹¤
> Tolerations: ìš©ì¸,ê´€ìš©

ì„œë¡œ ìƒë°˜ë˜ëŠ” ì—­í• ì„ í•˜ëŠ” ëª…ë ¹  

`Taints`ëŠ” ë…¸ë“œì— ì„¤ì •í•˜ëŠ” ê²ƒìœ¼ë¡œ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¤„ë§ í•˜ê±°ë‚˜ ì¡°ê±´ì— ë§ëŠ” íŒŒë“œë§Œ ìŠ¤ì¼€ì¤„ë§ í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.  
`Taints`ê°€ ì„¤ì •ëœ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜í•˜ê³  ì‹¶ë‹¤ë©´ `Tolerations` ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.  

## íŒŒë“œ ë¦¬ì†ŒìŠ¤ ì„¤ì •  

`CPU`, `Memory` ë¦¬ì†ŒìŠ¤ëŠ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ì„¤ì • ê°€ëŠ¥í•˜ë‹¤.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: requests-pod

spec:
  containers:
  - image: busybox
    command: ["dd", "if=/dev/zero", "of=/dev/null"]
    name: main
    resources:
      requests:
        cpu: 50m
        memory: 300Mi # (K M G T P), (Ki Mi Gi Ti Pi) ì‚¬ìš© ê°€ëŠ¥
```

`Minikube` ì—ì„œ ìƒì„±ëœ `node` ì˜ `CPU Limits` ëŠ” `100m`, `Memory Limits`ëŠ” `390Mi`ë‚¨ì•„ìˆë‹¤.
ìœ„ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì„¤ì •ëŒ€ë¡œ íŒŒë“œë¥¼ ìƒì„±í•˜ê³  ì¤„ì–´ë“œëŠ” `Limits` ë¥¼ í™•ì¸  

`requests` ì†ì„±ì„ íŒŒë“œì˜ ìµœì†Œ ë¦¬ì†ŒìŠ¤ ìš”ì²­ ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.  

```
$ kubectl create -f Pod/pod-request.yaml
pod/requests-pod created 

$ kubectl get pods --output wide
NAME           READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
requests-pod   1/1     Running   0          39s   172.18.0.2   minikube-m03   <none>           <none>
```

`$ kubectl describe node minikube-m03` ëª…ë ¹ìœ¼ë¡œ ë‚¨ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•´ë³´ë©´ ì •í™•ì¸ `CPU 50m`, `Memory 300Mi` ë§Œí¼ `Limits` ê°€ ì¤„ì–´ìˆë‹¤.   

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¤„ë§í• ë•Œ ì‹¤ì œ ë…¸ë“œì˜ ë¦¬ì†ŒìŠ¤ì‚¬ìš©ëŸ‰ì´ ì•„ë‹Œ ë©”ë‹ˆí˜ìŠ¤íŠ¸ì— ì„¤ì •ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì •ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ ë¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.  
íŒŒë“œì— ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í• ë‹¹í•˜ê²Œ ë˜ë©´ ê·¸ë§Œí¼ ë‹¤ë¥¸ íŒŒë“œë¥¼ ë…¸ë“œì— ì„¤ì •í•  ìˆ˜ ì—†ë‹¤.

ë§Œì•½ íŒŒë“œì— ì„¤ì •í•œ `resources` ì‚¬ìš©ëŸ‰ì„ ë„˜ê²Œë˜ë©´ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: limits-pod
spec:
  containers:
  - name: main
    image: polinux/stress
    resources:
      limits:
        cpu: 90m
        memory: 300Mi
    command: ["stress"]
    args: ["--vm", "1", "--vm-bytes", "500M", "--vm-hang", "1"]
```

`stress` í”„ë¡œê·¸ë¨ìœ¼ë¡œ `Memory`ì— `300M`ë¥¼ ë„˜ëŠ” `500M` ë¥¼ ì„¤ì •í•˜ì—¬ ì‹¤í–‰  

`limits` ì†ì„±ì€ íŒŒë“œ ìš”ì²­ ì œí•œ ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.  

```
$ kubectl get pods --output wide
NAME         READY   STATUS              RESTARTS   AGE   IP       NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     ContainerCreating   0          6s    <none>   minikube-m03   <none>           <none>

$ kubectl get pods --output wide
NAME         READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   1/1     Running   0          9s    172.18.0.2   minikube-m03   <none>           <none>

$ kubectl get pods --output wide
NAME         READY   STATUS      RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     OOMKilled   0          9s    172.18.0.2   minikube-m03   <none>           <none>

$ kubectl get pods --output wide
NAME         READY   STATUS             RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     CrashLoopBackOff   2          43s   172.18.0.2   minikube-m03   <none>           <none>
```

```
$ kubectl describe pod limits-pod
# ìƒì„¸ ë¡œê·¸ í™•ì¸.  
```


ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„  ë³µêµ¬ê¸°ëŠ¥ì„ ê°–ê³  ìˆê¸°ì— ì˜¤ë¥˜ê°€ ê°ì§€ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì‹œì‘í•œë‹¤.  
`restartPolicy`ì†ì„± ì— ë”°ë¼ ì˜µì…˜ì´ ë‹¤ë¥´ë©° ê¸°ë³¸ê°’ì€ `Always` ì´ë‹¤.  

```
$ kubectl get pods --output wide
NAME         READY   STATUS             RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     CrashLoopBackOff   6          7m15s   172.18.0.2   minikube-m03   <none>           <none>
```

ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ `RESTARTS` íšŸìˆ˜ê°€ ê³„ì† ëŠ˜ì–´ë‚˜ê³  ìˆë‹¤.  

# ë¦¬í”Œë¦¬ì¹´ì…‹ (ReplicaSet)

íŒŒë“œê°€ ìë™ìœ¼ë¡œ ìƒíƒœê²€ì‚¬, ì •ìƒí™”(ì¬ì‹œì‘) í•˜ë©° ìƒíƒœë¥¼ ë³µêµ¬í•˜ëŠ” ê²ƒì´ë¼ë©´
ë¦¬í”Œë¦¬ì¹´ì…‹ì€ **íŒŒë“œì˜ ìˆ˜ë¥¼ ìœ ì§€, ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ íŒŒë“œë¥¼ ì‹œì‘**í•œë‹¤. 

## ë§¤ë‹ˆí˜ìŠ¤íŠ¸

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê¸°ë³¸ êµ¬ì„±ì€ íŒŒë“œì™€ ê°™ë‹¤.  
`spec` ë¶€ë¶„ë§Œ ë‹¤ë¥¸ë¶€ë¶„ì´ ìˆëŠ”ë° ì•Œì•„ë³´ì.  

|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`replicaset.spec.replicas` | `Integer` | í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ê°€ë™ì‹œí‚¬ íŒŒë“œì˜ ìˆ˜ (ê¸°ë³¸ê°’ 1)
`replicaset.spec.selector` | `LabelSelector` | ì–´ë–¤ íŒŒë“œë¥¼ ê°€ë™í• ì§€ ì •ì˜, íŒŒë“œì˜ `template.metadata.label` ì— ì„¤ì •ëœ ê°’ê³¼ ì¼ì¹˜í•´ì•¼í•¨
`replicaset.spec.template` | `PodTemplateSpec` | ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ íŒŒë“œ ìˆ˜ê°€ `replicas` ì— ì„¤ì •ëœ ìˆ˜ë³´ë‹¤ ì ì„ë•Œ ìƒˆë¡œì‘ì„±ë˜ëŠ” íŒŒë“œ**ì˜ í…œí”Œë¦¿**
`replicaset.spec.template.metadata` | `Object` | í…œí”Œë¦¿ì˜ ì´ë¦„, `Label`ê³¼ ê°™ì€ ë©”íƒ€ë°ì´í„° 
`replicaset.spec.template.spec` | `PodSpec` | íŒŒë“œì˜ ìƒì„¸ì •ë³´ë¥¼ ì„¤ì •  

ì¦‰ ë¦¬í”Œë¦¬ì¹´ì…‹ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ `spec` ê³¼ íŒŒë“œì˜ `spec` ì„ ëª¨ë‘ ì •ì˜í•´ì•¼í•œë‹¤.  

## ë¦¬í”Œë¦¬ì¹´ì…‹ CRUD

```yaml
# ReplicaSet/replicaset.yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: photoview-rs
spec:
  replicas: 5
  selector:
    matchLabels:
      app: photoview
  template:
    metadata:
      labels:
        app: photoview
        env: prod
    spec:
      containers:
      - image: mydomain:5000/photo-view:v1.0
        name: photoview-container
        ports:
          - containerPort: 80
```


```
$ kubectl create -f ReplicaSet/replicaset.yaml
$ kubectl get pods --show-labels
NAME                 READY   STATUS    RESTARTS   AGE     LABELS
photoview-rs-466w6   1/1     Running   0          3h35m   app=photoview,env=prod
photoview-rs-fwv2f   1/1     Running   0          3h35m   app=photoview,env=prod
photoview-rs-j46rr   1/1     Running   0          3h40m   app=photoview,env=prod
photoview-rs-n64z2   1/1     Running   0          3h35m   app=photoview,env=prod
photoview-rs-zk4bz   1/1     Running   0          3h35m   app=photoview,env=prod

# íŒŒì¼ì„ ìˆ˜ì • í›„ apply í•˜ë©´ ê¸°ì¡´ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ ì„¤ì •ì´ ìë™ ìˆ˜ì •/ì ìš© ëœë‹¤.  
$ kubectl apply -f ReplicaSet/replicaset.yaml
$ kubectl delete -f ReplicaSet/replicaset.yaml
```

ë¦¬í”Œë¦¬ì¹´ì…‹ì€ ì² ì €íˆ `spec.template.metadata.labels.app` ì„ í†µí•´ì„œ ê´€ë¦¬ëœë‹¤.  

ë¨¼ì € ë¼ë²¨ëª…ì´ `photo-view` ì¸ **íŒŒë“œ** ë¥¼ í•˜ë‚˜ ìƒì„±  

```
$ kubectl apply -f ReplicaSet/pod-nginx.yaml
pod/nginx-pod created

$ kubectl get pod
NAME        READY   STATUS    RESTARTS   AGE
nginx-pod   1/1     Running   0          27s
```

ê·¸ë¦¬ê³  ë¦¬í”Œë¦¬ì¹´ì…‹ìœ¼ë¡œ `photo-view` ë¼ë²¨ì„ ê°€ì§„ íŒŒë“œ 5ê°œë¥¼ ìƒì„±í•˜ë„ë¡í•œë‹¤.  

```
$ kubectl apply -f ReplicaSet/replicaset-nginx.yaml
replicaset.apps/nginx-replicaset created

$ kubectl get pod
NAME                     READY   STATUS              RESTARTS   AGE
nginx-pod                1/1     Running             0          79s
nginx-replicaset-cg8l7   0/1     ContainerCreating   0          2s
nginx-replicaset-hgkkd   0/1     ContainerCreating   0          2s
nginx-replicaset-kg5ks   0/1     ContainerCreating   0          2s
nginx-replicaset-p2w5f   0/1     ContainerCreating   0          2s
```

ê¸°ì¡´ì— íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¡œ ìƒì„±í–ˆë˜ `nginx-pod` íŒŒë“œì™€ í•¨ê»˜ 4ê°œì˜ ì¶”ê°€ íŒŒë“œê°€ ìƒì„±ëœë‹¤.  

# ë””í”Œë¡œì´ë¨¼íŠ¸ (Deployment)

> Deployment: ì „ê°œ, ë°°ì¹˜  
> https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„  ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ìœ ì—°í•œ `CI/CD(ì§€ì†ì ì¸ í†µí•©/ë°°í¬)` ë¥¼ ìœ„í•´ `Deployment` ë¥¼ ì œê³µí•œë‹¤.  

`Deployment`ëŠ” `ReplicaSet`ì˜ ìƒìœ„ê°œë…ì´ë‹¤.  
ë˜‘ê°™ì´ ì—¬ëŸ¬ê°œì˜ íŒŒë“œë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬ë©´ì„œ ì—…ë°ì´íŠ¸ ê´€ë ¨ ê¸°ëŠ¥ì„ ì¶”ê°€ ì œê³µí•œë‹¤.  

**Recreate**  
ì˜¤ë˜ëœ íŒŒë“œë¥¼ ì •ì§€ì‹œí‚¤ê³  ìƒˆë¡œìš´ íŒŒë“œë¥¼ ë‹¤ì‹œ ì‘ì„±í•˜ëŠ” ë°©ì‹.
ê°€ì¥ ì‹¬í”Œí•˜ê³  ë¹ ë¥´ì§€ë§Œ ì„œë²„ê°€ ëª¨ë‘ ë‚´ë ¤ê°€ ë²„ë¦¬ê¸°ì— ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•œë‹¤.  

**Rolling update**  
ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ì „ì—…ì´ ëª¨ë‘ í•œêº¼ë²ˆì— ì—…ë°ì´íŠ¸ ë˜ëŠ”ê²ƒì´ ì•„ë‹Œ  
ìˆœì„œëŒ€ë¡œ ì¡°ê¸ˆì”© ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ë²•  
ë˜‘ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—¬ëŸ¬ ê°œ ë³‘ë ¬ë¡œ ì›€ì§ì´ëŠ” ê²½ìš° ê°€ëŠ¥í•˜ë‹¤.  

**blue/green Deployment**   
ë²„ì „ì´ ë‹¤ë¥¸ ë‘ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë™ì‹œì— ê°€ë™í•˜ê³  ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ì‚¬ìš©í•´ ë³„ë„ì˜ ê³µê°„ì—ì„œ ë™ì‘ì‹œí‚¨ë‹¤.  
ì—…ë°ì´íŠ¸ ë²„ì „ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì„œë¹„ìŠ¤ëŠ” ì „í™˜ì‹œì¼œ ì—…ë°ì´íŠ¸ ì™„ë£Œ.  
ë¸”ë£¨(êµ¬ë²„ì „), ê·¸ë¦°(ì‹ ë²„ì „) ì„ ì „í™˜í•˜ëŠ” ëœ»ì—ì„œ ìœ ë˜ë¨.  
ê·¸ë¦°ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¥ì•  ë°œìƒì‹œ ë¸”ë£¨ë¡œ ë°”ë¡œ ë³µêµ¬ ê°€ëŠ¥í•œ ì¥ì ì´ ìˆë‹¤.  

**Roll out, Roll back**   
ë¡¤ì•„ì›ƒ(`roll-out`) ê°„ë‹¨íˆ ë²ˆì—­í•˜ë©´ ì‹ ì œí’ˆ ë˜ëŠ” ì •ì±…ì¶œì‹œ ë˜ëŠ” ë¦´ë¦¬ì¦ˆë¼ í•  ìˆ˜ ìˆë‹¤.  
`Deployment`ëŠ” ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë²„ì „ì—… ë“± ì—…ë°ì´íŠ¸ê°€ ìˆì„ ë•Œ ì‚¬ë¡œìš´ ì‚¬ì–‘ì˜ ë¦¬í”Œë¦¬ì¹´ì…‹(ë§¤ë‹ˆí˜ìŠ¤íŠ¸) ë¥¼ ì‘ì„±í•˜ê³   
ê·¸ì— í•´ë‹¹í•˜ëŠ” ìƒˆë¡œìš´ íŒŒë“œë¡œ ì´ë¥¼ ëŒ€ì²´í•´ ë¡¤ì•„ì›ƒì„ ìˆ˜í–‰í•œë‹¤.  

## ë§¤ë‹ˆí˜ìŠ¤íŠ¸ 

```yaml
# ê¸°ë³¸í•­ëª©
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
# ë””í”Œë¡œì´ë¨¼íŠ¸ ìŠ¤íŒ©
spec:
  replicas: 10
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 50%
      maxSurge: 50%
  selector:
    matchLabels:
      app: nginx-pod # í…œí”Œë¦¿ ê²€ìƒ‰ì¡°ê±´
  # íŒŒë“œ í…œí”Œë¦¿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
        - name: nginx
          image: nginx:1.14 # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€
          ports:
            - containerPort: 80
```


`Deployment`ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë˜í•œ `spec` ì†ì„±ì´ ì¢€ ë‹¤ë¥¼ë¿ ë‚˜ë¨¸ì§€ëŠ” ë¹„ìŠ·í•˜ë‹¤.  

|í•„ë“œ|ì„¤ëª…|
|---|---|
`replicas` | í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ê°€ë™ì‹œí‚¬ íŒŒë“œì˜ ìˆ˜  
`selector` | ì–´ë–¤ íŒŒë“œë¥¼ ê°€ë™ì‹œí‚¬ì§€ì— ëŒ€í•œ ì…€ë ‰í„°, íŒŒë“œì— ì ìš©ëœ ë¼ë²¨ì„ ì‚¬ìš©í•œë‹¤.  
`template` | í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ íŒŒë“œ ìˆ˜ê°€ ë¦¬í”Œë¦¬ì¹´ìˆ˜ë³´ë‹¤ ì‘ì„ë•Œ ìƒˆë¡œ ì‘ì„±í•  íŒŒë“œì˜ í…œí”Œë¦¿  
`strategy` | ì—…ë°ì´íŠ¸ ë°©ì‹ ê²°ì • ê°€ëŠ¥, `RollingUpdate`, `Recreate` ê°€ ìˆìœ¼ë©° ê¸°ë³¸ê°’ì€ `RollingUpdate`  
`maxUnavailable` | ë¡¤ë§ ì—…ë°ì´íŠ¸ì¤‘ í•­ìƒ ì‚¬ìš©ê°€ëŠ¥í•œ íŒŒë“œì˜ ì´ìˆ˜, ìœ„ì˜ ê²½ìš° ì‹ ë²„ì „, êµ¬ë²„ì „ í•©ì³ì„œ ë¦¬í”Œë¦¬ì¹´ìˆ˜ì˜ 50%ì˜ íŒŒë“œê°€ í•­ìƒ ë™ì‘ì¤‘ì´ì–´ì•¼ í•œë‹¤. ê¸°ë³¸ê°’ì€ 25%  
`maxSurge` | íŒŒë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ê°œìˆ˜, 100%ë¡œ ì„¤ì •ì‹œ ì‹ ë²„ì „ì˜ íŒŒë“œìˆ˜ê°€ ë¦¬í”Œë¦¬ì¹´ìˆ˜ë§Œí¼ ì‹¤í–‰ë˜ì–´ í•œë²ˆì— 20ê°œì˜ íŒŒë“œê°€ ë™ì‘í•˜ê²Œ ëœë‹¤. ê¸°ë³¸ê°’ì€ 25%. ë¦¬ì†ŒìŠ¤ ìƒí™©ì— ë”°ë¼ íŠ¹ì´ì‚¬í•­ì´ ë°œìƒí•  ìˆ˜ ìˆìŒìœ¼ë¡œ `maxSurge` ëŠ” ì‘ì„±í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.  
`readinessProbe` | ì‹¤í–‰í•œ íŒŒë“œê°€ ì •ìƒì¸ì§€ í™•ì¸í•˜ëŠ” ì†ì„± íŒŒë“œì˜ `livenessProbe` ì™€ ë¹„ìŠ·í•˜ë‹¤. 



- `livenessProbe`: ì»¨í…Œì´ë„ˆê°€ ë™ì‘ ì¤‘ì¸ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. ë§Œì•½ í™œì„± í”„ë¡œë¸Œ(liveness probe)ì— ì‹¤íŒ¨í•œë‹¤ë©´, `kubelet`ì€ ì»¨í…Œì´ë„ˆë¥¼ ì£½ì´ê³ , í•´ë‹¹ ì»¨í…Œì´ë„ˆëŠ” ì¬ì‹œì‘ ì •ì±…ì˜ ëŒ€ìƒì´ ëœë‹¤. ë§Œì•½ ì»¨í…Œì´ë„ˆê°€ í™œì„± í”„ë¡œë¸Œë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ” ê²½ìš°, ê¸°ë³¸ ìƒíƒœëŠ” `Success`ì´ë‹¤.  

- `readinessProbe`: ì»¨í…Œì´ë„ˆê°€ ìš”ì²­ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. ë§Œì•½ ì¤€ë¹„ì„± í”„ë¡œë¸Œ(readiness probe)ê°€ ì‹¤íŒ¨í•œë‹¤ë©´, ì—”ë“œí¬ì¸íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” íŒŒë“œì— ì—°ê´€ëœ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ íŒŒë“œì˜ IPì£¼ì†Œë¥¼ ì œê±°í•œë‹¤. ì¤€ë¹„ì„± í”„ë¡œë¸Œì˜ ì´ˆê¸° ì§€ì—° ì´ì „ì˜ ê¸°ë³¸ ìƒíƒœëŠ” `Failure`ì´ë‹¤. ë§Œì•½ ì»¨í…Œì´ë„ˆê°€ ì¤€ë¹„ì„± í”„ë¡œë¸Œë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ê¸°ë³¸ ìƒíƒœëŠ” `Success`ì´ë‹¤.  

> `Pod livenessProbe`: https://kouzie.github.io/docker/kubernetes/ì¿ ë²„ë„¤í‹°ìŠ¤-íŒŒë“œ,-ë¦¬í”Œë¦¬ì¹´ì…‹,-ìŠ¤ì¼€ì¼ëŸ¬ë¹Œë¦¬í‹°/#íŒŒë“œ-ê°ì‹œ  

## ë””í”Œë¡œì´ë¨¼íŠ¸ CRUD

ë„ì»¤ í—ˆë¸Œì—ì„œ ë°”ë¡œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ ë””í”Œë¡œì´ë¨¼íŠ¸ CRUD

```
# ìƒì„±
$ kubectl create deployment --image=nginx nginx-app
deployment.apps/nginx-app created

# ìŠ¤ì¼€ì¼ ì—…
$ kubectl scale deploy nginx-app --replicas=2
deployment.apps/nginx-app scaled

$ kubectl get pods
NAME                        READY   STATUS    RESTARTS   AGE
nginx-app-d6ff45774-m6frx   1/1     Running   0          113s
nginx-app-d6ff45774-q7r5v   1/1     Running   0          26s

$ kubectl get deployments
NAME        READY   UP-TO-DATE   AVAILABLE   AGE
nginx-app   2/2     2            2           2m17s

# ì„œë¹„ìŠ¤ ìƒì„±
$ kubectl expose deployment nginx-app --type=NodePort --port=80
service/nginx-app exposed

$ kubectl get service nginx-app # localhost:30403 ì ‘ì†
NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
nginx-app   NodePort   10.104.196.2   <none>        80:30403/TCP   6s

# ìƒì„¸ ì¡°íšŒ
$ kubectl describe service nginx-app
Name:                     nginx-app
Namespace:                default
Labels:                   app=nginx-app
Annotations:              <none>
Selector:                 app=nginx-app
Type:                     NodePort
IP Families:              <none>
IP:                       10.104.196.2
IPs:                      <none>
LoadBalancer Ingress:     localhost
Port:                     <unset>  80/TCP
TargetPort:               80/TCP
NodePort:                 <unset>  30403/TCP
Endpoints:                10.1.0.11:80,10.1.0.12:80 # ì¤‘ìš”
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>

# ì‚­ì œ
$ kubectl delete deployment nginx-app
deployment.apps "nginx-app" deleted
```

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ìƒì„±í›„ `Deployment` ë¦¬í”Œë¦¬ì¹´ì…‹ê³¼ íŒŒë“œê°€ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸  

```yaml
# ê¸°ë³¸í•­ëª©
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
# ë””í”Œë¡œì´ë¨¼íŠ¸ ìŠ¤íŒ©
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-pod # í…œí”Œë¦¿ ê²€ìƒ‰ì¡°ê±´
  # íŒŒë“œ í…œí”Œë¦¿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
        - name: nginx
          image: nginx:1.15 # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€
          ports:
            - containerPort: 80
```

```
$ kubectl apply -f Deployment/nginx-deployment.yaml
deployment.apps/nginx-deployment created

$ kubectl get deploy
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           24s

$ kubectl get replicaset,pod
NAME                                          DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-deployment-5bff7844cb   3         3         3       5m11s

NAME                                    READY   STATUS    RESTARTS   AGE
pod/nginx-deployment-5bff7844cb-6n2xh   1/1     Running   0          5m11s
pod/nginx-deployment-5bff7844cb-9jmvt   1/1     Running   0          5m11s
pod/nginx-deployment-5bff7844cb-kc7ph   1/1     Running   0          5m11s
```

ë””í”Œë¡œì´ë¨¼íŠ¸ëŠ” ë‚´ë¶€ì—ì„œ ë¦¬í”Œë¦¬ì¹´ì…‹, íŒŒë“œ ì´ë ¥ì„ ê°–ê³  ìˆë‹¤. `kubectl get replicaset` ëª…ë ¹ì—ë„ ì¡°íšŒê°€ ê°€ëŠ¥í•˜ë‹¤.  

ë¦¬ì†ŒìŠ¤ì˜ ë„¤ì´ë° ê·œì¹™ì´ ìˆë‹¤.  

`Deployment` - `nginx-deployment`  
`ReplicaSet` - `nginx-deployment-5bff7844cb`  
`Pod` - `nginx-deployment-5bff7844cb-kc7ph`  

ë’¤ì— íŠ¹ì • í•´ì‹œê°’ì´ ë¼ë²¨ë¡œë„ ë¶™ì–´ìˆìœ¼ë©° ì´ë¥¼ ì‚¬ìš©í•´ `Deployment`ê°€ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•œë‹¤.  


ê¸°ì¡´ì˜ `nginx:1.14` ë²„ì „ì˜ ì´ë¯¸ì§€ë¥¼ `nginx:1.15` ë¡œ ë³€ê²½í•´ë³´ì.  

```
$ kubectl apply -f Deployment/nginx-deployment.yaml
deployment.apps/nginx-deployment configured

$ kubectl describe deploy nginx-deployment
Name:                   nginx-deployment
Namespace:              default
...
...
OldReplicaSets:  <none>
NewReplicaSet:   nginx-deployment-f75fb748c (3/3 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled up replica set nginx-deployment-5bff7844cb to 3
  Normal  ScalingReplicaSet  18s   deployment-controller  Scaled up replica set nginx-deployment-f75fb748c to 1
  Normal  ScalingReplicaSet  4s    deployment-controller  Scaled down replica set nginx-deployment-5bff7844cb to 2
  Normal  ScalingReplicaSet  4s    deployment-controller  Scaled up replica set nginx-deployment-f75fb748c to 2
  Normal  ScalingReplicaSet  3s    deployment-controller  Scaled down replica set nginx-deployment-5bff7844cb to 1
  Normal  ScalingReplicaSet  3s    deployment-controller  Scaled up replica set nginx-deployment-f75fb748c to 3
  Normal  ScalingReplicaSet  2s    deployment-controller  Scaled down replica set nginx-deployment-5bff7844cb to 0
```

`nginx-deployment-5bff7844cb` ì´ë¦„ì˜ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ íŒŒë“œë¥¼ í•˜ë‚˜ì”© ì¤„ì´ë©°  
`nginx-deployment-f75fb748c` ì´ë¦„ì˜ ìƒˆë¡œìš´ ë¦¬í”Œë¦¬ì¹´ì…‹ì˜ íŒŒë“œë¥¼ í•˜ë‚˜ì”© ìƒì„±í•œë‹¤.  

ë””í”Œë¡œì´ë¨¼íŠ¸ ì´ë ¥(history)ì„ í™•ì¸í•˜ë ¤ë©´ `rollout history` ì˜µì…˜ì„ ì‚¬ìš©í•œë‹¤.  

```
$ kubectl rollout history deploy rollout-deployment --revision=3
deployment.apps/rollout-deployment with revision #3
Pod Template:
  Labels:	app=photo-view
	pod-template-hash=d8bf6cb58
  Containers:
   photoview-container:
    Image:	ai1.beyless.com:5005/photo-view:v1.0
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
  Volumes:	<none>

$ kubectl rollout history deploy rollout-deployment --revision=4
deployment.apps/rollout-deployment with revision #4
Pod Template:
  Labels:	app=photo-view
	pod-template-hash=6b5ddcb6b7
  Containers:
   photoview-container:
    Image:	ai1.beyless.com:5005/photo-view:v2.0
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
  Volumes:	<none>
```

## Roll out, Roll back  

ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë¬¸ì œê°€ ìƒê¸°ë©´ ë‹¤ì‹œ ì´ì „ë²„ì „ìœ¼ë¡œ ëŒë¦´ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥(ë¡¤ë°±) ì„ ì‚¬ìš©í•´ë³´ì.  

ë¨¼ì € ì•„ë˜ì™€ ê°™ì€ ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ìƒì„± í›„ ì‹¤ì œ ì„œë¹„ìŠ¤ê¹Œì§€ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸  

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rollout-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v1.0
          name: photoview-container
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: rollout
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  selector:
    app: photo-view
```

```
$ kubectl apply -f Deployment/rollout-depoyment.yaml
deployment.apps/rollout-deployment created
service/rollout created

$ kubectl get pod
NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-d8bf6cb58-2p5wz   1/1     Running   0          48s
rollout-deployment-d8bf6cb58-56mrf   1/1     Running   0          48s
rollout-deployment-d8bf6cb58-bscp8   1/1     Running   0          48s
```

<!-- 
`minikube` ì˜ ê²½ìš° `service`ì˜ ì™¸ë¶€ë…¸ì¶œ IPë¥¼ ì‚¬ìš© ë¶ˆê°€ëŠ¥ í•¨ìœ¼ë¡œ `$ kubectl get services` ëª…ë ¹ì„ ì‚¬ìš©í•´ë„ `<pending>` ìœ¼ë¡œë°–ì— ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤.  

ì•„ë˜ `minikube service` ëª…ë ¹ì„ ì‚¬ìš©í•´ í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œì‹œí‚¨ë‹¤.  

```
$ minikube service rollout
ğŸƒ  Starting tunnel for service rollout.
|-----------|---------|-------------|------------------------|
| NAMESPACE |  NAME   | TARGET PORT |          URL           |
|-----------|---------|-------------|------------------------|
| default   | rollout |             | http://127.0.0.1:51768 |
|-----------|---------|-------------|------------------------|
ğŸ‰  Opening service default/rollout in default browser...
â—  Because you are using docker driver on Mac, the terminal needs to be open to run it.
```

-->

í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ì´ë¯¸ì§€ `photo-view:v1.0` ë¥¼ `photo-view:v2.0` ìœ¼ë¡œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì ìš©(`Roll out`)

```
$ kubectl apply -f Deployment/rollout-depoyment.yaml
deployment.apps/rollout-deployment configured
service/rollout unchanged

$ kubectl describe deploy rollout-deployment
Name:                   rollout-deployment
Namespace:              default
...
Annotations:            deployment.kubernetes.io/revision: 2
...
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  41s   deployment-controller  Scaled up replica set rollout-deployment-d8bf6cb58 to 3
  Normal  ScalingReplicaSet  27s   deployment-controller  Scaled up replica set rollout-deployment-6b5ddcb6b7 to 1
``` 

`describe` ëª…ë ¹ìœ¼ë¡œ ì¶œë ¥ëœ `Annotations` ì†ì„±ìœ¼ë¡œ `revision` ê°’ í™•ì¸  
í•´ë‹¹ ë””í”Œë¡œì´ë¨¼íŠ¸ê°€ **ëª‡ë²ˆ ì—…ë°ì´íŠ¸** ë˜ì—ˆëŠ”ì§€ í™•ì´ ê°€ëŠ¥í•˜ë‹¤.  

`d8bf6cb58 -> 6b5ddcb6b7` í•´ì‹œì˜ ë³€ê²½ê°’ì´ë‹¤.  

ì´ì œ `photo-view:v2.0` ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ë‹¤ì‹œ ì˜ˆì „ë²„ì „ìœ¼ë¡œ ë¡¤ ë°±í•´ë³´ì.  

ì²«ë²ˆì§¸ ë°©ë²•ìœ¼ë¡œ íƒ¬í”Œë¦¿ ì´ë¯¸ì§€ë¥¼ `photo-view:v1.0` ë¡œ ë‹¤ì‹œ ì ìš©í•´ë³´ì.  

```
kubectl apply -f Deployment/rollout-depoyment.yaml
deployment.apps/rollout-deployment configured
service/rollout unchanged

$ kubectl describe deploy rollout-deployment
...
Annotations:            deployment.kubernetes.io/revision: 3
...

$ kubectl get pod
NAME                                 READY   STATUS    RESTARTS   AGE
rollout-deployment-d8bf6cb58-9nwh5   1/1     Running   0          33s
rollout-deployment-d8bf6cb58-t2f4l   1/1     Running   0          34s
rollout-deployment-d8bf6cb58-tgg57   1/1     Running   0          31s
```

`revision`ê°’ì€ 3ì´ ë˜ì—ˆê³  í•´ì‹œê°’ì´ ìƒˆë¡­ê²Œ ë³€í•˜ì§€ ì•Šê³  ë‹¤ì‹œ `d8bf6cb58` ë¡œ ëŒì•„ê°”ë‹¤.  

ë””í”Œë¡œì´ë¨¼íŠ¸, ë¦¬í”Œë¦¬ì¹´ì…‹, íŒŒë“œ ëª¨ë‘ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì´ë ¥ì„ ê°€ì§€ê³  ë¡¤ì•„ì›ƒ/ë¡¤ë°±ì„ ì§„í–‰í•˜ê³  ìˆê¸° ë•Œë¬¸  

ì´ ì™¸ì—ë„ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìˆ˜ì •í•˜ê±°ë‚˜ `kubectl rollout` ëª…ë ¹ì„ ì‚¬ìš©í•´ ë¡¤ë°±ì´ ê°€ëŠ¥í•˜ë‹¤.  

```
$ kubectl edit deploy rollout-deployment
$ kubectl rollout undo deployment rollout-deployment --to-revision=2 
```

êµ¬ì„±ê´€ë¦¬ê°€ ìœ ì§€ë˜ì§€ ì•ŠìŒìœ¼ë¡œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì˜ ê°±ì‹ (ì„ ì–¸ì  ê´€ë¦¬)ìœ¼ë¡œ ë¡¤ì•„ì›ƒ/ë¡¤ë°± í•˜ëŠ”ê²ƒì„ ê¶Œì¥í•œë‹¤.  

## ë¸”ë£¨/ê·¸ë¦° ë””í”Œë¡œì´ë¨¼íŠ¸  

ë¸”ë£¨/ê·¸ë¦° ì´ë¼ê³  ë³„ë‹¤ë¥¸ ê¸°ë²•ì´ ìˆëŠ”ê±´ ì•„ë‹ˆë‹¤.

ì„œë¡œ ë‹¤ë¥¸ ë²„ì „ì˜ 2ê°œì˜ ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ê°ê° ìƒì„±í•˜ê³  ì´ì— ì ‘ê·¼í•˜ëŠ” `Service` ë¦¬ì†ŒìŠ¤ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì´ë‹¤.

```yaml
# blue-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blue-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
        ver: v1.0
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v1.0
          name: photoview-container
          ports:
            - containerPort: 80
```

```yaml
# green-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: green-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
        ver: v2.0
    spec:
      containers:
        - image: ai1.beyless.com:5005/photo-view:v2.0
          name: photoview-container
          ports:
            - containerPort: 80
```

```
$ kubectl apply -f Deployment/blue-deployment.yaml
deployment.apps/blue-deployment created

$ kubectl apply -f Deployment/green-deployment.yaml
deployment.apps/green-deployment created

$ kubectl get pod
NAME                                 READY   STATUS        RESTARTS   AGE
blue-deployment-58d5d4869b-kmn88     1/1     Running       0          19s
blue-deployment-58d5d4869b-vlx2c     1/1     Running       0          19s
blue-deployment-58d5d4869b-w4729     1/1     Running       0          19s
green-deployment-5466fc4568-7hxqp    1/1     Running       0          15s
green-deployment-5466fc4568-mvs2w    1/1     Running       0          15s
green-deployment-5466fc4568-t8hp2    1/1     Running       0          15s
```

ê·¸ë¦¬ê³  ì´ `Deployment` ì˜ `ReplicaSet` ì˜ `Pod` ì— ì ‘ê·¼í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì‘ì„±í•˜ê³  ì‹¤í–‰í•œë‹¤.  

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webserver
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  selector: # ì ‘ê·¼í•  íŒŒë“œ ìˆ˜ì •
    app: photo-view
    ver: v1.0
```

```
$ kubectl apply -f Deployment/service.yaml
service/webserver created
```

ì´ì œ `service.yml` ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë§Œ ìˆ˜ì •í•´ì„œ ë‘ ë²„ì „ì˜ ë””í”Œë¡œì´ë¨¼íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ë©´ ëœë‹¤.  


# ìŠ¤ì¼€ì¼ëŸ¬ë¹Œë¦¬í‹°

ìˆœê°„ì ìœ¼ë¡œ ë§ì€ì–‘ì˜ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš° ì‹œìŠ¤í…œ ì²˜ë¦¬ëŠ¥ë ¥ì„ ë†’ì´ëŠ” ë°©ë²•  
ì‹œìŠ¤í…œ ì²˜ë¦¬ëŠ¥ë ¥ì„ ë†’ì´ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆë‹¤.  

- ìŠ¤ì¼€ì¼ ì•„ì›ƒ(ìˆ˜í‰ ìŠ¤ì¼€ì¼): ì‹œìŠ¤í…œ êµ¬ì„± ì„œë²„ ëŒ€ìˆ˜ë¥¼ ëŠ˜ë¦¼ìœ¼ë¡œ ì²˜ë¦¬ëŠ¥ë ¥ í–¥ìƒ, ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì¶”ê°€í•´ì•¼ í•˜ë©° ì‹œìŠ¤í…œì˜ ê°€ìš©ì„±ì´ ë†’ì•„ì§„ë‹¤.  
- ìŠ¤ì¼€ì¼ ì—…(ìˆ˜ì§ ìŠ¤ì¼€ì¼): ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤(CPU, Memory) ë¥¼ ì¦ê° ì‹œì¼œ ì²˜ë¦¬ëŠ¥ë ¹ í–¥ìƒ  

ìˆ˜ì§ì´ë˜ ìˆ˜í‰ì´ë˜ íŒŒë“œì™€ ë…¸ë“œë‹¨ìœ„ë¡œ ìŠ¤ì¼€ì¼(ì²˜ë¦¬ëŠ¥ë ¹ í–¥ìƒ) ê°€ëŠ¥í•˜ë‹¤.  

ì²˜ë¦¬ëŸ‰ì˜ ì¦ê°€ì •ë„ì— ë”°ë¼ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¼í• ì§€ ë…¸ë“œë¥¼ ìŠ¤ì¼€ì¼í• ì§€ ê²°ì •í•œë‹¤.  

## íŒŒë“œ ìˆ˜ë™ ìˆ˜í‰ ìŠ¤ì¼€ì¼ (`kubectl scale`)  

`kubectl scale` ëª…ë ¹ìœ¼ë¡œ íŒŒë“œ ìŠ¤ì¼€ì¼ì„ ëŠ˜ë¦´ ìˆ˜ ìˆë‹¤.  

ë¦¬í”Œë¦¬ì¹´ì…‹ìœ¼ë¡œ `nginx` íŒŒë“œë¥¼ 3ê°œ ìƒì„±  

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-replicaset
spec:
  replicas: 3
  selector:
    matchLabels:
      app: photo-view
  template:
    metadata:
      labels:
        app: photo-view
    spec:
      containers:
      - image: nginx
        name: photoview-container
```


```
$ kubectl apply -f HPA/pod-scale.yaml
replicaset.apps/nginx-replicaset created

$ kubectl scale --replicas=8 rs/nginx-replicaset
replicaset.apps/nginx-replicaset scaled

$ kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
nginx-replicaset-4bv5g   1/1     Running   0          19s
nginx-replicaset-4cjjq   1/1     Running   0          19s
nginx-replicaset-5z9qk   1/1     Running   0          19s
nginx-replicaset-bt98h   1/1     Running   0          19s
nginx-replicaset-c5fkk   1/1     Running   0          2m29s
nginx-replicaset-hnv8w   1/1     Running   0          2m29s
nginx-replicaset-nxtcn   1/1     Running   0          19s
nginx-replicaset-zbsd6   1/1     Running   0          2m29s
```

## íŒŒë“œ ìë™ ìˆ˜í‰ ìŠ¤ì¼€ì¼ (`HorizontalPodAutoscaler`)

`kubectl scale` ëª…ë ¹ìœ¼ë¡œ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤ì¼€ì¼í•˜ì˜€ë‹¤ë©´ `HorizontalPodAutoscaler` ì¿ ë²„ë„¤í‹°ìœ¼ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ ìë™ìœ¼ë¡œ ìˆ˜í‰ ìŠ¤ì¼€ì¼ ê°€ëŠ¥í•˜ë‹¤.  
ì¿ ë²„ëŠ” `CPU` ì‚¬ìš©ë¥ , ê¸°íƒ€ ë©”íŠ¸ë¦­ì„ ì²´í¬í•´ íŒŒë“œ ìŠ¤ì¼€ì¼ì´ ê°€ëŠ¥í•˜ë‹¤.  

> ë¦¬í”Œë¦¬ì¹´ì…‹ ì™¸ì—ë„ `Deployment`, `Relication Controller`, `StatefuleSet` ë“±ì˜ ë¦¬ì†ŒìŠ¤ì—ì„œ ìŠ¤ì¼€ì¼ë§ ê°€ëŠ¥í•˜ë‹¤.  

ë¨¼ì € ìŠ¤ì¼€ì¼ì „ì˜ ë¦¬í”Œë¦¬ì¹´ì…‹ì„ ìƒì„±í•œë‹¤.  

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: busy-replicaset
spec:
  replicas: 2
  selector:
    matchLabels:
      app: busy
  template:
    metadata:
      labels:
        app: busy
    spec:
      containers:
      - image: busybox
        name: hpa-container
        command: ["dd", "if=/dev/zero", "of=/dev/null"]
        resources:
          requests:
            cpu: 100m
          limits:
            cpu: 100m
```

ìë™ ìŠ¤ì¼€ì¼ì„ ìœ„í•´ì„  `requests`, `limits` ì†ì„±ì„ ë‘˜ë‹¤ ì„¤ì •í•  í•„ìš”ê°€ ìˆë‹¤.  
ë‚´ë¶€ì—ì„œ dd ëª…ë ¹ì„ í†µí•´ `limits` ì¸ `100m` ë§Œí¼ì˜ ì½”ì–´ê°€ ë˜ì–´ìˆë‹¤.  

```
$ kubectl apply -f HPA/replicaset-hpa.yaml
replicaset.apps/busy-replicaset created

$ kubectl get pod --show-labels
NAME                    READY   STATUS    RESTARTS   AGE   LABELS
busy-replicaset-w97wr   1/1     Running   0          35s   app=busy
busy-replicaset-z5sh8   1/1     Running   0          35s   app=busy

$ kubectl top pod
Error from server (NotFound): the server could not find the requested resource (get services http:heapster:)
```

ì´ ìƒíƒœì—ì„œ ìë™ ìŠ¤ì¼€ì¼ ê°€ëŠ¥í•˜ë„ë¡ `HorizontalPodAutoscaler` ë¦¬ì†ŒìŠ¤ë¥¼ ì‘ì„±  

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: budy-hpa
spec:
  minReplicas: 1   # ìµœì†Œ ë¦¬í”Œë¦¬ì¹´ ìˆ˜
  maxReplicas: 5   # ìµœëŒ€ ë¦¬í”Œë¦¬ì¹´ ìˆ˜
  metrics:
  - resource:
      name: cpu
      targetAverageUtilization: 30  # CPU ê°€ 30% ë˜ë„ë¡ ì¡°ì •
    type: Resource
  scaleTargetRef: # ìë™ìŠ¤ì¼€ì¼ ëŒ€ìƒ ë¦¬ì†ŒìŠ¤(ë¦¬í”Œë¦¬ì¹´ì…‹)ë¥¼ ê²°ì •
    apiVersion: apps/v1
    kind: ReplicaSet
    name: busy-replicaset
```


# ë°°ì¹˜ ì¡

ì›¹, DB ì„œë²„ì™€ ê°™ì€ ìƒì£¼ ì„œë¹„ìŠ¤ëŠ” íŒŒë“œë¥¼ í†µí•´ í•­ì‹œ ê´€ë¦¬ë˜ì§€ë§Œ  
ê¸°ê³„í•™ìŠµ, ë°°ì¹˜ì²˜ë¦¬ëŠ” `Job`, `CronJob` ì„ í†µí•´ ì‹¤í–‰ë˜ê³  ì •ì§€(ì‹¤í–‰ì™„ë£Œ)ëœë‹¤.  

## Job

`Job`ì€ í•˜ë‚˜ ì´ìƒì˜ íŒŒë“œì—ì„œ ë°°ì¹˜ì²˜ë¦¬ë¥¼ í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤.  
DB ë§ˆì´í¬ë ˆì´ì…˜ê°™ì€ í•œë²ˆì˜ ì‹¤í–‰ìœ¼ë¡œ ëë‚˜ëŠ” ê²ƒì— ì´ìš©ëœë‹¤.  

`Job` ì˜ ì‹¤í–‰ ì˜¤ë¥˜, ì˜ˆì™¸ ë°œìƒì‹œ `Job` ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì„±ê³µí•  ë•Œê¹Œì§€ íŒŒë“œë¥¼ ìƒˆë¡œ ìƒì„±í•´ ì‹¤í–‰ì‹œí‚¨ë‹¤.

## CronJob

`CronJob` ì€ ì •í•´ì§„ ì‹œê°„ì— `Job` ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤.  
ë°±ì—…, ë©”ì¼ ì†¡ì‹  ë“±ê³¼ ê°™ì€ ë°°ì¹˜ì²˜ë¦¬ì— ì‚¬ìš©ëœë‹¤.  

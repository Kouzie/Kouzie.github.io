---
title:  "쿠버네티스 - 헬름!"

read_time: false
share: false
author_profile: false
# classes: wide

categories:
  - docker
  - kubernetes

tags: kubernetes

toc: true
toc_sticky: true

---

## 헬름 개요

헬름은 여러 **차트(템플릿 파일들의 집합)** 를 관리하는 도구이다.  

차트가 저장된 차트 저장소를 통해 필요한 애플리케이션들을 빠르게 설치 가능하다.  

> 헬름 허브: <https://artifacthub.io/> 미리 작성된 차트 목록 확인 가능  

`Helm v2` 를 사용하고 있다면 `k8s cluster` 안에 `Tiller` 라는 별도의 `API Service` 를 설치해야 하지만  

2018년 `Helm` 이 `CNCF` 에 합류되고 `Helm v3` 가 출시되면서 `Tiller` 설치 없이 바로 `Helm Client` 를 통해 `k8s cluster` 에 서비스 설치가 가능해졌다.  


`Helm` 을 사용하면 각 환경별 템플릿을 작성할 필요 없이  
변경될수 있는 설정을 변수화 하여 최소한의 템플릿 으로 관리할 수 있도록 지원한다.  

또한 많은 오픈소스 제품들이 `k8s cluster` 안에서 동작할 수 있도록 `Helm 템플릿` 과 가이드를 제공한다.  


## 헬름 설치

> `Helm Hub`: 각 오픈소스 회사에서 Helm 을 통한 서비스 설치 가이드를 제공, `Helm Chart Repository` 에 템플릿을 다운받을 수 있다.  
> https://artifacthub.io/

> Helm docs kor: https://helm.sh/ko/docs/


`helm repo` 명령을 통해 `로컬 repo` 에 차트 저장하고 
`helm intall` 명령을 통해 `로컬 repo` 에 저장된 차트를 `k8s cluster` 에 배포한다.  



헬름은 아래 3가지 개념으로 이루어진다.  

- `차트(chart)`
- `컨피그(config)`
- `릴리즈(release)`


보통 헬름은 잘 만들어진 차트를 다운받아 사용하는데 웹상에 등록된 `stable repo` 로부터 다운 가능하다.  

`helm 허브`에서 `bitnami` 에서 제공하는 `tomcat 차트` 확인

```
$ helm repo add bitnami https://charts.bitnami.com/bitnami
$ helm repo list
NAME  	URL
bitnami	https://charts.bitnami.com/bitnami
```

`로컬 repo` 를 허브에 있는 `repo` 로 업데이트하고 그중에 `tomcat` 를 찾는 명령어, 그리고 삭제

```
$ helm repo update
$ helm search repo bitnami | grep tomcat
bitnami/tomcat                              	10.1.11      	10.0.16      	Apache Tomcat is an open-source web server desi...
$ helm repo delete
```


```
$ helm install my-tomcat bitnami/tomcat --version 10.1.10
```

## 헬름 차트 

위와 같이 `헬름 hub` 에 공개된 `repo` 를 통해 별도의 수정없이 바로 서비스를 설치해도 되지만  

좀더 디테일한 설정이 필요할 경우 `chart` 파일을 직적 다운받아 설정후 배포시킬 수 있다.  


```
[다운로드]
helm pull bitnami/tomcat --version 7.1.2

[압축풀기]
tar -xf ./tomcat-7.1.2.tgz

[Tomcat 배포]
helm install my-tomcat ./tomcat -f values.yaml

[NodePort 확인 및 접속]
kubectl get svc my-tomcat
NAME        TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
my-tomcat   LoadBalancer   10.233.13.72   <pending>     80:30152/TCP   12s

[배포 리스트 조회]
helm list

[배포 상태확인]
helm status my-tomcat

[Tomcat 삭제]
helm uninstall my-tomcat

[Pod 확인]
kubectl get pods
```

내부 구성은 다음과 같다.  

```
$ tree
.
├── Chart.yaml
├── README.md
├── ci
│   ├── ct-values.yaml
│   └── values-with-ingress-and-initcontainers.yaml
├── templates
│   ├── NOTES.txt
│   ├── _helpers.tpl
│   ├── deployment.yaml
│   ├── ingress.yaml
│   ├── pvc.yaml
│   ├── secrets.yaml
│   └── svc.yaml
└── values.yaml
```

`templates/deployment.yaml` 파일을 보면 아래와 같은데  

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: {{ template "tomcat.fullname" . }}
    labels: {{- include "tomcat.labels" . | nindent 4 }}
spec:
    strategy:
    type: {{ .Values.updateStrategy }}
    {{- if (eq "Recreate" .Values.updateStrategy) }}
    rollingUpdate: null
...
```

만약 `.Values.persistence.enabled` 변수를 커맨드를 통해 지정하고 싶다면 아래와 같이 사용할 수 있다.  


```
$ helm install my-tomcat bitnami/tomcat --version 7.1.2 --set persistence.enabled=false
```

`values.yaml` 를 확인하면 default 로 들어가는 변수들을 작성해 두었기 때문에 해당 파일을 수정해도 된다.  

`Chart.yaml` 과  `README.md` 파일은 차트를 `helm 허브` 에 올렸을때 출력되는 내용임으로 해다 차트에 대한 정보가 자세하게 작성되어 있다.  


배포된 차트의 상세한 정보는 `helm get` 명령을 통해 어떻게 배포되었는지 알 수 있다.  

```
helm get manifest mychart # manifest(configmap) 에 대한 정보만
helm get notes mychart # notes 에 대한 정보만 
helm get values mychart # values 에 대한 정보만
helm get all mychart # 모든 정보 조회
```

### 헬름 차트 만들기

```
$ helm create mychart
$ tree
.
├── Chart.yaml
├── charts
├── templates
│   ├── NOTES.txt
│   ├── _helpers.tpl
│   ├── deployment.yaml
│   ├── hpa.yaml
│   ├── ingress.yaml
│   ├── service.yaml
│   ├── serviceaccount.yaml
│   └── tests
│       └── test-connection.yaml
└── values.yaml
```


보통 dev, prod 2개의 환경으로 나누었을 때 `values_dev.yaml`, `values_prod.yaml` 2개로 나누어서 아래 명령으로 설치한다.  

```
$ helm install mychart . -f values_prod.yaml
```

설정파일보다 커맨드를 더 우선시하기때문에 특정 변수에 대해서 `-set` 옵션을 사용할 수 있다.  
```
$ helm install mychart . -f values_prod.yaml -set configMapData.log=debug
```



#### 차트 데이터 확인  

```
# values, chart, readme 에 대한 정보 출력  
$ helm show all .

$ cat templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mychart.fullname" . }}
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "mychart.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "mychart.selectorLabels" . | nindent 8 }}
```

`templates/deployment.yaml` 을 열어보면 여러가지 변수들이 설정 대기중임을 알수 있고  
`values.yaml` 를 확인하면 `nginx` 에 대한 기본 설정들이 작성되있음을 알 수 있다.   

`helm template` 커맨드를 통해 `values` 가 적용된 `deployment.yaml` 의 데이터를 미리 확인해 볼 수 있다.  

```
$ helm template mychart .
# Source: mychart/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mychart
  labels:
    helm.sh/chart: mychart-0.1.0
    app.kubernetes.io/name: mychart
    app.kubernetes.io/instance: mychart
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
```



## 명령어 요약 




| 명령어                                   | 설명                                                      |
| ---------------------------------------- | --------------------------------------------------------- |
| `helm create <CHART_NAME>`               | 차트를생성한다.                                           |
| `helm install <CHART_NAME>`              | <CHART_PATH>	차트를 설치한다.                             |
| `helm list (-n <NAMESPACE>)`             | (네임스페이스의) 차트 목록을 조회한다.                    |
| `helm template <CHART_NAME>`             | 차트 랜더링(values.yaml이 적용된 템플릿 생성)을 수행한다. |
| `helm upgrade <CHART_NAME> <CHART_PATH>` | 설치한 차트에 대해 수정한 values.yaml을 적용한다.         |
| `helm status <CHART_NAME>`               | 차트 배포상태를 확인한다.                                 |
| `helm delete <CHART_NAME>`               | 차트를 삭제한다.                                          |
| `helm repo add <REPO_NAME> <URL>`        | 차트를 저장하는 원격 저장소를 추가한다.                   |
| `helm repo update`                       | 원격 저장소를 최신 상태로 업데이트한다.                   |
| `helm repo list`                         | 원격 저장소 목록을 조회한다.                              |
| `helm search repo <REPO_NAME>`           | 원격 저장소 내의 차트 목록을 조회한다.                    |
| `helm fetch <REPO_NAME>/<CHART_NAME>`    | 원격 저장소의 차트를 로컬 디렉토리로 다운로드한다.        |


---
title:  "spring cloud - gateway!"

read_time: false
share: false
author_profile: false
classes: wide

categories:
  - spring

tags:
  - eureka
  - spring-cloud

toc: true

---

## spring cloud gateway

`jvm`기반의 라우터이자 부하분산기인 `netflix zuul`라이브러리를 사용했다.  

스프링 프레임워크에서 `api 게이트웨이`는 `zuul`이 유일했으나 `spring cloud gateway`라는 새로운 프로젝트가 만들어지면서 상황이 많이 바꼈다.  


스프링 클라우드 게이트웨이에는 3가지 기본 개념이 있다.  

`route`
`predicates`(조건자)
`filters`(필터)

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

기본적인 `application.properties` 설정

```conf
server.port=8008
eureka.client.service-url.defaultZone=http://admin:qwer@localhost:8761/eureka/
eureka.client.register-with-eureka=false

spring.application.name=gateway-service
management.endpoints.web.exposure.include=*
management.endpoint.gateway.enabled=true

spring.cloud.gateway.discovery.locator.enabled=true

spring.cloud.gateway.routes[0].id=account-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/api/account/**
spring.cloud.gateway.routes[0].filters[0]=PrefixPath=/api
spring.cloud.gateway.routes[0].filters[1]=RewritePath=/customer/(?<path>.*),/${path}
spring.cloud.gateway.routes[0].uri=lb://account-service
```

위의 설정은 아래처럼 `java config`로 변경 가능하다.  

```java
@Bean
public RouteLocator customRouteLocator(RouteLocatorBuilder routeLocatorBuilder) {
  return routeLocatorBuilder.routes()
    .route("account-service", new Function<PredicateSpec, AsyncBuilder>() {
      @Override
      public AsyncBuilder apply(PredicateSpec predicateSpec) {
        return predicateSpec
          .path("/api/account/**")
          .filters(new Function<GatewayFilterSpec, UriSpec>() {
            @Override
            public UriSpec apply(GatewayFilterSpec gatewayFilterSpec) {
              return gatewayFilterSpec
                .prefixPath("/api")
                .rewritePath("/account/(?<path>.*)", "${path}");
            }
          })
          .uri("lb://account-service");
      }
    })
    .route("customer-service", predicateSpec -> predicateSpec
      .path("/api/customer/**")
      .filters(gatewayFilterSpec -> gatewayFilterSpec
        .prefixPath("/api")
        .rewritePath("/customer/(?<path>.*)", "${path}"))
      .uri("lb://customer-service"))
    .route("order-service", predicateSpec -> predicateSpec
      .path("/api/order/**")
      .filters(gatewayFilterSpec -> gatewayFilterSpec
        .prefixPath("/api")
        .rewritePath("/order/(?<path>.*)", "${path}"))
      .uri("lb://order-service"))
    .route("product-service", predicateSpec -> predicateSpec
      .path("/api/product/**")
      .filters(gatewayFilterSpec -> gatewayFilterSpec
        .prefixPath("/api")
        .rewritePath("/product/(?<path>.*)", "${path}"))
      .uri("lb://product-service"))
    .build();
}
```


### gateway actuator api list 

> https://cloud.spring.io/spring-cloud-gateway/multi/multi__actuator_api.html

`ID` | `HTTP Method` | `Description`
|---|---|---|
`globalfilters` | `GET` | Displays the list of global filters applied to the routes.
`routefilters` | `GET` | Displays the list of GatewayFilter factories applied to a particular route.
`refresh` | `POST` | Clears the routes cache.
`routes` | `GET` | Displays the list of routes defined in the gateway.
`routes/{id}` | `GET` | Displays information about a particular route.
`routes/{id}` | `POST` | Add a new route to the gateway.
`routes/{id}` | `DELETE` | Remove an existing route from the gateway.

`/actuator/gateway/routes/order-service`

```json
{
  "predicate": "Paths: [/order/**], match trailing slash: true",
  "route_id": "order-service",
  "filters": ["[[RewritePath /order/(?<path>.*) = '${path}'], order = 0]"],
  "uri": "lb://order-service",
  "order": 0
}
```

---
title:  "DB 2일차!"

header:
  overlay_image: /assets/DB/dbimage.jpg
  caption: "Photo credit: [**oracle**](https://www.oracle.com)"

read_time: false
share: false
author_profile: false
# classes: wide

categories:
  - DataBase
---


## GRANT 구조

GRANT 시스템권한명 또는 롤명 TO 사용자명 또는 롤명 또는 PUBLIC

```sql
[WITH ADMIN OPTION];
```

`WITH ADMIN OPTION` 은 해당 시스템 권한을 __다른 사용자나 롤에 재부여를 허용__

PUBLIC 은 모든 사용자에게 권한을 주기 위한 것으로 권한을 주는 쪽은 신중해야 한다.  
PUBLIC으로 선언된 권한은 이 후에 새로 생성된 사용자에게도 자동으로 해당 권한이 부여되기 때문이다.  

hr 계정에서 scott 계정의 emp 테이블을 select 할 수 있도록 권한 설정  
```sql
GRANT SELECT ON emp TO HR;
```


#### PUBLIC Synonym 생성하는법

all_users는 sys계정이 아니더라도 어떤 계정이던 접근 가능하다. GRANT 명령으로 public으로 접근권한이 부여되어 있기 때문이다.

public으로 인해 다른계정에서 접근하는 것 이해가 되는데 SYS계정 소유의 테이블, dictionary인데 `스키마명.객체명` 형식으로 사용하지 않는다.

이는 해당 테이블에 PUBLIC synonym이 설정되어 있기 때문. 계속 스키마 명을 쓰는게 번거롭기 때문에 사용.

**PUBLIC Synonym 생성하는법**
1. SYSTEM 권한으로 접속한다.  
2. PUBLIC 옵션을 사용하여 시노님을 생성한다.  
3. 생성된 시노님에 대해 객체 소유자로 접속한다.  
4. 시노님에 권한을 부여한다.  

**형식**
```sql
CREATE [PUBLIC] SYNONYM [schema.]synonym명
FOR [schema.]object명;
```

```sql
CREATE PUBLIC SYNONYM pub_test
FOR kim.test;
```
kim.test에 대해 public 시노님(pub_test)을 생성. 이제 kim.test 객체는 모든 사용자가 pub_test라는 이름으로접근 가능하다.


### 오라클 계정

**SYS** : 오라클 Super사용자 계정, DB에서 발생하는 모든 문제들을 처리할 수 있는 권한을 가지고 있다.  
**SYSTEM** : 오라클 데이터베이스 유지보수, 관리 시 사용, DB생성 권한이 없고 불완전 복구 안됨.  
**HR** : 오라클 DB 실습을 위해 만들어 놓은 교육용 계정.  

SQL plus를 사용해서 로그인, 쿼리 질의해보기
sys계정으로 로그인.  

![image10](/assets/DB/days01/image10.png)  
로그인 오류... SYS로 연결하려면 SYSDBA나 SYSOPER로 연결해야 한다고 함.

![image11](/assets/DB/days01/image11.png)  
SYS로 로그인 하려면 as sysdba를 붙여줘야함.
명령 프롬프트도 “SQL>” 로 바뀌었다.

![image12](/assets/DB/days01/image12.png)  
SQL 프롬프트에서 현재 연결된 계정 출력

SQL plus에서 해도 좋지만 클라이언트에서 질의하기 위한 SQL *Plus는 Oracle SQL Developer 사용할 것임.


#### Oracle SQL Developer에서 DB와 연결하기
![image13](/assets/DB/days01/image13.png){: .shadow}    


테스트 버튼 클릭 시 SYS계정은 SYSDBA로 연결하라고 한다.  
롤에서 기본값 말고 SYSDBA로 바꿔 줘야함.  
![image14](/assets/DB/days01/image14.png){: .shadow}    
<br>

저장하고 접속하자.
![image15](/assets/DB/days01/image15.png){: .shadow}    
지정한 빨간색 테두리가 생기면서 접속...
<br>

접속하고 질의 작성기 워크시트에 SQL를 쓰고 실행.
![image16](/assets/DB/days01/image16.png){: .shadow}    

SQL은 대소문자 구분을 하지 않기 때문에 `select * from TABS;` 로 사용해도 상관없지만
질의는 대문자, 테이블은 소문자로 쓰는 걸 권장한다.  

`SELECT * FROM all_users;` 실행  
![image17](/assets/DB/days01/image17.png){: .shadow}    

모든 사용자 계정을 출력한다.  


### DB 사용자 계정을 만들어보자.

**사용자 만드는 쿼리 형식**


<table border="1" cellspacing="0" cellpadding="0">
 <tr>
   <td rowspan="3">
     CREATE USER <i>user</i> IDENTIFIED
   </td>
   <td>
     BY <i>password</i>
   </td>
   <td rowspan="3">필요한 경우
   </td>
   <td rowspan="3">;
   </td>
 </tr>
 <tr>
   <td>EXTERNALLY [AS 'certificate']
   </td>
 </tr>
 <tr>
   <td>GLOBALLY [AS '[directory_DN]'<p></p>
   </td>
 </tr>
</table>

<p><strong>추가 옵션</strong></p>

<table border="1" cellspacing="0" cellpadding="0">
<tr>
 <td>
   DEFAULT TABLESPACE <i>tablespace</i>
 </td>
 <td rowspan="6">
   ...
 </td>
</tr>
<tr>
 <td>
   TEMPORARY TABLESPACE {tablespace ¦
   tablespace_group_name}
 </td>
</tr>
<tr>
 <td>
   {QUOTA {size_clause ¦ UNLIMITED} ON tablespace}...
 </td>
</tr>
<tr>
 <td>
   PROFILE <i>profile</i>
 </td>
</tr>
<tr>
 <td>PASSWORD EXPIRE
 </td>
</tr>
</table>




CREATE USER SQL문을 실행하려면 [CREATE USER] [시스템 권한] 이 있어야 한다.  

SYS에는 당연히 모든 권한이 있으니 SCOTT이라는 계정을 만들어 보자(비번은 대소문자 구분함).  

`CREATE user SCOTT IDENTIFIED BY tiger;`  

![image18](/assets/DB/days01/image18.png){: .shadow}    

만든 계정으로 새 접속을 만들어보자  
![image19](/assets/DB/days01/image19.png){: .shadow}  

ORA- 01045 에러 메시지와 함께 CREATE SESSION 권한이 없어 로그인 불가라고 떴다.

생성된 사용자에게 세션 권한을 열어주어야 사용 가능하다.

권한을 줄 때는 GRANT (DCL명령어) SQL문을 사용하면 됨

---

### 오라클 권한의 종류는 2 가지다

**1. System privilege (시스템 권한)**  
데이터 베이스 객체를 생성, 수정, 삭제할 수 있는 권한  

**2. Object privilege (객체 권한)**  
Object 내용을 조작(추가, 수정, 삭제, 검색)할 수 있는 권한  

CREATE SESSION 권한은 시스템 권한 중 하나이다. GRANT 명령을 통해 이 권한을 SCOTT에게 주도록....

GRANT의 사용법대로 CREATE SESSION을 주려면 다음과 같이 하면 된다.

`GRANT CREATE SESSION TO SCOTT;`

접속하는 권한은 주었다! 하지만 접속만 된다!  
테이블을 만들고, 검색하고, 조작하려면 엄청 많은 권한들이
필요한데 이런 권한들을 하나하나 부여할 수 있지만 너무 힘들다.

이런 여러 개의 권한들을 묶은 role을 만들어서 한꺼번에 권한을 부여할 수도 있기 때문에 통째로(role) 권한
부여하자.  
`GRANT connect, resource to SCOTT;`  
connect와 resource 롤 안에는 다음과 같은 권한이 있음.  


<table>
 <tbody><tr>
  <td valign="top">
  <p align="center"><b><span lang="EN-US">Role 이름 <span lang="EN-US"></span></span></b></p>
  </td>
  <td valign="top">
  <p align="center"><b><span>설명 <span lang="EN-US"></span></span></b></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p align="left"><span lang="EN-US">connect </span></p>
  </td>
  <td valign="top">
  <p align="left"><span lang="EN-US">• DB</span><span>에 접속할 수 있는 권한<span lang="EN-US"><br>
  • SQL.BSQ </span>스크립트에 의해서 생성됨<span lang="EN-US"><br>
  • </span>포함되는 시스템 권한<span lang="EN-US"> :<br>
  <span>ALTER SESSION, CREATE CLUSTER, CREATE DATABASE LINK,
  CREATE SEQUENCE, CREATE SESSION, CREATE SYNONYM, CREATE TABLE, CREATE VIEW</span>
  </span></span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p align="left"><span lang="EN-US">resource </span></p>
  </td>
  <td valign="top">
  <p align="left"><span lang="EN-US">• </span><span>오라클<span lang="EN-US">
  DB</span>의 기본 개체<span lang="EN-US">(TABLE, VIEW, INDEX</span>등<span lang="EN-US">)</span>를
  생성<span lang="EN-US">.</span>변경<span lang="EN-US">.</span>삭제할 수 있는 권한을 가짐<span lang="EN-US"><br>
  • SQL.BSQ </span>스크립트에 의해서 생성됨<span lang="EN-US"><br>
  • </span>포함되는 시스템 권한<span lang="EN-US"> :<br>
  <span>CREATE CLUSTER, CREATE INDEXTYPE, CREATE OPERATOR,
  CREATE PROCEDURE, CREATE SEQUENCE, CREATE TABLE, CREATE TRIGGER, CREATE TYPE</span></span></span></p>
  </td>
 </tr>
</tbody></table>


![image20](/assets/DB/days01/image20.png){: .shadow}    

접속 성공


이번엔 연습용 계정인 HR에 로그인 해보자
![image21](/assets/DB/days01/image21.png){: .shadow}    

ORA- 28000 에러코드와 함께 계정이 잠겨 있다고 한다.

관리자가 Lock을 걸었거나 유효기간 만료, 접속시도를 과도하게 실패하면 Lock될수 있다.   
이때 해당 계정에 대한
LOCK정보는 **DBA_USERS** data DICTIONARY에서 확인할 수 있다.  

`SELECT USERNAME, ACCOUNT_STATUS FROM DBA_USERS;`  
![image22](/assets/DB/days01/image22.png){: .shadow}    

HR계정의 상태가 **EXPIRED & LOCKED** 되어있다.  


### ALTER 명령을 사용하면 잠금해제 가능하다.

<table border="1" cellspacing="0" cellpadding="0">
 <tbody><tr>
  <td rowspan="13">
  <p align="center"><b><span lang="EN-US">ALTER USER</span></b></p>
  </td>
  <td rowspan="12">
  <p align="center"><span lang="EN-US">user</span></p>
  </td>
  <td rowspan="3">
  <p align="center"><span lang="EN-US">IDENTIFIED</span></p>
  </td>
  <td>
  <p><span lang="EN-US">BY password [REPLACE
  old_password] </span></p>
  </td>
  <td rowspan="13">
  <p><b><span lang="EN-US">... </span></b></p>
  </td>
  <td rowspan="13">
  <p><b><span lang="EN-US">;</span></b></p>
  </td>
 </tr>
 <tr>
  <td>
  <p><span lang="EN-US">EXTERNALLY [AS
  'certificate_DN']</span></p>
  </td>
 </tr>
 <tr>
  <td>
  <p><span lang="EN-US">GlOBALLY [AS
  'directory_DN']</span></p>
  </td>
 </tr>
 <tr>
  <td colspan="2">
  <p><span lang="EN-US">DEFAULT TABLESPACE
  tablespace</span></p>
  </td>
 </tr>
 <tr>
  <td colspan="2">
  <p><span lang="EN-US">TEMPORARY TABLESPACE
  {tablespace ¦ tablespace_group_name}</span></p>
  </td>
 </tr>
 <tr>
  <td colspan="2">
  <p><span lang="EN-US">{QUOTA {size_clause ¦
  UNLIMITED} ON tablespace}...</span></p>
  </td>
 </tr>
 <tr>
  <td colspan="2">
  <p><span lang="EN-US">PROFILE profile</span></p>
  </td>
 </tr>
 <tr>
  <td rowspan="3">
  <p align="center"><span lang="EN-US">DEFAULT ROLE</span></p>
  </td>
  <td>
  <p><span lang="EN-US">role,...</span></p>
  </td>
 </tr>
 <tr>
  <td>
  <p><span lang="EN-US">ALL [EXCEPT
  {role,...}]</span></p>
  </td>
 </tr>
 <tr>
  <td>
  <p><span lang="EN-US">NONE</span></p>
  </td>
 </tr>
 <tr>
  <td colspan="2">
  <p><span lang="EN-US">PASSWORD EXPIRE</span></p>
  </td>
 </tr>
 <tr>
  <td colspan="2">
  <p><span lang="EN-US">ACCOUNT {LOCK ¦
  UNLOCK}</span></p>
  </td>
 </tr>
 <tr>
  <td>
  <p align="center"><span lang="EN-US">user,...</span></p>
  </td>
  <td colspan="2">
  <p><span lang="EN-US">proxy_clause</span></p>
  </td>
 </tr>
</tbody></table>



`ALTER USER HR IDENTIFIED BY lion ACCOUNT UNLOCK;`  
![image23](/assets/DB/days01/image23.png){: .shadow}    

IDENTIFIED BT lion은 비밀번호 설정하는 것. 생략가능 하지만 비밀번호도 lion으로 바꾸자.

HR의 상태정보를 다시 출력하면
```
SELECT USERNAME, ACCOUNT_STATUS
FROM dba_users
WHERE USERNAME='HR';
```
![image24](/assets/DB/days01/image24.png){: .shadow}    

**EXPIRED & LOCKED** 상태였었는데 **OPEN**으로 바뀌었다.  


### 실습환경 구축

친절한 오라클이 계정생성후 테이블을 만들어서 테스트 환경을 바로 만들수 있도록 명령어 모음을 다 짜주었다!

SCOTT 계정 생성과 동시에 아래 파일이 자동 생성된다.

C:\oraclexe\app\oracle\product\11.2.0\server\rdbms\admin  
위치의 **scott.sql** 이라는 파일이 있다.
오라클에서 계정 추가 시 테스트해보라고 주는 sql 명령어 들이다.

해당 파일 안에 여러 테이블을 만들고 데이터를 집어넣는 명령어들이 있다.

참고로 이 sql파일을 사용하기 전에 비밀번호가 대문자로 자동 생성되었는데 소문자로 바꿔주어야 함.
![image25](/assets/DB/days01/image25.png){: .shadow}    


그럼 sqlplus에서 이 sql파일을 통째로 실행시키자.

SCOTT계정으로 로그인.  
![image26](/assets/DB/days01/image26.png){: .shadow}  

@를 앞에 붙이고 sql파일 경로를 붙여넣기
![image27](/assets/DB/days01/image27.png){: .shadow}  

@이는 sql 스크립트 파일을 실행시키는 sqlplus 명령어,  
`@`대신 `RUN`, `r`을 써도 된다.  
다시 SQL Developer로 가서 모든 테이블을 출력  

`SELECT * FROM tabs;`
4 개의 table이 생겼다!
![image28](/assets/DB/days01/image28.png){: .shadow}  


실습을 위해 insa.sql 파일안의 명령어를 SCOTT 계정에서 수행해보자.

```
CREATE TABLE insa(
num NUMBER(5) NOT NULL CONSTRAINT insa_pk PRIMARY KEY
,name VARCHAR2(20) NOT NULL
,ssn VARCHAR2(14) NOT NULL
,ibsaDate DATE NOT NULL
,city VARCHAR2(10)
,tel VARCHAR2(15)
,buseo VARCHAR2(15) NOT NULL
,jikwi VARCHAR2(15) NOT NULL
,basicPay NUMBER(10) NOT NULL
,sudang NUMBER(10) NOT NULL
);

INSERT INTO insa (num, name, ssn, ibsaDate, city, tel, buseo, jikwi, basicPay, sudang) VALUES
(1001, '홍길동', '771212-1022432', '1998- 10 - 11', '서울', '011- 2356 - 4528', '기획부',
'부장', 2610000, 200000);
...
...
INSERT INTO insa (num, name, ssn, ibsaDate, city, tel, buseo, jikwi, basicPay, sudang) VALUES
(1060, '김신애', '810809-2111111', '2001- 10 - 10', '서울', '011- 4151 - 4444', '개발부',
'사원', 900000 , 102000);

COMMIT;
```

INSA 테이블이 만들어지고 데이터들이 INSERT되어다.  
DESCRIBE INSA; 명령어로 INSA테이블 구조를 확인해 보자.  
DESC INSA; 로 줄일 수 있음  
![image29](/assets/DB/days01/image29.png){: .shadow}  

`SELECT * FROM tabs;`

tabs: 사용자가 만든 테이블에 대한 자세한 정보 user_tables의 줄임말.  
tabs는 테이블은 아니고 Dictionary라고 하는데 오라클 DB가 변경되면 자동으로 업데이트 되는 정보? 이다.  

INSA테이블을 다양한 방법으로 검색해보자  
```
SELECT *
FROM INSA;
```
![image30](/assets/DB/days01/image30.png){: .shadow}  
INSA의 모든 칼럼을 출력한다.


```
SELECT NUM, NAME
FROM INSA;
```
![image31](/assets/DB/days01/image31.png){: .shadow}  
INSA의 NUM과 NAME칼럼만 출력

```
SELECT DISTINCT BUSEO
FROM INSA;
```
![image32](/assets/DB/days01/image32.png){: .shadow}  
BUSEO 컬럼에서 중복 제거해서 출력

사실 그냥 SELECT문을 쓰면 아래와 같이 ALL이 자동 생략되어있는 상태,
```
SELECT ALL *
FROM INSA;
```

```
SELECT DISTINCT BUSEO as 부서번호, BUSEO as "부서번호"
FROM INSA;
```
![image33](/assets/DB/days01/image33.png){: .shadow}  

칼렴명에 별칭(alias)을 줘서 출력할 수 있다.  
별칭은 쌍 따옴표로 묶어도 되고 안 묶어도 되는데 띄어쓰기를
쓸꺼면 묶어야 한다.  
중복된 별칭은 자동으로 뒤에 _ 1 이란 숫자가 붙는다.  

```
SELECT employee_id as eid, first_name || ' ' || last_name as "NAME"
FROM EMPLOYEES;
```
![image34](/assets/DB/days01/image34.png){: .shadow}  

두개 이상의 칼럼을 하나의 칼럼으로 묶고 싶다면 || 키워드를 사용,  
도중에 특정 문자열을 사용하고 싶다면 홀따옴표를 사용하면 된다.  
SQL에선 문자열이나 날자형은 홀따옴표로 묶는다.  

별칭(alias)에는 쌍따옴표로 묶는다.  


# GRANT, SQL Operator, NVL

## table dictionary

tabs는 user_tables의 약어이다. 해당 계정이 가지고 있는 모든 테이블을 출력한다.  
만약 DB안에 있는 모든 테이블을 보고 싶다면 **dba_tables dictionary** 를 사용하면 된다.  
dba_tables 접근권한은 SYS가 가지고 있다.  

`SELECT * FROM dba_tables WHERE OWNER = 'HR';`  
HR 계정에 관한 모든 테이블을 출력한다. (계정 이름 대소문자 구분 필수)  

## user dictionary

**1. all_users**  
DB의 모든 계정을 출력, (이름, UID, 생성일)  
![image1](/assets/DB/days02/image1.png){: .shadow}  
`SELECT * FROM all_users;`   
![image2](/assets/DB/days02/image2.png){: .shadow}  
<br><br>

**2. dba_users**  
DB의 모든 계정을 출력하는건 all_users와 같지만 출력하는 컬럼 수가 훨씬 많다. 비밀번호는 출력안됨...  
![image3](/assets/DB/days02/image3.png){: .shadow}  

SYS계정에서만 접근할 수 있다.  
`SELECT * FROM dba_users;`   
![image4](/assets/DB/days02/image4.png){: .shadow}  
<br><br>

**3. user_users**  
현재 사용자의 관한 정보를 출력  
![image5](/assets/DB/days02/image5.png){: .shadow}  
`SELECT * FROM user_users;`  
![image6](/assets/DB/days02/image6.png){: .shadow}  
<br><br>

# Privilege(권한)

권한이란 SQL 문을 실행하거나, 데이터베이스나 데이터베이스의 객체에 접근할 수 있는 권한을 의미한다.

크게 시스템 권한과 객체 권한으로 나누어져 있는데 사용자에게 어떤 권한이 할당 되어있는지 검색해보자.

1. 사용자에게 부여된 시스템 권한 확인
```sql
SELECT * FROM DBA_SYS_PRIVS
WHERE GRANTEE = 'SCOTT';
```
![image7](/assets/DB/days02/image7.png){: .shadow}  
**UNLIMITED TABLESPACE**는 사용자 생성시 자동으로 부여되는 __시스템 권한__, 객체를 만들 수 있게 해준다.
<br>

2. 사용자에게 부여한 객체(테이블등) 권한 확인
```sql
SELECT * FROM DBA_TAB_PRIVS
WHERE OWNER = 'SCOTT';
```
![image8](/assets/DB/days02/image8.png){: .shadow}  
현재 SCOTT의 EMP테이블에 HR이 SELECT 접근이 가능한 상태이다.
<br>

3. 사용자에게 부여된 롤 확인(시스템 권한이 롤에 포함됨)
```sql
SELECT * FROM DBA_ROLE_PRIVS
WHERE GRANTEE = 'SCOTT';
```
![image9](/assets/DB/days02/image9.png){: .shadow}  
---
title:  "k8s - ê°œìš”!"

read_time: false
share: false
author_profile: false
toc: true
toc_sticky: true
## classes: wide

categories:
  - kubernetes
---


## k8s ê°œìš”

êµ¬ê¸€ì—ì„œ ìŠ¤íƒ€íŠ¸í•œ ì˜¤í”ˆì†ŒìŠ¤ë¡œ êµ¬ì„±ëœ ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íˆ´.  

ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íˆ´ì€ k8s ì™¸ì—ë„ Amazone ECS, ë„ì»¤ ìŠ¤ì›œ, ì•„ë§ˆì¹˜ ë…¸ë§ˆë“œ, ì•„íŒŒì¹˜ Mesos ë“±ì´ ìˆë‹¤.  

ì´ì¤‘ì—ì„œ ê°€ì¥ ì¸ê¸°ìˆëŠ” ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íˆ´ì´ k8s ì´ë‹¤.  

### docker desktop

k8s ì‹¤ìŠµìš©ìœ¼ë¡œ ì‹¤ì œ í´ëŸ¬ìŠ¤í„°ìš© PC ë¥¼ ì—¬ëŸ¬ëŒ€ êµ¬ë§¤í•˜ì—¬ êµ¬ì¶•í•˜ë©´ ì¢‹ê² ì§€ë§Œ   
`docker desktop` ìœ¼ë¡œ k8së¥¼ ì‰½ê²Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.  

![kube7](/assets/k8s/kube7.png)  

> ë³„ë‹¤ë¥¸ ì´ìœ ê°€ ì—†ë‹¤ë©´ `docker desktop` ì„ ì‚¬ìš©í•˜ëŠ”ê²ƒì„ ì¶”ì²œ

### minikube ì„¤ì¹˜

`minikube` ë¡œë„ ë¡œì»¬í”¼ì‹œì— k8s í™˜ê²½ êµ¬ì¶•ì´ ê°€ëŠ¥í•˜ë‹¤.  

ê°€ìƒí™˜ê²½ì€ ê¸°ë³¸ì ìœ¼ë¡œ `docker` ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•œë‹¤.  

```
$ brew install minikube
$ minikube start --driver=docker
ğŸ˜„  Darwin 10.15.4 ìœ„ì˜ minikube v1.9.2
...
ğŸ„  ëë‚¬ìŠµë‹ˆë‹¤! ì´ì œ kubectl ì´ "minikube" ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤
$ minikube config set driver docker ## docker ë¥¼ ê¸°ë³¸ ê°€ìƒë“œë¼ì´ë²„ë¡œ ì„¤ì •  

$ minikube status # ì‹¤í–‰ëœ minikube ìƒíƒœ ì¡°íšŒ  
m01
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

$ docker ps
CONTAINER ID        IMAGE                                COMMAND                  CREATED             STATUS              PORTS                                                                           NAMES
2f61e951c809        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   13 minutes ago      Up 10 minutes       127.0.0.1:32773->22/tcp, 127.0.0.1:32772->2376/tcp, 127.0.0.1:32771->8443/tcp   minikube

$ minikube stop
$ minikube start
```

`kubectl` ëª…ë ¹ì„ í†µí•´ ë¡œì»¬ì— ì„¤ì¹˜ëœ í´ëŸ¬ìŠ¤í„°ë¥¼ ì¡°ì‘ ê°€ëŠ¥í•˜ë‹¤.  

```
$ kubectl get node -o=wide
NAME       STATUS   ROLES    AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION     CONTAINER-RUNTIME
minikube   Ready    master   4m25s   v1.18.0   172.17.0.2    <none>        Ubuntu 19.10   4.19.76-linuxkit   docker://19.3.2
$ kubectl version --output yaml ## ë²„ì „ í™•ì¸
```

### k8s cli tool - kubectl

ë§ˆìŠ¤í„° ì»´í¬ë„ŒíŠ¸ ì¤‘ í•˜ë‚˜ì¸ `API Server` ì™€ í†µì‹ í•˜ê¸° ìœ„í•´ `kubectl` ëª…ë ¹ì„ ì‚¬ìš©í•œë‹¤.   
`kubectl` ê³¼ `API Server`ê°€ ì–´ë–»ê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ ì•Œì•„ë³´ì.  

```
$ ls ~/.kube
cache
config
http-cache
```

```yaml
clusters:
- cluster:
    certificate-authority: /Users/gojiyong/.minikube/ca.crt
    server: https://127.0.0.1:32768
  name: minikube 
## kubectl ëª…ë ¹ ì‹¤í–‰ì‹œ ì‚¬ìš©í•  í´ëŸ¬ìŠ¤í„° ì •ë³´

contexts:
- context:
    cluster: minikube
    user: minikube
  name: minikube
current-context: minikube
kind: Config
preferences: {}
## í´ëŸ¬ìŠ¤í„° ì‚¬ìš©ì ì •ë³´ context, 

users:
- name: minikube
  user:
    client-certificate: /Users/gojiyong/.minikube/profiles/minikube/client.crt
    client-key: /Users/gojiyong/.minikube/profiles/minikube/client.key
## ì—‘ì„¸ìŠ¤ í•˜ëŠ” ì‚¬ìš©ì ì •ë³´ - í´ëŸ¬ìŠ¤í„° ì—‘ì„¸ìŠ¤ë¥¼ ìœ„í•œ ì¸ì¦ í‚¤ ë“± ì„¤ì •  
```

## k8s ì•„í‚¤í…ì²˜

k8sëŠ” ì•„ë˜ì™€ ê°™ì€ ì—¬ëŸ¬ê°œì˜ ì»´í¬ë„ŒíŠ¸ë¡œ ì´ë£¨ì–´ì§„ë‹¤.  

![kube1](/assets/k8s/kube1.png)  

> ë§ˆìŠ¤í„° ì»´í¬ë„ŒíŠ¸ ëª¨ìŒì„ í†µì¹­í•´ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸(`Control Plane`) ì´ë¼ê³  í•œë‹¤.

- k8s control plane (ë§ˆìŠ¤í„° ì»´í¬ë„ŒíŠ¸)  
  1. `kube-api-server`  
  2. `kube-scheduler`(ìŠ¤ì¼€ì¤„ëŸ¬)  
  3. `kube-controller-manager`(ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤ë‹ˆì €)  
  4. `etcd`(ë°ì´í„° ìŠ¤í† ì–´)  

- k8s node(ë…¸ë“œ ì»´í¬ë„ŒíŠ¸)  
  1. `kubelet`  
  2. `kube-proxy`  

k8sëŠ” ì•„í‚¤í…ì²˜ëŠ” ì „ì²´ì ìœ¼ë¡œ `master` ì™€ `node` ë¡œ êµ¬ì„±ë˜ë©°  
`master` ì™€ `node` ë‚´ë¶€ì—ì„œ ê°ì¢… ë™ì‘ì„ í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë“¤ì´ ì¡´ì¬í•œë‹¤.

> k8s ì»´í¬ë„ŒíŠ¸: <https://kubernetes.io/ko/docs/concepts/overview/components/>

```
$ kubectl get pod -n kube-system -o custom-columns=Pod:metadata.name,Node:spec.nodeName
Pod                                Node
coredns-66bff467f8-2jvbb           minikube
coredns-66bff467f8-r8mgw           minikube
etcd-minikube                      minikube
kindnet-zt7md                      minikube
kube-apiserver-minikube            minikube
kube-controller-manager-minikube   minikube
kube-proxy-72npz                   minikube
kube-scheduler-minikube            minikube
storage-provisioner                minikube
```

ì‹¤ì œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì„ êµ¬ì„±í•˜ëŠ” í¬ë“œë“¤ì´ `kube-system` ë„¤ì„ ìŠ¤í˜ì´ìŠ¤ì—ì„œ ë™ì‘ì¤‘ì´ë©° ì´ë¥¼ í•­ìƒ ì¸ì§€í•˜ê³  ìˆì–´ì•¼ í•œë‹¤.  

### ë§ˆìŠ¤í„° ì»´í¬ë„ŒíŠ¸

k8s í´ëŸ¬ìŠ¤í„° ì „ì²´ë¥¼ ê´€ë¦¬í•˜ëŠ” ì—­í•   

- í´ëŸ¬ìŠ¤í„° ë…¸ë“œì˜ ë¦¬ì†ŒìŠ¤ ìƒí™© íŒŒì•…  
- ì»¨í…Œì´ë„ˆë¥¼ ê°€ë™ì‹œí‚¬ ë…¸ë“œë¥¼ ì„ íƒ  

#### API Server

ì¿ ë²„ì˜ ë¦¬ì†ŒìŠ¤ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ Rest API ì•¤ë“œí¬ì¸íŠ¸ ì„œë²„  

ê° ì»´í¬ë„ŒíŠ¸ë¡œë¶€í„° ì •ë³´ë¥¼ ë°›ì•„ `etcd` ì— ì €ì¥  
ì»´í¬ë„ŒíŠ¸ê°„ í†µì‹ , ë…¸ë“œê°„ í†µì‹ ì„ ì§€ì›í•œë‹¤.  

ê·¸ë¦¼ì„ ë³´ë©´ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ë“¤ì´ `API Server` ë¥¼ í†µí•´ í†µì‹ í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŒ.  
`kubectl` ëª…ë ¹ ë˜í•œ `API Server` ë¥¼ í†µí•´ ì „íŒŒëœë‹¤.  

#### etcd  

> `/etc + distribute` ì˜ ì•½ì–´.  
> ë ˆë“œí—·ì—ì„œ ì„¤ì •íŒŒì¼ì„ ì„œë²„ê°„ ê³µìœ í•˜ê¸° ìœ„í•´ ë§Œë“  íˆ´ì„ k8sì—ì„œ ìŠ¹ê³„í•¨.  

í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì •ë³´ë¥¼ ê´€ë¦¬ë¥¼ ìœ„í•œ ë¶„ì‚° `Key-value store`  

ë…¸ë“œì˜ ìƒíƒœì •ë³´, k8sì—ì„œ í•„ìš”í•œ ëª¨ë“  ì„¤ì • ì •ë³´ê°€ ë“¤ì–´ê°€ ìˆìœ¼ë©° `API Server` ê°€ ì´ë¥¼ ì°¸ì¡°í•´ ê° ì»´í¬ë„ŒíŠ¸ê°€ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤Œ,  

ì¤‘ìš”í•œ ë°ì´í„°ì´ê¸°ì— ë°±ì—…, ë³„ë„ì˜ ì„œë²„ë“¤ì— ë¶„ì‚°ì‹¤í–‰ í•œë‹¤.  

#### ìŠ¤ì¼€ì¤„ëŸ¬  

íŒŒë“œë¥¼ ì–´ëŠ ë…¸ë“œì—ì„œ ì‘ë™ì‹œí‚¬ì§€ë¥¼ ì œì–´í•˜ëŠ” ë°±ì•¤ë“œ ì»´í¬ë„ŒíŠ¸, `API Server` ì™€ í†µì‹ í•˜ë©° í´ëŸ¬ìŠ¤í„° ìƒíƒœë¥¼ í™•ì¸, ë¹ˆê³µê°„ì˜ ë…¸ë“œì— íŒŒë“œë¥¼ í• ë‹¹ ë° ì‹¤í–‰í•˜ëŠ” ìŠ¤ì¼€ì¤„ë§ì„ ì²˜ë¦¬í•œë‹¤.  

#### ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤ë‹ˆì €  

íŒŒë“œë¥¼ ê´€ë¦¬í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ë“¤ì´ ê³³ê³³ì— ë°°ì¹˜ë˜ì–´ ìˆê³  ì´ ì»¨íŠ¸ë¡¤ëŸ¬ ê°ê°ì„ ì‹¤í–‰í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤ë‹ˆì €. í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ê°ì‹œ, í•­ìƒ ì •ìƒìƒíƒœë¥¼ ìœ ì§€ì‹œí‚¤ëŠ” ë°±ì•¤ë“œ ì»´í¬ë„ŒíŠ¸

### ë…¸ë“œ ì»´í¬ë„ŒíŠ¸

> <https://kubernetes.io/ko/docs/tutorials/kubernetes-basics/explore/explore-intro/>

ì»¨í…Œì´ë„ˆê°€ ì‘ë™ë˜ëŠ” ì„œë²„, ì—¬ëŸ¬ëŒ€ì˜ ë…¸ë“œë¥¼ ì¤€ë¹„í•´ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±,  
ë…¸ë“œëŠ” í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ íšŒì‚¬ì˜ ê°€ìƒ ë¨¸ì‹  í˜¹ì€ ë¬¼ë¦¬ ë¨¸ì‹ ì´ ë…¸ë“œì—­í• ì„ í•œë‹¤.  

í•´ë‹¹ ë…¸ë“œì•ˆì—ì„œ ì—¬ëŸ¬ëŒ€ì˜ ì»¨í…Œì´ë„ˆê°€ ë™ì‘  

#### kubelet  

ë…¸ë“œ ë‚´ë¶€ì—ì„  `kubelet` ì´ë¼ëŠ” ì—ì´ì „íŠ¸ê°€ ì›€ì§ì´ë©° ì»¨í…Œì´ë„ˆ(íŒŒë“œ)ë¥¼ ì‹¤í–‰, í—¬ìŠ¤ì²´í¬ í•œë‹¤.  

ë…¸ë“œì˜ `status` ë¥¼ ì •ê¸°ì ìœ¼ë¡œ ê°ì‹œí•˜ë©° ì´ë¥¼ `API Server` ë¡œ ì „ì†¡, `etcd` ì— ì €ì¥ë˜ë„ë¡ ì§€ì›.  

#### kube-proxy  

í´ëŸ¬ìŠ¤í„° ì•ˆì˜ ë³„ë„ì˜ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì„¤ì •,  
ë…¸ë“œë¡œ ë“¤ì–´ì˜¤ëŠ” íŒ¨í‚·ì„ ì ì ˆí•œ Pod ë¡œ ë¼ìš°íŒ…, ë¡œë“œë°¸ëŸ°ì‹± ë“±ì˜ ë™ì‘ì„ ê´€ë¦¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸

### Event chain

k8s ëŠ” `Reconciliation Loops` ë¥¼ í†µí•´ í•­ìƒ `context` ìƒíƒœë¥¼ ê²€ì‚¬í•œë‹¤.  

> `Reconciliation` : íšŒê³„ìš©ì–´ë¡œ ì¡°ì •ì„ ëœ»í•œë‹¤. ì¡°ì •ì€ ë‘ ë ˆì½”ë“œ ì„¸íŠ¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í”„ë¡œì„¸ìŠ¤.  

![kube3](/assets/k8s/kube3.png)  

`Observe`: í˜„ ìƒíƒœì™€ì˜ ì°¨ì´ë¥¼ ë¹„êµí•˜ê¸° ìœ„í•´ `API Server` ì— ìƒíƒœì¡°íšŒ
`Diff`: í˜„ `context` ì™€ `API Server` ì—ì„œ ë°›ì•„ì˜¨ `context` ë¥¼ ë¹„êµ  
`Act`: ë‘ `context` ê°„ ì°¨ì´ê°€ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸  

ìœ„ì˜ ì¼ë ¨ì˜ ê³¼ì •ì€ `Event chain` ì´ë¼ëŠ” ì´ë¼ëŠ” ê´€ê³„ë¡œ í˜•ì„±ëœë‹¤.  

![kube4](/assets/k8s/kube4.png)  

1. `kubectl` ë¡œ ë””í”Œë¡œì´ë¨¼íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ `apply`, `kubectl`ì´ `ë””í”Œë¡œì´ë¨¼íŠ¸ API` í˜¸ì¶œ, `ë””í”Œë¡œì´ë¨¼íŠ¸ API`ê°€ `etcd`ì— ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì €ì¥  
2. `ë””í”Œë¡œì´ë¨¼íŠ¸ API`ë¥¼ `watch`(ê°ì‹œ)í•˜ê³  ìˆëŠ” `ë””í”Œë¡œì´ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬`ê°€ ë³€í™”ë¥¼ ê°ì§€  
3. `ë””í”Œë¡œì´ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬`ê°€ `ë¦¬í”Œë¦¬ì¹´ì…‹ API` ë¥¼ í˜¸ì¶œ, `ë¦¬í”Œë¦¬ì¹´ì…‹ API`ê°€ `etcd`ì— ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì €ì¥
4. `ë¦¬í”Œë¦¬ì¹´ì…‹ API`ë¥¼ `watch`(ê°ì‹œ)í•˜ê³  ìˆëŠ” `ë¦¬í”Œë¦¬ì¹´ì…‹ ì»¨íŠ¸ë¡¤ëŸ¬`ê°€ ë³€í™”ë¥¼ ê°ì§€  
5. `ë¦¬í”Œë¦¬ì¹´ì…‹ ì»¨íŠ¸ë¡¤ëŸ¬`ê°€ `íŒŒë“œ API` ë¥¼ í˜¸ì¶œ, `íŒŒë“œ API`ê°€ `etcd`ì— ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì €ì¥  
6. `íŒŒë“œ API`ë¥¼ `watch`(ê°ì‹œ)í•˜ê³  ìˆëŠ” `ìŠ¤ì¼€ì¤„ëŸ¬`ê°€ ë³€í™”ë¥¼ ê°ì§€  
7. `ìŠ¤ì¼€ì¤„ëŸ¬`ê°€ ì–´ë–¤ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜í• ì§€ ê²°ì •, `ìŠ¤ì¼€ì¤„ëŸ¬`ê°€ `íŒŒë“œ API`ë¥¼ í˜¸ì¶œí•´ `etcd` ì—…ë°ì´íŠ¸(ì–´ë–¤ ë…¸ë“œì— ë°°ì¹˜í• ì§€)  
8. `íŒŒë“œ API`ë¥¼ `watch`(ê°ì‹œ)í•˜ê³  ìˆëŠ” ë…¸ë“œì˜ `kubelet`ì´ ë³€í™”ë¥¼ ê°ì§€  
9. `kubelet`ì´ `ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„`ì— í¬ë“œ ì‘ì„± ì§€ì‹œ  
10. `ì»¨í…Œì´ë„ˆ` ìƒì„±  

`Event chain` ì€ ì´ ê³¼ì •ì„ ì§€ì†ì ìœ¼ë¡œ ë£¨í”„í•œë‹¤.  

ì‹¤ì œ ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ `apply` í•˜ê³  ì¼ë ¨ì˜ `Event chain` ê³¼ì •ì„ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ ì‚¬ìš©  

```
$ kubectl get events -w
```

```yaml
## nginx-deployment.yaml
## ê¸°ë³¸í•­ëª©
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
## ë””í”Œë¡œì´ë¨¼íŠ¸ ìŠ¤íŒ©
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-pod ## í…œí”Œë¦¿ ê²€ìƒ‰ì¡°ê±´
  ## íŒŒë“œ í…œí”Œë¦¿
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
        - name: nginx
          image: nginx:1.15 ## ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€
          ports:
            - containerPort: 80
```

ìœ„ì˜ ë””í”Œë¡œì´ë¨¼íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ `apply` í•˜ê³  ì´ë²¤íŠ¸ ì²´ì¸ì—ì„œ ì¶œë ¥ë˜ëŠ” ë©”ì„¸ì§€ë¥¼í™•ì¸  

```sh
$ kubectl get events -w
LAST SEEN   TYPE     REASON              OBJECT                        MESSAGE
0s          Normal   ScalingReplicaSet   deployment/nginx-deployment   Scaled up replica set nginx-deployment-f75fb748c to 3
0s          Normal   SuccessfulCreate    replicaset/nginx-deployment-f75fb748c   Created pod: nginx-deployment-f75fb748c-hq556
0s          Normal   SuccessfulCreate    replicaset/nginx-deployment-f75fb748c   Created pod: nginx-deployment-f75fb748c-j2sh9
1s          Normal   SuccessfulCreate    replicaset/nginx-deployment-f75fb748c   Created pod: nginx-deployment-f75fb748c-wbpzp
<unknown>   Normal   Scheduled           pod/nginx-deployment-f75fb748c-j2sh9    Successfully assigned default/nginx-deployment-f75fb748c-j2sh9 to minikube
<unknown>   Normal   Scheduled           pod/nginx-deployment-f75fb748c-hq556    Successfully assigned default/nginx-deployment-f75fb748c-hq556 to minikube
<unknown>   Normal   Scheduled           pod/nginx-deployment-f75fb748c-wbpzp    Successfully assigned default/nginx-deployment-f75fb748c-wbpzp to minikube
0s          Normal   Pulling             pod/nginx-deployment-f75fb748c-hq556    Pulling image "nginx:1.15"
0s          Normal   Pulling             pod/nginx-deployment-f75fb748c-j2sh9    Pulling image "nginx:1.15"
0s          Normal   Pulling             pod/nginx-deployment-f75fb748c-wbpzp    Pulling image "nginx:1.15"
0s          Normal   Pulled              pod/nginx-deployment-f75fb748c-hq556    Successfully pulled image "nginx:1.15"
0s          Normal   Created             pod/nginx-deployment-f75fb748c-hq556    Created container nginx
0s          Normal   Started             pod/nginx-deployment-f75fb748c-hq556    Started container nginx
0s          Normal   Pulled              pod/nginx-deployment-f75fb748c-j2sh9    Successfully pulled image "nginx:1.15"
0s          Normal   Created             pod/nginx-deployment-f75fb748c-j2sh9    Created container nginx
0s          Normal   Started             pod/nginx-deployment-f75fb748c-j2sh9    Started container nginx
0s          Normal   Pulled              pod/nginx-deployment-f75fb748c-wbpzp    Successfully pulled image "nginx:1.15"
0s          Normal   Created             pod/nginx-deployment-f75fb748c-wbpzp    Created container nginx
0s          Normal   Started             pod/nginx-deployment-f75fb748c-wbpzp    Started container nginx
```

`API Server` ì—ì„  Manifest fileë¡œ `etcd` ì— ì—…ë°ì´íŠ¸ë§Œ í• ë¿ ì´ë¥¼ k8s ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ê°ê° ê°ì‹œí•˜ë©° ë³„ë„ë¡œ ì›€ì§ì¸ë‹¤.  

### ë§ˆìŠ¤í„° ê°€ìš©ì„±  

ìš´ì˜ì¤‘ì¸ ì„œë¹„ìŠ¤ì˜ ê°€ìš©ì„±ì„ ëŠ˜ë¦¬ë ¤ë©´ ë…¸ë“œë¥¼ í™•ë³´í•˜ê³  íŒŒë“œë¥¼ ëŠ˜ë¦¬ë©´ ëœë‹¤.  

k8s ìì²´ì˜ ê°€ìš©ì„±ì„ ëŠ˜ë¦¬ë ¤ë©´ ì•„ë˜ ê·¸ë¦¼ì²˜ëŸ¼ **ë§ˆìŠ¤í„° ë…¸ë“œ(ì»¨íŠ¸ë¡¤ í”Œë ˆì¸)** ì„ ë‹¤ì¤‘í™” í•˜ì—¬ ê°€ìš©ì„±ì„ í™•ë³´í•´ì•¼í•œë‹¤.  

![kube6](/assets/k8s/kube6.png)  

`etcd` ëŠ” í´ëŸ¬ìŠ¤í„°ë¡œ êµ¬ì¶•í•˜ì—¬ ì„œë¡œê°™ì˜ ë°ì´í„°ë¥¼ í•­ì‹œ ë™ê¸°í™” í•˜ê³   

`API Server` ì„œë²„ëŠ” ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•´ ì—‘ì„¸ìŠ¤ë¥¼ ë¶„ì‚°ì‹œí‚¨ë‹¤.  

`ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤ë‹ˆì €`ì™€ `ìŠ¤ì¼€ì¤„ëŸ¬`ëŠ” **ì•¡í‹°ë¸Œ/ìŠ¤íƒ ë°”ì´í˜•**ì„ ê°€ì§€ë©° ì•¡í‹°ë¸Œí•œ ë§ˆìŠ¤í„° ì»´í¬ë„ŒíŠ¸ì˜ ì¥ì• ì— ëŒ€ë¹„í•œë‹¤. ì„œë¡œê°„ì˜ ê²½í•©ì„ í”¼í•˜ê¸° ìœ„í•´ ë™ì‹œê°„ëŒ€ì— í•˜ë‚˜ì”©ì˜ ì»´í¬ë„ŒíŠ¸ë§Œ ë™ì‘í•œë‹¤.  

ì•¡í‹°ë¸Œí•œ ì»´í¬ë„ŒíŠ¸ëŠ” ê¸°ë³¸ê°’ì¸ 2ì´ˆë§ˆë‹¤ ê°±ì‹ ì‹œê°„ì„ ê¸°ë¡í•˜ë©°  
`kube-system` ë„¤ì„ ìŠ¤í˜ì´ìŠ¤ì˜ `endpoints`ì¸ `kube-controller-manager` ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.  

`renewTime` ì†ì„± í™•ì¸  

```
$ kubectl get endpoints kube-controller-manager -n kube-system -o yaml
apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    control-plane.alpha.kubernetes.io/leader: '{"holderIdentity":"minikube_2a1b1ca1-403a-45e1-b4b8-c50afb0e14a1","leaseDurationSeconds":15,"acquireTime":"2020-04-29T16:36:09Z","renewTime":"2020-05-05T11:32:38Z","leaderTransitions":3}'
  creationTimestamp: "2020-04-28T08:17:42Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:metadata:
        f:annotations:
          .: {}
          f:control-plane.alpha.kubernetes.io/leader: {}
    manager: kube-controller-manager
    operation: Update
    time: "2020-05-05T11:32:38Z"
  name: kube-controller-manager
  namespace: kube-system
  resourceVersion: "174543"
  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager
  uid: c38faf14-ceb3-4e54-91fd-fa730b1d58a9
```

> ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì˜ ë…¸ë“œ(ë§ˆìŠ¤í„° ë…¸ë“œ)ì˜ ê°œìˆ˜ëŠ” í™€ìˆ˜ë¡œ í•˜ëŠ”ê²ƒì´ ì¢‹ë‹¤. etcd í´ëŸ¬ìŠ¤í„°ì—ì„œ ë…¸ë“œê°„ì˜ íˆ¬í‘œë¥¼ í†µí•´ ë°ì´í„° ë™ê¸°í™”ë¥¼ ì§„í–‰í•˜ê¸°ì— í•­ìƒ í•­ìƒ ê³¼ë°˜ìˆ˜ê°€ ë‚˜ì˜¤ëŠ” í™€ìˆ˜ë¥¼ ê¶Œì¥í•˜ë©° 3 ~ 7ê°œ ê¹Œì§€ì˜ ë…¸ë“œìˆ˜ê°€ íš¨ìœ¨ì ì´ë‹¤.  

### ë…¸ë“œ ê°€ìš©ì„±  

ì¼ë°˜ ë…¸ë“œì—ì„  ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ì„œ ê³ ë ¤í•  ê°ì¢… ë¬¸ì œì ì´ ì—†ê¸°ì—  
ê°€ìš©ì„±, ë‹¤ì¤‘í™”ê°€ í•„ìš”í•˜ë‹¤ë©´ ë…¸ë“œ(ì„œë²„)ë¥¼ ì¶”ê°€í™•ë³´í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.  

ë‹¨ ë…¸ë“œ ë‹¤ìš´ì‹œ í•´ë‹¹ ë…¸ë“œì— ì¡´ì¬í•˜ë˜ íŒŒë“œë“¤ì´ ë‹¤ë¥¸ ë…¸ë“œì— ë°°ì¹˜ë˜ê¸°ì— ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•˜ë©° ë…¸ë“œí™•ë³´í•  í•„ìš”ê°€ ìˆë‹¤.  
ë…¸ë“œ 2ê°œ ìš´ì˜ì‹œ í•˜ë‚˜ì˜ ë…¸ë“œê°€ ë‹¤ìš´ë  ê²½ìš° ë‹¤ë¥¸ í•˜ë‚˜ì˜ ë…¸ë“œì— ë¶€í•˜ê°€ ì§‘ì¤‘ë¨ìœ¼ë¡œ ë…¸ë“œëŠ” 3ê°œ ì´ìƒìœ¼ë¡œ êµ¬ì„±í•˜ëŠ”ê²ƒì´ ì „í˜•ì ì¸ êµ¬ì¡°ì´ë‹¤.  

ê°€ì¥í° ë¦¬ì†ŒìŠ¤ì¸ ë…¸ë“œë¶€í„° ê°€ì¥ì‘ì€ íŒŒë“œ, ê°ì¢… ì»´í¬ë„ŒíŠ¸ë“¤ì˜ ë‹¤ì¤‘í™”ë¥¼ ì§„í–‰í•˜ì˜€ì–´ë„  
**í­ë°œë°˜ê²½(Blast Radius)** ì„ ê³„ì‚°í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë¬¼ë¦¬ì  ì¥ì•  ë°œìƒì‹œ ëŒ€ì²˜ê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.  

í­ë°œë°˜ê²½ì˜ ë²”ìœ„ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.  

1. ë¬¼ë¦¬ì„œë²„  
2. ë™  
3. ë°ì´í„° ì„¼í„°  
4. ì§€ì—­  

ë§Œì•½ í•˜ë‚˜ì˜ ë¬¼ë¦¬ì„œë²„ì— ê°€ìƒë¨¸ì‹ ì„ ì‚¬ìš©í•´ ëª¨ë“  ì„œë²„ë¥¼ ì˜¬ë¦¬ê²Œ ë˜ë©´ í•´ë‹¹ ë¬¼ë¦¬ì„œë²„ ë‹¤ìš´ì‹œ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ëœë‹¤.  
ë§Œì•½ í•˜ë‚˜ì˜ ë™ì— ëª¨ë“  ì„œë¹„ìŠ¤ ìš´ì˜ ë¬¼ë¦¬ì„œë²„ë¥¼ ì„¤ì¹˜í•œë‹¤ë©´ í•´ë‹¹ ë™ì˜ ì „ë ¥ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ ë‹¤ìš´ì‹œ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ëœë‹¤.  
ë°ì´í„° ì„¼í„°ë‚˜ ì§€ì—­ë„ ë§ˆì°¬ê°€ì§€ì´ë‹¤. ì¬ë‚œ ë°œìƒì‹œì— ì „ë ¥, ë„¤íŠ¸ì›Œí¬ê°€ ì°¨ë‹¨ë  ê²½ìš° ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ëœë‹¤.  

í­ë°œë°˜ê²½ì„ ì˜ì‹í•˜ë©° ë™ì¼í•œ ì¢…ë¥˜ì˜ ì„œë²„(ë…¸ë“œ, ì»¨íŠ¸ë¡¤ í”Œë ˆì¸), ê°€ìƒë¨¸ì‹ ì„ ë¶„ë¦¬ ë°°ì¹˜í•´ì•¼í•œë‹¤.  

ë°ì´í„°ì„¼í„° í­ë°œë°˜ê²½ì„ ì˜ì‹í•´ k8s ë¦¬ì†ŒìŠ¤ë¥¼ ë¶„ì‚°ë°°ì¹˜í•  ê²½ìš° ë™ê¸°í™” ìŠ¤ë¥´í’‹, íƒ€ì„ì•„ì›ƒì´ ë  ìœ„í—˜ì´ ë°œìƒí•œë‹¤.  
ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì˜ ê²½ìš° íŠ¹íˆ ë” ë¯¼ê°í•œë° í•˜íŠ¸ë¹„íŠ¸ 100ë°€ë¦¬ì´ˆ, ë¦¬ë”ì„ ì¶œ 1000ë°€ë¦¬ì´ˆë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤. 

ì• ì €ì˜ ê²½ìš° í•œêµ­ ì¤‘ë¶€, ë‚¨ë¶€ì§€ì—­ì˜ ì§€ì—°ì‹œê°„ì€ 10ë°€ë¦¬ì´ˆ ì •ë„ë¼í•œë‹¤.  
ì „ìš© ë„¤íŠ¸ì›Œí¬ ë°±ë³¸ì„ í†µí•´ ì—°ê²°ë˜ê¸°ì— ì´ë³´ë‹¤ ë” ë¹¨ë¼ì§ˆìˆœ ì—†ë‹¤.  

ë§Œì•½ ëª©í‘œë¥¼ 10ë°€ë¦¬ì´ˆ ì´í•˜ë¡œ ì¡ì•„ì•¼ í•œë‹¤ë©´ ë³„ë„ì— ì§€ì—­ì— í´ëŸ¬ìŠ¤í„° í•˜ë‚˜ë¥¼ êµ¬ì¶•í•˜ëŠ”ê²ƒì´ ì•„ë‹Œ
í•˜ë‚˜ì˜ ì§€ì—­ë§ˆë‹¤ í´ëŸ¬ìŠ¤í„° í•˜ë‚˜ë¥¼ êµ¬ì¶•í•´ì•¼ í•œë‹¤.  

### k8s ì—…ë°ì´íŠ¸, ì—…ê·¸ë ˆì´ë“œ  

k8s í´ëŸ¬ìŠ¤í„° ìš´ì˜ì‹œ 2ê°€ì§€ì˜ ë²„ì „ì—…ì´ í•„ìš”í•˜ë‹¤.  

1. k8s ì»´í¬ë„Œë“œ ë²„ì „ì—…  
2. k8s ì„œë²„ ë²„ì „ì—…  

k8sëŠ” ë§ˆì´ë„ˆëŠ” 3ê°œì›” ê°„ê²©ìœ¼ë¡œ ë²„ì „ì´ ë¦´ë¦¬ì¦ˆ ë˜ê³  ìˆìœ¼ë©° ë‹¨ìˆœ ë²„ê·¸ íŒ¨ì¹˜ëŠ” í•œë‹¬ì— í•œë‘ë²ˆ ë¦´ë¦¬ì¦ˆ ë˜ê³  ìˆë‹¤.  

#### Cordon, Uncordon, Drain

ì—…ë°ì´íŠ¸ì‹œì— ë…¸ë“œì˜ ì¬ë¶€íŒ…ì´ ë¹ˆë²ˆíˆ ì¼ì–´ë‚¨ìœ¼ë¡œ k8s ìŠ¤ì¼€ì¤„ë§ì—ì„œ ì œì™¸í•´ì•¼ í•œë‹¤.  
ì´ë•Œ `Cordon`, `Uncordon` ëª…ë ¹ì„ ì‚¬ìš©í•œë‹¤.

> `Cordon`: íì‡„í•˜ë‹¤  

ë‹¤ìŒê³¼ ê°™ì€ ê°„ë‹¨í•œ `Deployment`ë¥¼ apply  

```yaml
## nginx.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
```

```
$ kubectl apply -f nginx.yaml
$ kubectl get pod --output=wide
NAME                    READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
nginx-f89759699-5pqrm   1/1     Running   0          96s   172.18.0.2   minikube-m03   <none>           <none>
nginx-f89759699-7pmmz   1/1     Running   0          96s   172.18.0.2   minikube-m02   <none>           <none>
nginx-f89759699-wxjtx   1/1     Running   0          96s   172.18.0.3   minikube-m03   <none>           <none>

$ kubectl cordon minikube-m02
node/minikube-m02 cordoned

$ kubectl get node
NAME           STATUS                     ROLES    AGE    VERSION
minikube       Ready                      master   143m   v1.18.0
minikube-m02   Ready,SchedulingDisabled   <none>   141m   v1.18.0
minikube-m03   Ready                      <none>   11m    v1.18.0
```

`minikube-m02` ë…¸ë“œë¥¼ `cordon` ëª…ë ¹ì„ í†µí•´ ìŠ¤ì¼€ì¤„ë§ì—ì„œ ì œì™¸í•œë‹¤.  

`STATUS` ì— `SchedulingDisabled` ìƒíƒœê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸  

ì´ ìƒíƒœì—ì„œ `replicas` ë¥¼ 6ìœ¼ë¡œ ë³€ê²½í•œë‹¤.  

```
$ kubectl get pod --output=wide
NAME                    READY   STATUS    RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
nginx-f89759699-5pqrm   1/1     Running   0          3h25m   172.18.0.2   minikube-m03   <none>           <none>
nginx-f89759699-7pmmz   1/1     Running   0          3h25m   172.18.0.2   minikube-m02   <none>           <none>
nginx-f89759699-fnfst   1/1     Running   0          23s     172.18.0.5   minikube-m03   <none>           <none>
nginx-f89759699-mcpj2   1/1     Running   0          23s     172.18.0.6   minikube-m03   <none>           <none>
nginx-f89759699-tmhz2   1/1     Running   0          23s     172.18.0.4   minikube-m03   <none>           <none>
nginx-f89759699-wxjtx   1/1     Running   0          3h25m   172.18.0.3   minikube-m03   <none>           <none>
```

`minikube-m02`ì—ëŠ” ì¶”ê°€ë˜ì§€ ì•Šê³  `minikube-m03`ì—ë§Œ íŒŒë“œê°€ ì¶”ê°€ìƒì„±ë˜ì—ˆë‹¤.   

`minikube-m02`ë¥¼ `Uncordon` ëª…ë ¹ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ ëŒ€ìƒìœ¼ë¡œ ë³µì›

```
$ kubectl uncordon minikube-m02
node/minikube-m02 uncordoned

$ kubectl get node
NAME           STATUS   ROLES    AGE     VERSION
minikube       Ready    master   5h48m   v1.18.0
minikube-m02   Ready    <none>   5h46m   v1.18.0
minikube-m03   Ready    <none>   3h36m   v1.18.0
```

`Drain`ì€ `Cordon` ì›€ì§ì„ì— í¬ë“œì˜ ì‚­ì œ, ì¬ì‘ì„±ì„ ë”í•œê²ƒì´ë‹¤.  

```
$ kubectl drain minikube-m03
node/minikube-m03 cordoned
error: unable to drain node "minikube-m03", aborting command...

There are pending nodes to be drained:
 minikube-m03
error: cannot delete DaemonSet-managed Pods (use --ignore-daemonsets to ignore): kube-system/kindnet-v7qmx, kube-system/kube-proxy-b6r9k
```

ë…¸ë“œ ì „ìš©ìœ¼ë¡œ ì›€ì§ì´ëŠ” ë°ëª¬ì…‹ì€ ë‹¤ë¥¸ ë…¸ë“œë¡œ ì˜®ê¸°ìˆ˜ ì—†ê¸°ì— ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.  

```
$ kubectl drain minikube-m03 --ignore-daemonsets
node/minikube-m03 already cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/kindnet-v7qmx, kube-system/kube-proxy-b6r9k
evicting pod default/nginx-f89759699-fnfst
evicting pod default/nginx-f89759699-5pqrm
evicting pod default/nginx-f89759699-mcpj2
evicting pod default/nginx-f89759699-tmhz2
evicting pod default/nginx-f89759699-wxjtx
pod/nginx-f89759699-mcpj2 evicted
pod/nginx-f89759699-wxjtx evicted
pod/nginx-f89759699-fnfst evicted
pod/nginx-f89759699-tmhz2 evicted
pod/nginx-f89759699-5pqrm evicted
node/minikube-m03 evicted

$ kubectl get node
NAME           STATUS                     ROLES    AGE     VERSION
minikube       Ready                      master   5h54m   v1.18.0
minikube-m02   Ready                      <none>   5h52m   v1.18.0
minikube-m03   Ready,SchedulingDisabled   <none>   3h42m   v1.18.0

$ kubectl get pod --output=wide
NAME                    READY   STATUS    RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
nginx-f89759699-5nh2s   1/1     Running   0          91s     172.18.0.5   minikube-m02   <none>           <none>
nginx-f89759699-7pmmz   1/1     Running   0          3h33m   172.18.0.2   minikube-m02   <none>           <none>
nginx-f89759699-9x2gq   1/1     Running   0          91s     172.18.0.6   minikube-m02   <none>           <none>
nginx-f89759699-jxdbq   1/1     Running   0          91s     172.18.0.3   minikube-m02   <none>           <none>
nginx-f89759699-kdtqs   1/1     Running   0          91s     172.18.0.4   minikube-m02   <none>           <none>
nginx-f89759699-pp4kh   1/1     Running   0          91s     172.18.0.7   minikube-m02   <none>           <none>
```

> `evicted`: í‡´ê±°

`drain` ì„¤ì •í•œ ë…¸ë“œì˜ íŒŒë“œëŠ” ëª¨ë‘ ë‹¤ë¥¸ ë…¸ë“œì— ì¬ì‘ì„± ë˜ê³  ìŠ¤ì¼€ì¤„ë§ì—ì„œ ì œì™¸ëœë‹¤.  

<!-- #### Kured (Kubernetes Rebooot Daemon)

ë…¸ë“œ ì¬ì‹œì‘ì‹œ Cordon, Drain ì˜ ëª…ë ¹ì„ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ì—ì„œ ì œì™¸ì‹œí‚¬ ìˆ˜ ìˆë‹¤.  
`Kured` ì„ ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ ì¬ì‹œì‘ì´ í•„ìš”í•œ ë…¸ë“œë¥¼ ê°ì§€í•˜ê³  í´ëŸ¬ìŠ¤í„° ì „ì²´ì— ëŒ€í•œ ì˜í–¥ì„ ê³ ë ¤í•´ reboot í•œë‹¤.   -->

## k8s ë¦¬ì†ŒìŠ¤

- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ - `Pod`, `ReplicaSet`, `Deployment`, `DaemonSet`  
- ë„¤íŠ¸ì›Œí¬ ê´€ë¦¬ - `Service`, `Ingress`  
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • ì •ë³´ ê´€ë¦¬ - `ConfigMap`, `Secrets`
- ë°°ì¹˜ì¡ ê´€ë¦¬ - `Job`, `CronJob`  

ì™¸ì—ë„ ì—¬ëŸ¬ê°€ì§€ k8s ë¦¬ì†ŒìŠ¤ê°€ ìˆì§€ë§Œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ë¦¬ì†ŒìŠ¤ ëª‡ê°€ì§€ë§Œ ë¨¼ì € ì•Œì•„ë³´ì.  

**íŒŒë“œ(Pod)**: k8sì—ì„œ ìƒì„±/ê´€ë¦¬í•  í•˜ëŠ” ê°€ì¥ ì‘ì€ ì»´í“¨íŒ… ë‹¨ìœ„  
<https://kubernetes.io/ko/docs/concepts/workloads/pods/>
k8s ì—ì„  ì—¬ëŸ¬ê°œì˜ ì»¨í…Œì´ë„ˆë¥¼ ëª¨ì•„ íŒŒë“œë¡œ ê´€ë¦¬í•œë‹¤.  
íŒŒë“œëŠ” í•­ìƒ í•˜ë‚˜ì˜ ë…¸ë“œì— ë°°ì¹˜ë˜ë©° íŒŒë“œ ë‚´ë¶€ì—ì„œ ë„ì»¤ ì»¨í…Œì´ë„ˆ ì—¬ëŸ¬ê°œë¥¼ ëª¨ì•„ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.  

**ë¦¬í”Œë¦¬ì¹´ ì…‹(Replica Set)**: í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ê°€ë™ë˜ëŠ” íŒŒë“œ ìˆ˜ë¥¼ ê´€ë¦¬í•˜ëŠ” ë¦¬ì†ŒìŠ¤  
<https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/>  
í´ëŸ¬ìŠ¤í„° ì•ˆì— ì§€ì •ëœ ìˆ˜ì˜ íŒŒë“œë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ë©° ì¥ì• ëŒ€ì‘ ë° ìë™ ì‹¤í–‰í•˜ëŠ” ì—­í• .  

**ë””í”Œë¡œì´ë¨¼íŠ¸(Deployment)**: ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë²„ì „ ë‹¨ìœ„ë¥¼ ê´€ë¦¬í•˜ëŠ” ë¦¬ì†ŒìŠ¤
<https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/>  
íŒŒë“œì•ˆì˜ ì»¨í…Œì´ë„ˆë¥¼ ë²„ì „ì—… í•˜ê³  ì‹¶ì„ ë•Œ ì‹œìŠ¤í…œì„ ì •ì§€ì‹œí‚¤ì§€ ì•Šê³  ë²„ì „ì—…(ë¡¤ë§ì—…ë°ì´íŠ¸), ë¡¤ë°± ê¸°ëŠ¥ ë“±ì„ ì œê³µí•œë‹¤.  

**ë°ëª¬ ì…‹(Daemon Set)**: íŠ¹ì •ë…¸ë“œ í˜¹ì€ ëª¨ë“  ë…¸ë“œì— í•­ìƒ ì‹¤í–‰ë˜ì–´ì•¼í•  íŠ¹ì • ì»¨í…Œì´ë„ˆ(íŒŒë“œ)ë¥¼ ê´€ë¦¬í•˜ëŠ” ë¦¬ì†ŒìŠ¤  
<https://kubernetes.io/ko/docs/concepts/workloads/controllers/daemonset/>  
ë§ˆìŠ¤í„° ë…¸ë“œì˜ ìŠ¤ì¼€ì¤„ëŸ¬ì— ì˜í–¥ì„ ë°›ì§€ ì•Šê³  ì§€ì •í•œ ë…¸ë“œì—ì„œ ì»¨í…Œì´ë„ˆë¥¼ ë™ì‘ì‹œí‚¤ê³  ì‹¶ì„ë•Œ ì‚¬ìš©í•œë‹¤.  
ì˜ˆë¥¼ë“¤ì–´ ë¡œê·¸ì½œë ‰í„°, ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ì„ í•˜ëŠ” ì»¨í…Œì´ë„ˆ(íŒŒë“œ)ëŠ” ë…¸ë“œë‹¹ í•˜ë‚˜ì”© ì‘ë™ì‹œí‚¤ê³  ì‹¶ì€ ê²½ìš°ê°€ ìˆëŠ”ë° ì´ë•Œ ë°ëª¬ì…‹ì„ ì‚¬ìš©í•œë‹¤.  

> `kube-proxy` ë˜í•œ ë°ëª¬ ì…‹ì„ ì‚¬ìš©í•´ ê°€ë™ëœë‹¤.  

**ìŠ¤í…Œì´íŠ¸í’€ ì…‹(Stateful Set)**  
ê³ ì •ëœ ìƒíƒœ(Stateful) ì„ ìš”êµ¬í•˜ëŠ” ì»¨í…Œì´ë„ˆ(íŒŒë“œ)ë¥¼ ê´€ë¦¬í•˜ëŠ” ë¦¬ì†ŒìŠ¤  
<https://kubernetes.io/ko/docs/concepts/workloads/controllers/statefulset/>  
DBì™€ ê°™ì€ ê³ ì •ëœ ìƒíƒœ(Stateful)ë¥¼ í•„ìš”ë¡œ í•˜ëŠ” ì»¨í…Œì´ë„ˆì˜ ê²½ìš° **ìŠ¤í…Œì´íŠ¸í’€ ì…‹** ë¥¼ ì‚¬ìš©í•œë‹¤.  
ì•ˆì •ì„±, ê³ ì •ì„±, ì§€ì†ì„± ì„ ë³´ì¦í•œë‹¤.  

### Manifest file(í…œí”Œë¦¿)  

> Manifest: ì„ ì–¸ì„œ

í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì›€ì§ì´ëŠ” ì»¨í…Œì´ë„ˆ, ë„¤íŠ¸ì›Œí¬, ì¡ ë“±ì˜ **k8s ë¦¬ì†ŒìŠ¤ë¥¼ Manifest file ì„ í†µí•´ ê´€ë¦¬í•œë‹¤.**

`yaml`, `json` í˜•ì‹ì˜ íŒŒì¼ë¡œ êµ¬ì„±ëœë‹¤.  

k8s ì˜ ëª¨ë“  ë¦¬ì†ŒìŠ¤ëŠ” Manifest file ì„ í†µí•´ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì—  
ë¦¬ì†ŒìŠ¤ë³„ ë¬¸ë²•ì„ ìµí˜€ì•¼ í•œë‹¤.  

> `kubectl explain` ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¦¬ì†ŒìŠ¤ë³„ ì‚¬ìš© ê°€ëŠ¥í•œ ë‚´ë¶€ ì†ì„±ì„ ë³¼ ìˆ˜ ìˆë‹¤.  

ë¦¬ì†ŒìŠ¤ë³„ë¡œ ì‚¬ìš©ë²•ì´ ë‹¤ë¦„ìœ¼ë¡œ ê°„ë‹¨í•œ êµ¬ì„±ê³¼ ì‹¤í–‰, ì‚­ì œ ë°©ë²•ë§Œ ì•Œì•„ë³¸ë‹¤.  

```yaml
## webserver.yaml
apiVersion: apps/v1 ## api ë²„ì „ ì •ë³´ - í˜¸ì¶œí•  api ë²„ì „ ì§€ì •, kubectl api-versions ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë²„ì „ í™•ì¸ ê°€ëŠ¥.
kind: ReplicaSet ## ì¿ ë²„ ë¦¬ì†ŒìŠ¤ ì¢…ë¥˜ - Pod, ReplicaSet, Service, ConfigMap, Job ë“±ë“±
metadata: ## í•´ë‹¹ ì˜¤ë¸Œì íŠ¸ ì´ë¦„, ë ˆì´ë¸” ì§€ì •
  name: webserver ## ë¦¬ì†ŒìŠ¤ ì´ë¦„ - kubectl ëª…ë ¹ìœ¼ë¡œ ì¡°ì‘í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì´ë¦„
spec: ## ë¦¬ì†ŒìŠ¤ì˜ ìƒì„¸ ì •ë³´, ì‹¤í–‰ ë™ì‘ ë°©ì‹ ë“±ì„ ì§€ì •, ì•„ë˜ëŠ” kind = ReplicaSet ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì†ì„±ë“¤  
  replicas: 10
  selector:
    matchLabels:
      app: webfront
  template:
    metadata:
      labels:
        app: webfront
    spec:
      containers:
      - image: nginx
        name: webfront-container
        ports:
          - containerPort: 80
```

ìœ„ì™€ ê°™ì´ Manifest file ì„ ì‚¬ìš©í•´ k8s ë¦¬ì†ŒìŠ¤ ìƒì„±, ì‚­ì œê°€ëŠ¥  

```
$ kubectl apply -f webserver.yaml
replicaset.apps/webserver created

$ kubectl delete -f webserver.yaml
replicaset.apps "webserver" deleted
```

Manifest file ì˜ ì •ë³´ëŠ” `etcd` ì— ì €ì¥ë˜ê³  ê´€ë¦¬í•œë‹¤.  
`kuberctl` ëª…ë ¹ìœ¼ë¡œ Manifest file ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•˜ë©° ì—…ë°ì´íŠ¸ ë²„ì „ ì •ë³´ê°€ ì¶”ê°€ ê¸°ë¡ëœë‹¤.  

> <https://kubernetes.io/ko/docs/concepts/overview/working-with-objects/labels/>

ì¿ ë²„ì—ì„  ìˆ˜ì›”í•œ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ ë¥¼ ìœ„í•´ `labels` ì†ì„±ì„ ë§ì´ ì‚¬ìš©í•œë‹¤.  

```yaml
## Label/label-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod-a
  labels:
    env: test
    app: photo-view
spec:
  containers:
  - image: nginx
    name: photoview-container

--- ## --- ë¥¼ ì‚¬ìš©í•´ í•˜ë‚˜ì˜ íŒŒì¼ì— 2ê°œì˜ ë¦¬ì†ŒìŠ¤ ì •ë³´ ì…ë ¥ ê°€ëŠ¥

apiVersion: v1 
kind: Pod
metadata:
  name: nginx-pod-b
  labels:
    env: test
    app: imagetrain
spec:
  containers:
  - image: nginx
    name: photoview-container
```

```
$ kubectl apply -f Label/label-pod.yaml
pod/nginx-pod-a created
pod/nginx-pod-b created

$ kubectl get pod --show-labels
NAME              READY   STATUS    RESTARTS   AGE   LABELS
nginx-pod-a       1/1     Running   0          24s   app=photo-view,env=test
nginx-pod-b       1/1     Running   0          24s   app=imagetrain,env=test
```

Manifest file ë‚´ë¶€ ë¦¬ì†ŒìŠ¤ `label` ì„ ìˆ˜ì •í•´ì„œ ë‹¤ì‹œ `apply`,  
`imagetrain -> predictoin` ìœ¼ë¡œ ìˆ˜ì •

```
$ kubectl apply -f Label/label-pod.yaml
pod/nginx-pod-a unchanged
pod/nginx-pod-b configured

$ kubectl get pod --show-labels
NAME              READY   STATUS    RESTARTS   AGE    LABELS
nginx-pod-a       1/1     Running   0          6m3s   app=photo-view,env=test
nginx-pod-b       1/1     Running   0          6m3s   app=predictoin,env=test
```

`ë¼ë²¨ ì„ íƒ` ì†ì„± `-l` ì‚¬ìš©í•˜ì—¬ ë¼ë²¨ì„ í†µí•´ ìƒì„± ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰ ê°€ëŠ¥  

```
$ kubectl get pod -l app=photo-view,env=test
NAME          READY   STATUS    RESTARTS   AGE
nginx-pod-a   1/1     Running   0          7m13s
```

|ì—°ì‚°ì|ì„¤ëª…|  
|---|---|  
`key=value` | `key` ê°’ì´ `value` ì¼ ê²½ìš°  
`key!=value` | `key` ê°’ì´ `value` ì•„ë‹ ê²½ìš°  
`'key in (...value)'` | `key` ê°’ì´ `value` ì— í¬í•¨ ë ê²½ìš°  
`'key notin (...value)'` | `key` ê°’ì´ `value` ì— í¬í•¨ë˜ì§€ ì•Šì„ ê²½ìš°  
`key` | `key` ê°’ì´ ì¡´ì¬í•  ê²½ìš°  
`!key` | `key` ê°’ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°  

> `in`, `notin` ì—°ì‚°ì€ í™€ë”°ì˜´í‘œë¡œ ë¬¶ì–´ì£¼ì–´ì•¼ í•œë‹¤.  
ì½¤ë§ˆë¡œ `AND` ì—°ì‚°ì€ ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ `OR` ì—°ì‚°ì€ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•˜ë‹¤.  

## k8s ë„¤íŠ¸ì›Œí‚¹

k8sì—ì„  ì»¨í…Œì´ë„ˆê°„ í†µì‹ , kuberctl ì„í†µí•œ ëª…ë ¹ì–´ ì‹¤í–‰ì„ í•´ì•¼í•˜ëŠ”ë° k8s ë„¤íŠ¸ì›Œí‚¹ì„ ì•Œì•„ë³´ì.  

### kubnet

`kubnet` ì€ k8s í‘œì¤€ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì´ë‹¤. 
ë…¸ë“œê°„ ì—°ê²°ì€ `10.100.0.0/16` ë„¤íŠ¸ì›Œí¬ë¡œ ì—°ê²°ëœë‹¤.  
ìœ„ì—ì„  ê°ê°ì˜ ë…¸ë“œì— `10.1.1.0/24`, `10.1.1.1/24`ë¥¼ í• ë‹¹í–ˆë‹¤.  

![kube5](/assets/k8s/kube5.png)  

íŒŒë“œ ë„¤íŠ¸ì›Œí¬ëŠ” í´ëŸ¬ìŠ¤í„° ì „ì²´ì—ì„œ ê²€ì‚¬ í›„ ê²°ì •ëœë‹¤.  
ê·¸ë¦¬ê³  ì¤‘ë³µë˜ì§€ ì•ŠëŠ” íŒŒë“œ `CIDR`ì„ í• ë‹¹í•œë‹¤.  
íŒŒë“œ í†µì‹ ì§€ì›ì„ ìœ„í•´ íŠ¹ì • í¬ë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë…¸ë“œì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©ì ì •ì˜ ë£¨íŠ¸ì— ê¸°ë¡í•œë‹¤.  

k8s ë‚´ë¶€ì—ì„œ ìë™ìœ¼ë¡œ ì´ëŸ° ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°ì™€ ë¼ìš°íŒ… í…Œì´ë¸”ì„ ìœ ì§€í•˜ëŠ” ê²ƒì„ ê¸°ì–µí•´ë‘ì.  

> ì‚¬ì´ë”(`Classless Inter-Domain Routing`): `CIDR`ëŠ” í´ë˜ìŠ¤ ì—†ëŠ” ë„ë©”ì¸ ê°„ ë¼ìš°íŒ… ê¸°ë²•ìœ¼ë¡œ 1993ë…„ ë„ì…ë˜ê¸° ì‹œì‘í•œ, ìµœì‹ ì˜ IP ì£¼ì†Œ í• ë‹¹ ë°©ë²•ì´ë‹¤. https://ko.wikipedia.org/wiki/ì‚¬ì´ë”_(ë„¤íŠ¸ì›Œí‚¹)

### ë¦¬ëˆ…ìŠ¤ namespace  

> `Namespace`: í•œë©ì–´ë¦¬ì˜ ë°ì´í„°ì— ì´ë¦„ì„ ë¶™í˜€ ì¶©ëŒ ê°€ëŠ¥ì„±ì„ ì¤„ì´ê³ , ì‰½ê²Œ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œí•˜ëŠ” ê°œë…

`Linux` ì»¤ë„ì˜ `namespace` ê¸°ëŠ¥ì€ Linuxì˜ ì˜¤ë¸Œì íŠ¸ì— ì´ë¦„ì„ ë¶™ì„ìœ¼ë¡œì¨ ë‹¤ìŒê³¼ ê°™ì€ 6ê°œì˜ ë…ë¦½ëœ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆë‹¤.

1. PID namespace  
  í”„ë¡œì„¸ìŠ¤ì— í• ë‹¹ëœ ê³ ìœ í•œ IDë¥¼ ë§í•˜ë©° ì´ë¥¼ í†µí•´ í”„ë¡œì„¸ìŠ¤ë¥¼ ê²©ë¦¬í•  ìˆ˜ ìˆë‹¤
  namespaceê°€ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ ë¼ë¦¬ëŠ” ì„œë¡œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ë‹¤

2. Network namespace  
  ë„¤íŠ¸ì›Œí¬ ë””ë°”ì´ìŠ¤, IP ì£¼ì†Œ, Port ë²ˆí˜¸, ë¼ìš°íŒ… í…Œì´ë¸”, í•„í„°ë§í…Œì´ë¸” ë“±ì˜ ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ë¥¼ namespaceë§ˆë‹¤ ê²©ë¦¬ì‹œì¼œ  
  ë…ë¦½ì ìœ¼ë¡œ ê°€ì§ˆ ìˆ˜ ìˆë‹¤. ì´ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë©´ OS ìƒì—ì„œ ì‚¬ìš©ì¤‘ì¸ Portê°€ ìˆë”ë¼ë„ ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ë™ì¼í•œ Portë¥¼ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

3. UID namespace  
  UID, GIDë¥¼ namespace ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê°€ì§ˆ ìˆ˜ ìˆë„ë¡ í•œë‹¤.  
  namespace ì•ˆê³¼ í˜¸ìŠ¤íŠ¸ OS ìƒì—ì„œ ì„œë¡œ ë‹¤ë¥¸ UID, GIDë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.  

4. Mount namespace  
  í˜¸ìŠ¤íŠ¸ OSì™€ namespaceê°€ ì„œë¡œ ë‹¤ë¥¸ ê²©ë¦¬ëœ íŒŒì¼ì‹œìŠ¤í…œ íŠ¸ë¦¬ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë„ë¡ í•œë‹¤  
  ë§ˆìš´íŠ¸ëŠ” ì»´í“¨í„°ì— ì—°ê²°ëœ ê¸°ê¸°ë‚˜ ê¸°ì–µì¥ì¹˜ë¥¼ OSì— ì¸ì‹ì‹œì¼œ ì‚¬ìš©ê°€ëŠ¥í•œ ìƒíƒœë¡œ ë§Œë“œëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤

5. UTS namespace  
   namespace ë³„ë¡œ í˜¸ìŠ¤íŠ¸ëª…ì´ë‚˜ ë„ë©”ì¸ ëª…ì„ ë…ìì ìœ¼ë¡œ ê°€ì§ˆ ìˆ˜ ìˆë‹¤  

6. IPC namespace  
  í”„ë¡œì„¸ìŠ¤ê°„ í†µì‹ (IPC) ì˜¤ë¸Œì íŠ¸ë¥¼ namespace ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê°€ì§ˆ ìˆ˜ ìˆë‹¤


### ë„ì»¤ ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°  

ì¼ë°˜ì ì¸ ë„ì»¤ í™˜ê²½ì˜ ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°

![docker4](/assets/2019/docker4.png)

`docker0` ë¼ëŠ” ë¸Œë¦¬ì§€ë¥¼ ìƒì„±í•´ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë  ë•Œ ë§ˆë‹¤ `virtual ethernet` ê°€ ìƒì„±ë˜ê³  ì´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì™€ í˜¸ìŠ¤íŠ¸ë¥¼ ì—°ê²°í•œë‹¤.  

ìƒì„±ëœ ê° ì»¨í…Œì´ë„ˆëŠ” ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì—ì„œ ì„œë¡œì˜ ARP, ë¼ìš°íŒ… í…Œì´ë¸”ì„ ê´€ë¦¬í•˜ê³   
`docker0` ë°‘ì—ì„œ ìƒì„±ëœ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ `ë„ì»¤ ë””í´íŠ¸ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤` ë¼ í•œë‹¤.  

### íŒŒë“œ ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°

k8sì—ì„  í•˜ë‚˜ì˜ íŒŒë“œì— í•˜ë‚˜ì˜ `virtual ethernet` ìƒì„±ë˜ê³  í•˜ë‚˜ì˜ IP ë¥¼ ì‚¬ìš©í•œë‹¤.  
ì—¬ëŸ¬ê°œì˜ ì»¨í…Œì´ë„ˆê°€ ì´ í•˜ë‚˜ì˜ IP ë¥¼ ê³µìœ í•œë‹¤.  

![kucbe11](/assets/k8s/kube11.png)  

> ì¶œì²˜: <https://velog.io/@seunghyeon/k8s-ë„¤íŠ¸ì›Œí¬-êµ¬ì„±ë„>

ê°™ì€ íŒŒë“œì˜ ì»¨í…Œì´ë„ˆë¼ë¦¬ëŠ” localhost ë¥¼ í†µí•´ í†µì‹  ê°€ëŠ¥í•˜ë‹¤.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: podnet-01
spec:
  containers:
   - name: web
     image: nginx
   - name: ubuntu
     image: ubuntu:16.04
     command: ["/bin/sh", "-c", "while : ;do curl http://localhost:80/; sleep 10; done"]
```

ìƒì„±ëœ ubuntu ì»¨í…Œì´ë„ˆê°€ localhsot 80 ìš”ì²­ë„ ë¬¸ì œì—†ì´ ìˆ˜í–‰ëœë‹¤.  

### CNI(Container Network Interface) 

ë…¸ë“œì™€ íŒŒë“œê°€ ëª¨ë‘ í•˜ë‚˜ë¼ë©´ `localhost` ì£¼ì†Œë¥¼ í†µí•´ í†µì‹ ì´ ê°€ëŠ¥í•˜ê² ì§€ë§Œ  
í´ëŸ¬ìŠ¤í„°ëŠ” ì—¬ëŸ¬ê°œì˜ ë…¸ë“œì™€ ì—¬ëŸ¬ê°œì˜ íŒŒë“œë¡œ êµ¬ì„±ëœë‹¤.  

k8sì—ì„œëŠ” íŒŒë“œ ê°ê°ì´ ëª¨ë‘ ê³ ìœ ì˜ IPë¥¼ ê°–ë„ë¡ êµ¬ì„±í•˜ê¸°ì—  
`CNI(Container Network Interface)`ë¼ëŠ” ê¸°ìˆ ì„ ì‚¬ìš©í•œë‹¤.  


![kucbe12](/assets/k8s/kube12.png)  
> ì¶œì²˜: https://github.com/dybooksIT/kubernetes-book/blob/master/readme/errata/errata.md

`CNI`ê°€ ê° íŒŒë“œë§ˆë‹¤ ë³„ë„ì˜ IPëŒ€ì—­ì„ ì„¤ì •í•˜ê³   
`CNI`ëŠ” ì´ì™¸ì—ë„ ì•„ë˜ì™€ ê°™ì€ ê¸°ëŠ¥ë“¤ì„ ìˆ˜í–‰í•œë‹¤.  

- ì»¤ë„ ë¼ìš°íŒ…  
- ë™ì  ë¼ìš°íŒ…  
- íŒŒë“œ ì¸í„°í˜ì´ìŠ¤ ìƒì„± ë° IP, Subnet, Routing Table ì„¤ì •  
- Proxy ARP ê¸°ëŠ¥  


`CNI` ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ì—¬ëŸ¬ í”ŒëŸ¬ê·¸ì¸(í”Œë¼ë„¬, ì¹¼ë¦¬ì½”, ì‹¤ë¦¬ì—„) ì´ ìˆìœ¼ë©° ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì— ë”°ë¼ì„œ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì„±í•˜ëŠ” ë°©ë²•ê³¼ íŠ¹ì„±ì´ ë‹¤ë¥´ë‹¤.  

#### ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬

íŒŒë“œê°„ í†µì‹ ì€ IPëŒ€ì—­ë§Œìœ¼ë¡œ í†µì‹ í•˜ì§€ëŠ” ì•Šê³   
ì•ë‹¨ì— `Service` ë¥¼ í†µí•´ ì´ë£¨ì–´ì§„ë‹¤.  

ì„œë¹„ìŠ¤ê°€ ìƒì„±ë˜ë©´ ê° ì„œë¹„ìŠ¤IPì™€ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ë¥¼ ë§¤í•‘í•œ `NAT` í…Œì´ë¸”ì´ ìƒì„±ë˜ê³ 

![kucbe13](/assets/k8s/kube13.png)  
> ì¶œì²˜: https://arisu1000.tistory.com/27851?category=787056

ê° ë…¸ë“œ NAT ì— 100 ëŒ€ì—­ì„ ê°€ì§„ ì„œë¹„ìŠ¤ìš© IP ê°€ ì¶”ê°€ë˜ë©° ì´ IP ë¡œ ì ‘ê·¼ì‹œ íŒŒë“œë¡œì˜ ì ‘ê·¼ì´ ì§„í–‰ëœë‹¤.  

> ëª¨ë“  ë…¸ë“œ ì•ˆì—ëŠ” `kube-proxy` ê°€ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©° ê° `kube-proxy` ê°€ `NAT` í…Œì´ë¸”ì„ ë§Œë“ ë‹¤. ì„±ëŠ¥ì´ìŠˆë¡œ `kube-proxy` ì´ ì§ì  íŒ¨í‚·ì„ ë°›ì§€ ì•Šê³  iptables ë§Œ ìˆ˜ì •í•˜ë©° ì‹¤ì œ íŒ¨í‚·ì€ ë„·í•„í„°(netfilter) ê°€ ì²˜ë¦¬í•œë‹¤.  

`NodePort` ë¡œ ë§Œë“¤ì‹œì—ëŠ” ê° í´ëŸ¬ìŠ¤í„°ì˜ NAT ì—ë§Œ ì¶”ê°€ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ ê²Œì´íŠ¸ì›¨ì´ì—ë„ ë¼ìš°íŒ… í…Œì´ë¸”ì´ ì¶”ê°€ëœë‹¤.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: podnet-02
  labels:
    service-name: podnet-02
spec:
  containers:
  - name: my-nginx
    image: nginx
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-nodeport
spec:
  type: NodePort
  selector:
    service-name: podnet-02
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
```

íŒŒë“œ, ì„œë¹„ìŠ¤ ì¶”ê°€

```
$ kubectl get pods -o wide
NAME                           READY   STATUS    RESTARTS   AGE     IP               NODE         NOMINATED NODE   READINESS GATES
podnet-02                      1/1     Running   0          71s     10.233.117.155   instance-2   <none>           <none>

$ kubectl describe service nginx-nodeport 
Name:                     nginx-nodeport
Namespace:                default
Labels:                   <none>
Annotations:              <none>
Selector:                 service-name=podnet-02
Type:                     NodePort
IP Families:              <none>
IP:                       10.233.40.46 - service ì—ê²Œ í• ë‹¨ëœ nat ip
IPs:                      10.233.40.46
Port:                     <unset>  80/TCP - service ì˜ cluster í¬íŠ¸
TargetPort:               80/TCP
NodePort:                 <unset>  30640/TCP - service ì˜ node í¬íŠ¸
Endpoints:                10.233.117.155:80 - ëª©ì ì§€ ip:port (podnet)
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```


## k8s DNS (CoreDNS)  

í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ë„ë©”ì¸ ì‚¬ìš©ì„ ìœ„í•´ `CoreDNS` ì‹œìŠ¤í…œì„ ì‚¬ìš©í•œë‹¤.  
íŒŒë“œê°„ í†µì‹ ì—ì„œ í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” DNSë¥¼ ì„¤ì •í•´ì„œ ì‚¬ìš©í•œë‹¤.  

`ì„œë¹„ìŠ¤ì´ë¦„.ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì´ë¦„.svc.cluster.local`

```yaml
apiVersion: v1
kind: Service
metadata:
  namespace: monitoring
  labels:
    app: prometheus-app
  name: prometheus-app
spec:
  type: NodePort
  ports:
    - nodePort: 30990
      port: 9090
      targetPort: 9090
  selector:
    app: prometheus-app
```

ë§Œì•½ ìœ„ì™€ê°™ì€ ì„œë¹„ìŠ¤ ì •ì˜ì‹œì— ë„ë©”ì¸ì€ ì•„ë˜ì™€ ê°™ë‹¤.  

`prometheus-app.monitoring.svc.cluster.local`

íŒŒë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë„ë©”ì¸ `í˜¸ìŠ¤íŠ¸ë„¤ì„ì´ë¦„.ì„œë¸Œë„ë©”ì¸ì´ë¦„.ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì´ë¦„.svc.cluster.local` 

> íŒŒë“œë„ `.svc` í˜•ì‹ì˜ ë„ë©”ì¸ì„ ì‚¬ìš©í•œë‹¤.

### DNS ì§ˆì˜ êµ¬ì¡°  

k8sì—ì„œëŠ” ì²˜ìŒì— `kube-dns`ë¼ëŠ” DNSë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ ì—…ë°ì´íŠ¸ ë˜ë©´ì„œ `CoreDNS`ë¥¼ ì‚¬ìš©ì¤‘ì´ë‹¤.   
DNS ì§ˆì˜ ìš°ì„ ìˆœìœ„ê°€ ìˆìœ¼ë©° `.spec.dnsPolicy` ë¥¼ í†µí•´ ìš°ì„ ìˆœìœ„ ì¡°ì ˆì´ ê°€ëŠ¥í•˜ë‹¤.  

1. Default - ë…¸ë“œì˜ DNS ì„¤ì •
2. ClusterFirst - í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ DNSì— ì§ˆì˜
3. ClusterFirstWithHostNet - íŒŒë“œë¥¼ í˜¸ìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‚¬ìš©í•˜ê² ë‹¤ê³  ì„¤ì •í•˜ëŠ” hostNetwork  
4. None - k8s í´ëŸ¬ìŠ¤í„° ì•ˆ DNS ì„¤ì •ì„ ë¬´ì‹œ  

`CoreDNS`ëŠ” ëª¨ë“ˆ í˜•ì‹ìœ¼ë¡œ `CoreDns` íŒŒë“œ ì•ˆì— `coredns`ë¼ëŠ” ì»¨í…Œì´ë„ˆ í•˜ë‚˜ê°€ ì¡´ì¬í•œë‹¤.  

`kube-system` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— `coredns` ì»¨í”¼ê·¸ë§µìœ¼ë¡œ `Corefile` ê´€ë¦¬

```
$ kubectl describe configmap coredns -n kube-system
```
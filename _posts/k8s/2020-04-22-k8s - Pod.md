---
title:  "k8s - Pod!"

read_time: false
share: false
author_profile: false
toc: true
toc_sticky: true
# classes: wide

categories:
  - kubernetes

---

## ê°œìš”

> Pod : ê³ ë˜ì˜ ë–¼(pod of whales)  

íŒŒë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ì‹¤í–‰ ë‹¨ìœ„,  
ì¿ ë²„ë„¤í‹°ìŠ¤ ê°ì²´ ëª¨ë¸ ì¤‘ ë§Œë“¤ê³  ë°°í¬í•  ìˆ˜ ìˆëŠ” ê°€ì¥ ì‘ê³  ê°„ë‹¨í•œ ë‹¨ìœ„.  

ì•„ë˜ì™€ ê°™ì€ íŠ¹ì„±ì„ ê°€ì§„ë‹¤.  

- íŒŒë“œì—ëŠ” í•˜ë‚˜ ì´ìƒì˜ ì»¨í…Œì´ë„ˆê°€ ë“¤ì–´ìˆë‹¤.  
- íŒŒë“œì•ˆì˜ ì»¨í…Œì´ë„ˆëŠ” ë°˜ë“œì‹œ ë™ì¼í•œ ë…¸ë“œì— ë°°ì¹˜ëœë‹¤.  
- ì–´í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤ì¼€ì¼ ì•„ì›ƒì€ íŒŒë“œë‹¨ìœ„ë¡œ ì´ë£¨ì–´ì§„ë‹¤.  
- íŒŒë“œì•ˆì˜ ì»¨í…Œì´ë„ˆëŠ” ë„¤íŠ¸ì›Œí¬ì™€ ìŠ¤í† ë¦¬ì§€ë¥¼ ê³µìœ í•œë‹¤.  
- ê° íŒŒë“œì—ëŠ” ê³ ìœ í•œ IP ì£¼ì†Œê°€ í• ë‹¹ë˜ë©° íŒŒë“œ ë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆëŠ” í•´ë‹¹ IP ë¥¼ ê³µìœ í•œë‹¤.  
- íŒŒë“œëŠ” ì»¨í…Œì´ë„ˆë¿ ì•„ë‹ˆë¼ ìŠ¤í† ë¦¬ì§€ë„ ê°€ì§€ê³  ìˆìœ¼ë©° ê³µìœ  ë³¼ë¥¨ì„ í†µí–‰ ì»¨í…Œì´ë„ˆë¼ë¦¬ ìŠ¤í† ë¦¬ì§€ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë‹¤.  

![kube2](/assets/k8s/kube2.png){: .shadow}  

ìƒëª…ì£¼ê¸°ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.  

1. `Pending` - íŒŒë“œ ìƒì„±ì¤‘(ì´ë¯¸ì§€ ë‹¤ìš´, ì»¨í…Œì´ë„ˆ ìƒì„±ì¤‘)  
2. `Running` - íŒŒë“œì•ˆ ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ì¤‘, ì‹œì, ì¬ì‹œì‘ ì¤‘  
3. `Succeeded` - íŒŒë“œì•ˆ ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì¢…ë£Œ ì™„ë£Œ  
4. `Failed` - íŒŒë“œì•ˆ ì»¨í…Œì´ë„ˆì¤‘ ë¹„ì •ìƒ ì¢…ë£Œ  
5. `Unknown` - íŒŒë“œì˜ ìƒíƒœ í™•ì¸ ë¶ˆê°€, ë…¸ë“œ í†µì‹  ë¶ˆê°€ì‹œ ë°œìƒ  

ìƒëª…ì£¼ê¸°ëŠ” `kubelet` ì»´í¬ë„ŒíŠ¸ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ì§„ë‹¨í•œë‹¤.  

## ë§¤ë‹ˆí˜ìŠ¤íŠ¸  

ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì†ì„± ì¢…ë¥˜ ë° ì„¤ëª… ê²€ìƒ ê°€ëŠ¥  
  
```
kubectl explain pods
kubectl explain pods.metadata
kubectl explain pods --recursive
```

### pods.spec  

|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`pods.spec.containers` | `Container[]` | íŒŒë“œì— ì†í•˜ëŠ” ì»¨í…Œì´ë„ˆ ëª©ë¡  
`pods.spec.imagePullSecrets` | `LocalObjectReference[]` | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ë“ì„ ìœ„í•œ ì¸ì¦ì •ë³´  
`pods.spec.initContainers` | `Container[]` | ì´ˆê¸°í™” ì²˜ë¦¬ë¥¼ í•˜ëŠ” ì»¨í…Œì´ë„ˆ  
`pods.spec.nodeName` | `String` | í•´ë‹¹ ë¼ë²¨ì˜ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜(ìŠ¤ì¼€ì¤„ë§)  
`pods.spec.nodeSelector` | `Object` | í•´ë‹¹ ë¼ë²¨ì˜ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜(ìŠ¤ì¼€ì¤„ë§)  
`pods.spec.priority` | `Integer` | íŒŒë“œì˜ ìš°ì„ ìˆœìœ„ ì§€ì •, í´ìˆ˜ë¡ ë†’ìŒ  
`pods.spec.restartPolicy` | `String` | ì¬ì‹œì‘ ì •ì±…(`Always`, `OnFailure`, `Never`), ê¸°ë³¸ê°’ì€ `Always`  
`pods.spec.volumes` | `Volume[]` |  íŒŒë“œì˜ ë§ˆìš´íŠ¸í•  ë³¼ë¥¨ ì§€ì •  

### pods.spec.containers

íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì†ì„±ì˜ `containers` ì— ë“¤ì–´ê°€ëŠ” ê°ì²´ ë°°ì—´ `Container` ì— ì–´ë–¤ ì†ì„±ì´ ìˆëŠ”ì§€ ì•Œì•„ë³´ì.  

|**í•„ë“œ**|**íƒ€ì…**|**ì„¤ëª…**|
|---|---|---|
`pods.spec.containers.args` | `String[]` | ì»¨í…Œì´ë„ˆì— ì†¡ì‹ í•  ì¸ìˆ˜  
`pods.spec.containers.env` | `EnvVar[]` | ì»¨í…Œì´ë„ˆì— ì„¤ì •í•œ í™˜ê²½ë³€ìˆ˜  
`pods.spec.containers.image` | `String` | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì™€ í•´ë‹¹ ê²½ë¡œ  
`pods.spec.containers.imagePullPolicy` | `String` | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ë“ì‹œ ê·œì¹™(`Always`, `ifNotPresent`, `Never`). ê¸°ë³¸ê°’ì€ `pods.spec.containers.ifNotPresent` ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìƒˆë¡œ ì·¨ë“í•˜ì§€ ì•ŠëŠ”ë‹¤. `Always` ì„¤ì •ì‹œ í•­ìƒ ì´ë¯¸ì§€ ê°±ì‹   
`pods.spec.containers.name` | `String` | ì»¨í…Œì´ë„ˆ ì´ë¦„, ì»¨í…Œì´ë„ˆ ë‚´ë¶€ê°„ì— í†µì‹ í• ë•Œ ì‚¬ìš©(`DNS_LABEL`)  
`pods.spec.containers.ports` | `ContainerPort` ë°°ì—´ | ì»¨í…Œì´ë„ˆ ê³µê°œíŒŒë“œ  
`pods.spec.containers.resources` | `ResourceRequirements` | ì»¨í…Œì´ë„ˆì— CPU, Memory ê°™ì€ ë¦¬ì†ŒìŠ¤ í• ë‹¹  
`pods.spec.containers.volumeMounts` | `VolumeMount` ë°°ì—´ | ì»¨í…Œì´ë„ˆ ë§ˆìš´íŠ¸ ë³¼ë¥¨ ì§€ì •  
`pods.spec.containers.workingDir` | `String` | ì‘ì—… ë””ë ‰í† ë¦¬  
`pods.spec.containers.livenessProbe` | `Probe` | ì»¨í…Œì´ë„ˆ ê°ì‹œ  
`pods.spec.containers.readlinessProbe` | `Probe` | ì»¨í…Œì´ë„ˆ ê°ì‹œ  

### pods.spec.initContainers

ì´ˆê¸°í™” ì»¨í…Œì´ë„ˆ

ì•± ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ê¸° ì „ íŒŒë“œë¥¼ ì´ˆê¸°í™”, 

```yml
apiVersion: v1
kind: Pod
metadata:
  name: kubernetes-simple-pod
  labels:
    app: kubernetes-simple-pod
spec:
  initContainers:
  - name: init-myservice
    image: arisu1000/simple-container-app:latest
    command: ['sh', '-c', 'sleep 2; echo helloworld01;']
  - name: init-mydb
    image: arisu1000/simple-container-app:latest
    command: ['sh', '-c', 'sleep 2; echo helloworld02;']
  containers:
  - name: kubernetes-simple-pod
    image: arisu1000/simple-container-app:latest
    command: ['sh', '-c', 'echo The app is running! && sleep 3600']
```

### pods.spec.containers.livenessProbe  

íŒŒë“œê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€, íŒŒë“œ ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤ê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ ê°ì‹œ í•˜ê¸° ìœ„í•´  
ë©”ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ `livenessProbe` ì†ì„±ì„ ì¶”ê°€í•œë‹¤.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness-test-pod
  name: liveness-http

spec:
  containers:
  - name: liveness-test-pod
    image: k8s.gcr.io/liveness
    args:
    - /server
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
        httpHeaders:
        - name: X-Custom-Header
          value: Awesome
      initialDelaySeconds: 10
      periodSeconds: 5
```

`livenessProbe` ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì— `/healthz` URI ì— 5ì´ˆì£¼ê¸°(`periodSeconds`)ë¡œ ìš”ì²­ì„ ë‚ ë¦¬ê³  `200` ~ `400` ì‚¬ì´ì˜ ê°’ì´ ë°˜í™˜ë  ê²½ìš° ì •ìƒìœ¼ë¡œ ê°„ì£¼í•œë‹¤.  
ê·¸ ì´ì™¸ì˜ ê°’ì´ ë°˜í™˜ë  ê²½ìš° `kublet` ì— ì˜í•´ ì»¨í…Œì´ë„ˆê°€ ì¬ì‹œì‘ ëœë‹¤.  

ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œ ê¹Œì§€ì˜ í…€(`initialDelaySeconds`)ì„ 10ì´ˆë¡œ ì„¤ì •í•œë‹¤.

`k8s.gcr.io/liveness` ì´ë¯¸ì§€ì—ëŠ” 10ì´ˆë™ì•ˆë§Œ `status code 200` ì„ ë°˜í™˜í•˜ê³  ê·¸ ì´í›„ë¡œëŠ” `status code 500`ì„ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •ë˜ì–´ìˆë‹¤.  

10ì´ˆ í›„ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´  

```
kubectl get pods --output wide
kubectl describe pod liveness-http
```

`CrashLoopBackOff` ìƒíƒœê°’ê³¼ ë¡œê·¸ì— `Liveness probe failed: HTTP probe failed with statuscode: 500` ê°€ ì°í˜€ìˆëŠ”ê±¸ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.  

> http ë¥¼ í†µí•œ íŒŒë“œ ìƒíƒœí™•ì¸ ì™¸ì—ë„ tcpì†Œì¼“, ëª…ë ¹ ì‹¤í–‰ ë“±ì„ í†µí•´ì„œë„ ìƒíƒœí™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.  
> <https://kubernetes.io/ko/docs/concepts/workloads/pods/pod-lifecycle/#ì»¨í…Œì´ë„ˆ-í”„ë¡œë¸Œ-probe>

### pods.spec.containers.readinessProbe

ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ëœ í›„ ì‹¤ì œ ì„œë¹„ìŠ¤ ìš”ì²­ì— ì‘ë‹µí•  ìˆ˜ ìˆì„ì§€ ì„¤ì •.  

ìë°” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì²˜ëŸ¼ ì‹¤í–‰í•˜ëŠ”ë° ì‹œê°„ì´ ê±¸ë¦´ ê²½ìš° ìœ ìš©í•¨.  

## íŒŒë“œ CRUD

ë¨¼ì € ê°„ë‹¨í•œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  `private registry` ì— ë“±ë¡  

```
docker build -t photo-view:v2.0 .
docker image tag photo-view:v2.0 mydomain:5000/photo-view:v2.0

docker images
REPOSITORY                        TAG                 IMAGE ID            CREATED              SIZE
mydomain:5000/photo-view   v2.0                05e6c8ef4559        About a minute ago   924MB
photo-view                        v2.0                05e6c8ef4559        About a minute ago   924MB

docker image push mydomain:5000/photo-view:v2.0
```

> <https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/>

í•´ë‹¹ `private registry` ë¥¼ `kubectl` ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `secret` ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ ìƒì„±  

`docker login` ì„ í†µí•´ `$HOME/.docker/config.json` íŒŒì¼ì— ì¸ì¦ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ í›„ í•´ë‹¹ íŒŒì¼ë¡œ `secret` ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ì.  

```
kubectl create secret generic regcred \
--from-file=.dockerconfigjson=$HOME/.docker/config.json \
--type=kubernetes.io/dockerconfigjson
```

ë§¥ì˜ ê²½ìš° key ì •ë³´ê°€ `config.json` ì— ì €ì¥ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ ë³„ë„ì˜ í‚¤ì²´ì¸ì— ì €ì¥ë˜ì–´ ìˆì–´ ìœ„ì˜ ëª…ë ¹ì„ ì‚¬ìš©í•´ë´¤ì auth faild ì˜¤ë¥˜ê°€ ë°œìƒí• ê²ƒì´ë‹¤.  
ë§¥ì˜ ê²½ìš° ë°”ë¡œ `kubectl` ì— `secret` ìƒì„±í•˜ëŠ” ì•„ë˜ì˜ ëª…ë ¹ ì‚¬ìš©  

```
kubectl create secret docker-registry regcred \
--docker-server=mydomain:5000 \
--docker-username=admin \
--docker-password=admin
```

> `--namespace=''` ì˜µì…˜ì„ ìƒëµí–ˆê¸°ì— ê¸°ë³¸ì ìœ¼ë¡œ default ì— ì ìš©ëœë‹¤.  

í•´ë‹¹ ì´ë¯¸ì§€ë¡œ íŒŒë“œ create

```yaml
# pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: photoview-pod
  labels:
    app: photo-view
    env: stage
spec:
  containers:
  - image: mydomain:5000/photo-view:v2.0
    name: photoview-container
    ports:
    - containerPort: 80
  imagePullSecrets:
    - name: regcred # ìƒì„±í•œ secret name ì„¤ì • 
```

```
kubectl apply -f Pod/pod.yaml
pod/photoview-pod created

kubectl get pods --show-labels
NAME            READY   STATUS    RESTARTS   AGE     LABELS
photoview-pod   1/1     Running   0          2m13s   app=photo-view,env=stage

kubectl describe pods photoview-pod
// ìƒì„¸ì •ë³´ í™•ì¸ ê°€ëŠ¥
```

í•­ìƒ `imagePullSecrets`ë¥¼ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì— ì ìš©í•´ì•¼ë§Œ ë‹¤ìš´ì´ ê°€ëŠ¥í•œë° ì´ë¥¼ `service account` ì— í¬í•¨í•˜ì—¬ ìƒëµí•  ìˆ˜ ìˆë‹¤.  

```
kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "regcred"}]}'
```

ìƒˆë¡œìš´ ì´ë¯¸ì§€ `photo-view:v1.0` ì„ ë¹Œë“œ, íƒœê·¸, `private-registry` ì— `push`

```
docker build -t photo-view:v1.0 .
docker image tag photo-view:v1.0 mydomain:5000/photo-view:v1.0
docker image push mydomain:5000/photo-view:v1.0
```

ìœ„ì— ìƒì„±í•œ `photoview-pod`ì˜ ì´ë¯¸ì§€ë¥¼ `photo-view:v1.0` ë¡œ ë³€ê²½í•´ë³´ì.  

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì˜ `image` ì†ì„±ì„ ë³€ê²½  

```yaml
# pod.yaml
apiVersion: v1
kind: Pod
...
spec:
  containers:
  - image: mydomain:5000/photo-view:v1.0
  ...
...
```

```
kubectl apply -f Pod/pod.yaml
pod/photoview-pod configured
```

`apply` ëª…ë ¹ìœ¼ë¡œ ìƒì„±/ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë‹¤.  

íŒŒë“œ ì‚­ì œ  

```
kubectl delete -f Pod/pod.yaml
```

## íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ êµ¬ì¡°  


ìŠ¤ì¼€ì¤„ë§ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ ë§ˆìŠ¤í„° ì„œë²„ `API Server` ì—ì„œ ê´€ë¦¬í•œë‹¤.  
íŒŒë“œê°€ ë§ˆìŠ¤í„° ì„œë²„ì— ì˜í•´ ì–´ë–¤ ë…¸ë“œì— ì „ê°œ(ìŠ¤ì¼€ì¤„ë§)ë ì§€ ì•Œì•„ë³´ì.  

`API Server`ëŠ” í´ëŸ¬ìŠ¤í„° ì•ˆì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬(`CRUD`), etcd ì— ì ‘ê·¼ì§€ì› í•˜ê¸° ìœ„í•´ `Restfule` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§€ì›í•œë‹¤.  

íŒŒë“œê°€ ìƒì„±ë˜ëŠ” ë£¨í‹´ì€ ëŒ€ëµì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ë‹¤.  

1. `kubectl` ëª…ë ¹ ì‹¤í–‰ - `API Server` ì˜ `RestAPI` ìš”ì²­.  
2. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ì •ë³´ ê°±ì‹  - `kubectl` ë¡œ ì¸í•´ ë³€ê²½ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‚´ìš©ì„ `etcd` ì— ì €ì¥.  
3. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë³€ê²½ - ì ¼ë‹¬ë°›ì€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì™€ `etcd`ì˜ ë°ì´í„°ê°„ ë³€í™”ê°€ ìˆë‹¤ë©´ `API Server`ì—ê²Œ í†µì§€.  
4. íŒŒë“œì˜ ì‘ì„±  - `API Server`ê°€ í†µì§€ë°›ì€ ë‚´ìš©ì´ ìˆë‹¤ë©´ ì›Œì»¤ë…¸ë“œì— íŒŒë“œ ì—…ë°ì´íŠ¸ í•˜ë„ë¡ ëª…ë ¹ ì†¡ì‹ , ë…¸ë“œë‚´ì˜ `kubelet` ì€ ì „ë‹¬ë°›ì€ ëª…ë ¹ì„ ìˆ˜í–‰í•œë‹¤(ìƒˆë¡œìš´ íŒŒë“œ ìƒì„±).  


3ë²ˆê³¼ 4ë²ˆ ê³¼ì • ì‚¬ì´ì—ì„œ íŒŒë“œë¥¼ ì–´ë–¤ ë…¸ë“œì— ìŠ¤ì¼€ì¤„ë§í• ì§€ ê²°ì •í•œë‹¤.  

ìŠ¤ì¼€ì¤„ë§ì€ ì•„ë˜ 2ê°€ì§€ ê·œì¹™ì— ì˜í•´ ê²°ì •ëœë‹¤. 

1. ë…¸ë“œì˜ í•„í„°ë§   
   - íŒŒë“œì— `NodeSelector` ë¥¼ ì„¤ì •í•˜ê³  ìˆëŠ”ì§€ ê²€ì‚¬  
   - íŒŒë“œì— ì„¤ì •ëœ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì— ë§¤ì¹­ë˜ëŠ” ë…¸ë“œ í•„í„°ë§  
2. ë…¸ë“œì˜ ìš°ì„ ìˆœìœ„  
   - CPU, Memory ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë…¸ë“œì˜ ìš°ì„ ìˆœìœ„ ê²°ì •
   - ìš°ì„ ìˆœìœ„ë³„ë¡œ íŒŒë“œë¥¼ ë°°ì¹˜  

<!-- 
## Minikube ì—ì„œ ë…¸ë“œ ìƒì„±  

íŒŒë“œì™€ ë°˜ëŒ€ë¡œ ë…¸ë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ë‚´ì—ì„œ íƒ‘-ë ˆë²¨ ë¦¬ì†ŒìŠ¤ (ë¬¼ë¦¬/ê°€ìƒ ì»´í“¨í„° í•œëŒ€) ì´ë‹¤.

í˜„ì¬ ìƒì„±ëœ ë…¸ë“œ í™•ì¸  

```
kubectl get nodes
NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   8d    v1.18.0

kubectl describe node  minikube
Name:               minikube
Roles:              master
...
...
```

`minikube` ë¥¼ í†µí•´ ìƒˆë¡œìš´ ê°€ìƒì˜ ë…¸ë“œ ì¶”ê°€  

```
minikube node help
ğŸ’¡  Usage: minikube node [add|start|stop|delete]

minikube node add
ğŸ˜„  ë…¸ë“œ m02 ë¥¼ í´ëŸ¬ìŠ¤í„° minikube ì— ì¶”ê°€í•©ë‹ˆë‹¤
ğŸ‘  Starting node m02 in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ¤·  docker "minikube" container is missing, will recreate.
ğŸ”¥  docker container (CPUs=2, Memory=1989MB, Disk=<no value>MB) ì— ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì„¤ì¹˜í•˜ëŠ” ì¤‘ ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.18.0 ì„ Docker 19.03.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ„  m02 ë¥¼ minikube ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤!

minikube node add
ğŸ˜„  ë…¸ë“œ m03 ë¥¼ í´ëŸ¬ìŠ¤í„° minikube ì— ì¶”ê°€í•©ë‹ˆë‹¤
ğŸ‘  Starting node m03 in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ”¥  docker container (CPUs=2, Memory=1989MB, Disk=<no value>MB) ì— ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì„¤ì¹˜í•˜ëŠ” ì¤‘ ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.18.0 ì„ Docker 19.03.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ„  m03 ë¥¼ minikube ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤!

docker ps
CONTAINER ID        IMAGE                                COMMAND                  CREATED             STATUS              PORTS                                                                           NAMES
c9e042c9462e        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   4 minutes ago       Up 4 minutes        127.0.0.1:32785->22/tcp, 127.0.0.1:32784->2376/tcp, 127.0.0.1:32783->8443/tcp   minikube
01a38df1ed4a        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   14 hours ago        Up 2 minutes        127.0.0.1:32791->22/tcp, 127.0.0.1:32790->2376/tcp, 127.0.0.1:32789->8443/tcp   minikube-m03
daaacf0b2652        gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entrâ€¦"   14 hours ago        Up 3 minutes        127.0.0.1:32788->22/tcp, 127.0.0.1:32787->2376/tcp, 127.0.0.1:32786->8443/tcp   minikube-m02

kubectl get nodes --show-labels
NAME           STATUS   ROLES    AGE     VERSION   LABELS
minikube       Ready    master   5m47s   v1.18.0   beta....
minikube-m02   Ready    <none>   4m35s   v1.18.0   beta....
minikube-m03   Ready    <none>   2m56s   v1.18.0   beta....
```

> í˜¹ì‹œ ë…¸ë“œ ì„¤ì¹˜ê°„ ë¬¸ì œê°€ ìƒê²¼ë‹¤ë©´  
`minikube logs` ë¡œ í™•ì¸ í›„ ì—ëŸ¬ í™•ì¸    
https://stackoverflow.com/questions/56966721/minikube-failed-to-start-node-minikube-not-found  
`minikube stop && minikube delete`

ì´ë¯¸ ìˆ˜ë§ì€ `label` ì´ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ `minikube-m02` ë…¸ë“œì— `server=webap` ë¼ë²¨ì„ ì¶”ê°€í•œë‹¤.  

```
kubectl label node minikube-m02 server=webap
node/minikube-m02 labeled

kubectl get nodes --show-labels
NAME           STATUS   ROLES    AGE     VERSION   LABELS
minikube       Ready    master   5m47s   v1.18.0   beta....
minikube-m02   Ready    <none>   4m35s   v1.18.0   beta....,server=webap
minikube-m03   Ready    <none>   2m56s   v1.18.0   beta....
```

`minikube-m02`ë…¸ë“œì— ë¼ë²¨ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸ í›„  
`nodeSelector`ì†ì„±ì— ìœ„ì—ì„œ ì§€ì •í•œ `label` ì„ ì ìš©í•´ íŒŒë“œê°€ í•´ë‹¹ ë…¸ë“œì— ë§Œë“¤ì–´ì§€ë„ë¡ ì„¤ì •  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: stage
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    server: webap
```

ìƒì„±ëœ íŒŒë“œì˜ ë…¸ë“œê°€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì— ì„¤ì •í•œëŒ€ë¡œ `minikube-m02`ì— ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸.  

```
kubectl create -f Pod/labels-node.yaml
pod/nginx created

kubectl get pod --output=wide
NAME    READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
nginx   1/1     Running   0          23s   172.18.0.2   minikube-m02   <none>           <none>
```

> `kubectl creat/apply` ì°¨ì´: https://intellipaat.com/community/468/difference-between-kubectl-apply-and-kubectl-create  
 -->

## íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ ì œì–´  

ìœ„ì˜ `nodeSelector` ì†ì„±ì„ ì •ì˜í•´ ëª…ì‹œì ìœ¼ë¡œ ë…¸ë“œë¥¼ ì •í•´ì£¼ì§€ ì•Šê³ ë„ ìŠ¤ì¼€ì¤„ë§í•  ìˆ˜ìˆëŠ” ë°©ë²•ì´ ì—¬ëŸ¿ ìˆë‹¤.  

### Affinity

> https://kubernetes.io/ko/docs/concepts/configuration/assign-pod-node/#ì–´í”¼ë‹ˆí‹°-affinity-ì™€-ì•ˆí‹°-ì–´í”¼ë‹ˆí‹°-anti-affinity

`Affinity` ëŠ” ì¹œë°€ê°ì´ë€ ëœ»ìœ¼ë¡œ ì„œë¡œë‹¤ë¥¸ 2ê°œì˜ íŒŒë“œë¥¼ ì™ ë§Œí•˜ë©´ ê°™ì€ë…¸ë“œì— ë°°ì¹˜ì‹œí‚¤ê³  ì‹¶ì„ë•Œ(`podAffinity`)  
í˜¹ì€ ë‹¤ë¥¸ë…¸ë“œì— ë°°ì¹˜ì‹œí‚¤ê³  ì‹¶ì„ë•Œ(`podAntiAffinity`) ì‚¬ìš©í•œë‹¤.  

ë˜í•œ íŠ¹ì • ì¡°ê±´ì„ ê°–ì¶˜ ë…¸ë“œì—ì„œë§Œ ë™ì‘í•˜ë„ë¡ í•˜ëŠ” `nodeAffinity` ë„ ìˆë‹¤.  


### Taints, Tolerations

> https://kubernetes.io/ko/docs/concepts/configuration/taint-and-toleration/

> Taints: ì˜¤ì—¼ì‹œí‚¤ë‹¤
> Tolerations: ìš©ì¸,ê´€ìš©

ì„œë¡œ ìƒë°˜ë˜ëŠ” ì—­í• ì„ í•˜ëŠ” ëª…ë ¹  

`Taints`ëŠ” ë…¸ë“œì— ì„¤ì •í•˜ëŠ” ê²ƒìœ¼ë¡œ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¤„ë§ í•˜ê±°ë‚˜ ì¡°ê±´ì— ë§ëŠ” íŒŒë“œë§Œ ìŠ¤ì¼€ì¤„ë§ í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.  
`Taints`ê°€ ì„¤ì •ëœ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜í•˜ê³  ì‹¶ë‹¤ë©´ `Tolerations` ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.  

## íŒŒë“œ ë¦¬ì†ŒìŠ¤ ì„¤ì •  

`CPU`, `Memory` ë¦¬ì†ŒìŠ¤ëŠ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ì„¤ì • ê°€ëŠ¥í•˜ë‹¤.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: requests-pod

spec:
  containers:
  - image: busybox
    command: ["dd", "if=/dev/zero", "of=/dev/null"]
    name: main
    resources:
      requests:
        cpu: 50m
        memory: 300Mi # (K M G T P), (Ki Mi Gi Ti Pi) ì‚¬ìš© ê°€ëŠ¥
```

`Minikube` ì—ì„œ ìƒì„±ëœ `node` ì˜ `CPU Limits` ëŠ” `100m`, `Memory Limits`ëŠ” `390Mi`ë‚¨ì•„ìˆë‹¤.
ìœ„ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì„¤ì •ëŒ€ë¡œ íŒŒë“œë¥¼ ìƒì„±í•˜ê³  ì¤„ì–´ë“œëŠ” `Limits` ë¥¼ í™•ì¸  

`requests` ì†ì„±ì„ íŒŒë“œì˜ ìµœì†Œ ë¦¬ì†ŒìŠ¤ ìš”ì²­ ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.  

```
kubectl create -f Pod/pod-request.yaml
pod/requests-pod created 

kubectl get pods --output wide
NAME           READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
requests-pod   1/1     Running   0          39s   172.18.0.2   minikube-m03   <none>           <none>
```

`kubectl describe node minikube-m03` ëª…ë ¹ìœ¼ë¡œ ë‚¨ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•´ë³´ë©´ ì •í™•ì¸ `CPU 50m`, `Memory 300Mi` ë§Œí¼ `Limits` ê°€ ì¤„ì–´ìˆë‹¤.   

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ íŒŒë“œë¥¼ ìŠ¤ì¼€ì¤„ë§í• ë•Œ ì‹¤ì œ ë…¸ë“œì˜ ë¦¬ì†ŒìŠ¤ì‚¬ìš©ëŸ‰ì´ ì•„ë‹Œ ë©”ë‹ˆí˜ìŠ¤íŠ¸ì— ì„¤ì •ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì •ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ ë¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.  
íŒŒë“œì— ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í• ë‹¹í•˜ê²Œ ë˜ë©´ ê·¸ë§Œí¼ ë‹¤ë¥¸ íŒŒë“œë¥¼ ë…¸ë“œì— ì„¤ì •í•  ìˆ˜ ì—†ë‹¤.

ë§Œì•½ íŒŒë“œì— ì„¤ì •í•œ `resources` ì‚¬ìš©ëŸ‰ì„ ë„˜ê²Œë˜ë©´ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.  

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: limits-pod
spec:
  containers:
  - name: main
    image: polinux/stress
    resources:
      limits:
        cpu: 90m
        memory: 300Mi
    command: ["stress"]
    args: ["--vm", "1", "--vm-bytes", "500M", "--vm-hang", "1"]
```

`stress` í”„ë¡œê·¸ë¨ìœ¼ë¡œ `Memory`ì— `300M`ë¥¼ ë„˜ëŠ” `500M` ë¥¼ ì„¤ì •í•˜ì—¬ ì‹¤í–‰  

`limits` ì†ì„±ì€ íŒŒë“œ ìš”ì²­ ì œí•œ ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.  

```
kubectl get pods --output wide
NAME         READY   STATUS              RESTARTS   AGE   IP       NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     ContainerCreating   0          6s    <none>   minikube-m03   <none>           <none>

kubectl get pods --output wide
NAME         READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   1/1     Running   0          9s    172.18.0.2   minikube-m03   <none>           <none>

kubectl get pods --output wide
NAME         READY   STATUS      RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     OOMKilled   0          9s    172.18.0.2   minikube-m03   <none>           <none>

kubectl get pods --output wide
NAME         READY   STATUS             RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     CrashLoopBackOff   2          43s   172.18.0.2   minikube-m03   <none>           <none>
```

```
kubectl describe pod limits-pod
# ìƒì„¸ ë¡œê·¸ í™•ì¸.  
```


ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„  ë³µêµ¬ê¸°ëŠ¥ì„ ê°–ê³  ìˆê¸°ì— ì˜¤ë¥˜ê°€ ê°ì§€ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì‹œì‘í•œë‹¤.  
`restartPolicy`ì†ì„± ì— ë”°ë¼ ì˜µì…˜ì´ ë‹¤ë¥´ë©° ê¸°ë³¸ê°’ì€ `Always` ì´ë‹¤.  

```
kubectl get pods --output wide
NAME         READY   STATUS             RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
limits-pod   0/1     CrashLoopBackOff   6          7m15s   172.18.0.2   minikube-m03   <none>           <none>
```

ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ `RESTARTS` íšŸìˆ˜ê°€ ê³„ì† ëŠ˜ì–´ë‚˜ê³  ìˆë‹¤.  

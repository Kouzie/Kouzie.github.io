---
title:  "쿠버네티스 - 서비스, 인그레스!"

read_time: false
share: false
author_profile: false
toc: true
toc_sticky: true
# classes: wide

categories:
  - kubernetes

---

# 권환 관리

클러스터를 


## ABAC(Attribute-based access control) RBAC(Role-based access control)

`ABAC` 는 속성 기반 관리, 권한 설정 내용을 파일로 관리하고 수정시  `kube-apiserver` 컴포넌트를 재시작해야 해서 잘 사용하지 않음

`RBAC` 를 주로 사용함. **사용자(ServiceAccount)** 와 **역할(Role)** 을 별개의 리소스로 생성한 후 두 가지를 **조합(RoleBinding)**

### 역할(Role)

`Role` 는 일반 `Role`, `ClusterRole` 2 가지 `kind` 의 리소스가 존재한다.  

```yaml
kind: Role
apiVersion: rbac.authorization.k8s.io/v1 # RBAC
metadata:
  # namespace: default # 생략 가능
  name: read-role # 룰 이름
rules: # 룰 규칙
- apiGroups: [""]  # core API 설정, 미설정시 기본 apiVersion: v1 사용
  # resourceNames: ["mypod"] # 접근 가능한 리소스의 name 설정
  resources: ["pods"] # 접근 가능한 리소스 정의
  verbs: ["get", "list"] # 리소스에서 어떤 동작을 할 건지 정의 
```

### 클러스터 역할(Cluster Role)

```yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-clusterrole
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
```

`ClusterRole`은 특정 네임스페이스가 아닌 클러스터 전체 사용 권한을 관리한다.  

|verb|설명|
|---|---|
`Create` | 새로운 자원 생성
`Get` | 개별자원조회
`List` | 여러개자원조회
`Update` | 기존자원내용전체업데이트
`Patch` | 기존자원중일부내용변경
`Delete` | 개별자원삭제
`deletecollection` | 여러개자원삭제

### 룰 바인딩(RoleBinding)

작성한 일반 룰 과 사용자를 묶기 위해 사용

```yaml
apiVersion: v1
kind: ServiceAccount
metadata: 
  name: myuser
  namespace: default
```

먼저 사용자(`ServiceAccount`) 생성, 


```yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-rolebinding
  namespace: default
subjects:
- kind: ServiceAccount
  name: myuser
  apiGroup: "" 
roleRef:
  kind: Role
  name: read-role
  apiGroup: rbac.authorization.k8s.io # RBAC 룰 사용
```

`subjects` 에 작성한 `ServiceAccount` 적용  
`roleRef` 에 작성한 `Role` 적용  

### 클러스터룰 바인딩(ClusterRoleBinding)

작성한 ClusterRole 과 사용자를 묶기위해 사용 

```yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-clusterrolebinding
subjects:
- kind: ServiceAccount
  name: myuser
  namespace: default
  apiGroup: ""
roleRef:
  kind: ClusterRole
  name: read-clusterrole
  apiGroup: rbac.authorization.k8s.io
```

클러스터룰 바인딩에선 subjects(사용자) 설정에는 `namespace` 를 추가해야 하고
roleRef(클러스터룰) 설정에는 `namespace` 가 없다.

## 사용자 변경

룰, 사용자, 룰바인딩 설정

> `deploy` 와 같은 클러스터 단위의 명령어를 사용하려면 `ClusterRole` 을 사용해야 한다.  

```yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1 # RBAC
metadata:
  name: spring-role # 룰 이름
rules: # 룰 규칙
  - apiGroups: [""]  # core API 설정, 미설정시 기본 apiVersion: v1 사용
    resources: ["*"] # 접근 가능한 리소스 정의
    verbs: ["*"] # 리소스에서 어떤 동작을 할 건지 정의
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: spring-user
  namespace: spring
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: spring-rolebinding
  namespace: spring
subjects:
  - kind: ServiceAccount
    name: spring-user
    namespace: spring
    apiGroup: ""
roleRef:
  kind: ClusterRole
  name: spring-role
  apiGroup: rbac.authorization.k8s.io # RBAC 룰 사용
```

유저 생성에 따라 자동으로 만들어진 `secret` 확인

```
$ kubectl get secret -n spring 
NAME                                TYPE                                  DATA   AGE
default-token-rplrs                 kubernetes.io/service-account-token   3      96m
spring-user-token-d4fjj   kubernetes.io/service-account-token   3      3m19s

$ kubectl describe secrets -n spring spring-user-token-d4fjj 
...
token:      eyJhbGciOiJSUzI1NiIsIm...
```

만들어진 secret 을 로컬 `context` 에 저장하고 `사용자명-클러스터명` 를 묶어 저장.

```
$ kubectl config set-credentials -n spring spring-user --token=eyJhbGciOiJ...
$ kubectl config set-context spring-context --cluster=cluster.dev --user=spring-user
```

사용하고자 하는 `private registry` 를 등록하기 위한 코드

```
$ kubectl patch -n spring serviceaccount spring-user -p '{"imagePullSecrets": [{"name": "docker-secret"}]}'
serviceaccount/spring-user patched
```

만들어진 `context` 로 현재 `context` 를 변경

```
$ kubectl config use-context spring-context 
Switched to context "spring-context".

$ kubectl config current-context                     
spring-context
```

현재 `context` 가 사용중인 `namespace` 를 `default` 에서 다른 `namespace` 로 지정

```
$ kubectl config set-context spring-context --namespace=spring
Context "spring-context" modified.

$ kubectl config get-contexts $(kubectl config current-context)
CURRENT   NAME                       CLUSTER       AUTHINFO                NAMESPACE
*         spring-context   cluster.dev   spring-user   spring
```

